<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‰¹é‡ä¸‹è½½æ–‡ä»¶</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        min-height: 100vh;
      }
      .container {
        background-color: white;
        padding: 20px;
        margin: 0;
        min-height: 100vh;
        box-sizing: border-box;
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-row {
        display: flex;
        gap: 20px;
        align-items: flex-end;
        flex-wrap: wrap;
      }
      .form-row .form-group {
        flex: 1;
        min-width: 200px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      input[type="text"],
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      textarea {
        height: 120px;
        resize: vertical;
      }
      .button-group {
        text-align: center;
        margin-top: 30px;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 0 5px;
        min-width: 120px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      /* è¿›åº¦æ¡Dialogæ ·å¼ */
      .progress-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      /* æ ·å¼è®¾ç½®Dialogæ ·å¼ */
      .style-settings-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10001;
      }

      .progress-dialog-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        width: 450px;
        max-width: 90vw;
        animation: dialogSlideIn 0.3s ease;
      }

      .style-settings-dialog-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        width: 900px;
        max-width: 95vw;
        max-height: 80vh;
        overflow-y: auto;
        animation: dialogSlideIn 0.3s ease;
      }

      @keyframes dialogSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .progress-dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e0e0e0;
      }

      .progress-dialog-header h3 {
        margin: 0;
        color: #333;
        font-size: 18px;
        font-weight: 600;
      }

      .progress-dialog-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .progress-dialog-close:hover {
        background-color: #f5f5f5;
        color: #333;
      }

      .progress-dialog-body {
        padding: 24px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        margin-bottom: 16px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #45a049);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 4px;
      }

      #progressText {
        text-align: center;
        font-weight: 600;
        color: #333;
        font-size: 16px;
        margin-bottom: 8px;
      }

      .progress-details {
        text-align: center;
        color: #666;
        font-size: 14px;
      }

      /* å¼‚å¸¸å‡ºè´¦æ—¥æ ·å¼ */
      .abnormal-bill-date {
        background-color: #ffebee !important;
        color: #c62828 !important;
        font-weight: bold;
      }

      /* å¼‚å¸¸å‡ºè´¦æ—¥æœŸæ ¼å­æ ·å¼ */
      .abnormal-bill-date-cell {
        background-color: #ffebee !important;
        color: #c62828 !important;
        font-weight: bold;
      }

      /* æœªæŸ¥åˆ°è´¦å•çš„æ•´è¡Œæ ·å¼ */
      .no-bill-found-row {
        background-color: #fff3cd !important;
      }

      .no-bill-found-row td {
        background-color: #fff3cd !important;
        color: #856404 !important;
        font-weight: 500;
      }

      /* è¡¨æ ¼å†…æŒ‰é’®æ ·å¼ä¼˜åŒ– */
      .table-btn {
        min-width: 50px;
        height: 28px;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 500;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-right: 4px;
        color: white;
        text-align: center;
        line-height: 1.2;
      }

      .table-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .table-btn:active {
        transform: translateY(0);
      }

      .table-btn.download {
        background-color: #28a745;
        min-width: 45px;
      }

      .table-btn.download:hover {
        background-color: #218838;
      }

      .table-btn.query {
        background-color: #17a2b8;
        min-width: 45px;
      }

      .table-btn.query:hover {
        background-color: #138496;
      }

      .table-btn.edit {
        background-color: #ffc107;
        color: #212529;
        min-width: 45px;
      }

      .table-btn.edit:hover {
        background-color: #e0a800;
      }

      .table-btn.delete {
        background-color: #dc3545;
        min-width: 45px;
      }

      .table-btn.delete:hover {
        background-color: #c82333;
      }

      .table-btn.detail {
        background-color: #6f42c1;
        min-width: 45px;
      }

      .table-btn.detail:hover {
        background-color: #5a32a3;
      }

      .table-btn.disabled {
        background-color: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.6;
      }

      .table-btn.disabled:hover {
        background-color: #6c757d !important;
        transform: none !important;
        box-shadow: none !important;
      }

      /* ç³»ç»Ÿåˆ—æ ·å¼ */
      .system-name {
        font-size: 12px;
        color: #666;
        background-color: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        text-align: center;
        font-weight: 500;
      }

      .system-name.system-teyixing {
        background-color: #e3f2fd;
        color: #1976d2;
      }

      .system-name.system-other {
        background-color: #f3e5f5;
        color: #7b1fa2;
      }

      /* æ–‡ä»¶ååˆ—æ ·å¼ */
      .file-name {
        font-family: "Courier New", monospace;
        font-size: 12px;
        color: #495057;
        background-color: #f8f9fa;
        padding: 4px 6px;
        border-radius: 3px;
        white-space: nowrap;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .log {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        display: block;
      }
      .log-item {
        margin-bottom: 5px;
        padding: 4px 8px;
        border-radius: 3px;
        background-color: rgba(255, 255, 255, 0.5);
        border-left: 3px solid #ddd;
      }
      .log-success {
        color: #28a745;
        border-left-color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
      }
      .log-error {
        color: #dc3545;
        border-left-color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
      }
      .log-info {
        color: #17a2b8;
        border-left-color: #17a2b8;
        background-color: rgba(23, 162, 184, 0.1);
      }
      .log-warning {
        color: #ffc107;
        border-left-color: #ffc107;
        background-color: rgba(255, 193, 7, 0.1);
      }
      .customer-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 14px;
      }
      .customer-table th,
      .customer-table td {
        border: 1px solid #ddd;
        padding: 12px 8px;
        text-align: left;
        font-size: 13px;
        white-space: nowrap;
      }
      .customer-table th {
        background-color: #f8f9fa;
        font-weight: bold;
      }
      .customer-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .customer-table tr:hover {
        background-color: #f5f5f5;
      }

      /* Excelå¯¼å…¥åŒºåŸŸæ ·å¼ */
      .import-section {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 15px;
        margin: 20px 0;
      }

      input[type="file"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
      }

      /* çŠ¶æ€æ ·å¼ */
      .status {
        font-weight: bold;
      }

      .customer-table .status {
        text-align: center;
      }

      /* å®¢æˆ·åç§°ç¼–è¾‘æ ·å¼ */
      .customer-name-cell {
        position: relative;
      }

      .customer-name-edit {
        width: 100%;
        padding: 4px;
        border: 1px solid #007bff;
        border-radius: 3px;
        font-size: 13px;
      }

      .edit-btn,
      .delete-btn {
        font-size: 12px;
        padding: 2px 8px;
        margin-right: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }

      .edit-btn {
        background-color: #007bff;
        color: white;
      }

      .delete-btn {
        background-color: #dc3545;
        color: white;
      }

      .edit-btn:hover {
        background-color: #0056b3;
      }

      .delete-btn:hover {
        background-color: #c82333;
      }

      /* ç™»å½•åŒºåŸŸæ ·å¼ */
      .login-section {
        margin-bottom: 20px;
      }

      #loginBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      #loginStatus {
        font-weight: 500;
      }

      /* ç­›é€‰åŠŸèƒ½æ ·å¼ */
      #customerFilter {
        transition: border-color 0.3s ease;
      }

      #customerFilter:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      #filterStatus {
        white-space: nowrap;
      }

      /* æ“ä½œæŒ‰é’®æ ·å¼ */
      .action button {
        border: none;
        border-radius: 3px;
        cursor: pointer;
        color: white;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .action button:hover {
        opacity: 0.8;
        transform: translateY(-1px);
      }

      .action button:active {
        transform: translateY(0);
      }

      /* Toastæç¤ºæ ·å¼ */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10002;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }

      .toast.success {
        background-color: #28a745;
      }

      .toast.error {
        background-color: #dc3545;
      }

      .toast.info {
        background-color: #17a2b8;
      }

      .toast.warning {
        background-color: #ffc107;
        color: #212529;
      }

      /* æ ·å¼è®¾ç½®è¡¨å•æ ·å¼ */
      .style-form-group {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .style-form-group label {
        min-width: 120px;
        margin-bottom: 0;
        font-weight: 500;
        color: #333;
      }

      .style-form-group input,
      .style-form-group select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .style-form-group input:focus,
      .style-form-group select:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .style-checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .style-checkbox-group input[type="checkbox"] {
        margin: 0;
        transform: scale(1.2);
      }

      .style-preview {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin: 15px 0;
      }

      .style-preview h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 14px;
      }

      .style-preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .style-preview-table td {
        border: 1px solid #000;
        padding: 8px;
        text-align: center;
      }

      /* è¡¨æ ¼æŠ˜å åŠŸèƒ½æ ·å¼ */
      .table-content-area {
        transition: all 0.3s ease;
        overflow: hidden;
      }

      .table-content-area.collapsed {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
      }

      .table-content-area.expanded {
        max-height: none;
        opacity: 1;
      }

      .collapse-btn {
        transition: all 0.2s ease;
      }

      .collapse-btn:hover {
        background-color: #5a6268 !important;
        transform: translateY(-1px);
      }

      .collapse-btn.collapsed {
        background-color: #28a745 !important;
      }

      .collapse-btn.collapsed:hover {
        background-color: #218838 !important;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
        }
        .form-row .form-group {
          min-width: auto;
        }
        .customer-table {
          font-size: 11px;
        }
        .customer-table th,
        .customer-table td {
          padding: 6px 4px;
        }
        .style-settings-dialog-content {
          width: 98vw;
          margin: 5px;
        }
        .style-form-group {
          flex-direction: column;
          align-items: flex-start;
        }
        .style-form-group label {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>å®¢æˆ·è´¦å•æŸ¥è¯¢ä¸æ‰¹é‡ä¸‹è½½</h1>
      <p
        style="
          text-align: center;
          color: #666;
          margin-top: -10px;
          font-size: 14px;
        "
      >
        æ”¯æŒExcelæ‰¹é‡å¯¼å…¥å®¢æˆ·ï¼Œé…ç½®å®æ—¶ç”Ÿæ•ˆ
      </p>

      <!-- ç™»å½•åŒºåŸŸ -->
      <div class="login-section" id="loginSection">
        <div
          class="form-row"
          style="
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
          "
        >
          <div class="form-group" style="margin-bottom: 0">
            <button
              onclick="performLogin()"
              id="loginBtn"
              style="background-color: #28a745; min-width: 150px"
            >
              ä¸€é”®ç™»å½•
            </button>
          </div>
          <div class="form-group" style="margin-bottom: 0">
            <span
              id="loginStatus"
              style="
                color: #666;
                font-size: 14px;
                line-height: 38px;
                margin-left: 15px;
              "
            >
              æœªç™»å½•
            </span>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="token">Token:</label>
          <input
            style="width: 350px"
            type="text"
            value="cb9c5482-1aa9-464d-8e68-8f086599c7b9"
            id="token"
            placeholder="è¯·è¾“å…¥è®¿é—®token"
            required
          />
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button
            onclick="loadLocalConfig(true)"
            style="background-color: #28a745"
          >
            æ‰‹åŠ¨åŠ è½½å®¢æˆ·åˆ—è¡¨
          </button>
        </div>
      </div>

      <div
        class="form-row"
        style="border-top: 1px solid #ddd; padding-top: 20px; margin-top: 20px"
      >
        <div class="form-group">
          <label for="excelFile">å¯¼å…¥Excelå®¢æˆ·åˆ—è¡¨:</label>
          <input
            type="file"
            id="excelFile"
            accept=".xlsx,.xls"
            onchange="handleExcelFile()"
          />
          <small style="color: #666; display: block; margin-top: 5px">
            é€‰æ‹©åŒ…å«å®¢æˆ·åç§°çš„Excelæ–‡ä»¶ï¼ˆæ”¯æŒ.xlsx/.xlsæ ¼å¼ï¼‰<br />
            ç³»ç»Ÿä¼šè‡ªåŠ¨å»é™¤"VIPç‰¹æ˜“è¡Œ"ã€"æˆéƒ½ç‰¹æ˜“è¡Œ"ã€"å·®æ—…ç®¡å®¶-VIP"ç­‰å‰ç¼€ï¼Œå¯¼å…¥åç«‹å³ç”Ÿæ•ˆ
            <a
              href="#"
              onclick="downloadTemplate()"
              style="color: #007bff; text-decoration: underline"
              >ä¸‹è½½æ¨¡æ¿</a
            >
          </small>
        </div>

        <div class="form-group">
          <label>&nbsp;</label>
          <button onclick="exportCurrentConfig()">å¯¼å‡ºå½“å‰é…ç½®</button>
        </div>

        <div class="form-group">
          <label for="styleExcelFile">Excelæ ·å¼ä¿®æ”¹:</label>
          <input
            type="file"
            id="styleExcelFile"
            accept=".xlsx,.xls"
            onchange="handleStyleExcelFile()"
          />
          <small style="color: #666; display: block; margin-top: 5px">
            ä¸Šä¼ Excelæ–‡ä»¶ï¼Œè‡ªåŠ¨ä¿®æ”¹æ ·å¼ã€‚æ”¯æŒè‡ªå®šä¹‰å­—å·ã€è¡Œé«˜ã€å­—ä½“ç­‰è®¾ç½®
            <br />
            <button
              onclick="showStyleSettings()"
              style="
                background-color: #17a2b8;
                color: white;
                border: none;
                padding: 2px 8px;
                border-radius: 3px;
                font-size: 12px;
                margin-top: 3px;
              "
            >
              æ ·å¼è®¾ç½®
            </button>
          </small>
        </div>

        <div class="form-group">
          <label for="zipFile">æ‰¹é‡Excelå¤„ç† (ZIPæ–‡ä»¶):</label>
          <input
            type="file"
            id="zipFile"
            accept=".zip"
            onchange="handleZipFile()"
          />
          <small style="color: #666; display: block; margin-top: 5px">
            ä¸Šä¼ åŒ…å«å¤šä¸ªExcelæ–‡ä»¶çš„ZIPå‹ç¼©åŒ…ï¼Œæ‰¹é‡åº”ç”¨æ ·å¼ä¿®æ”¹
            <br />
            <span style="color: #28a745">âœ“ è‡ªåŠ¨å¤„ç†ZIPåŒ…å†…æ‰€æœ‰.xlsxæ–‡ä»¶</span
            ><br />
            <span style="color: #28a745">âœ“ ä¿æŒåŸå§‹æ–‡ä»¶åå’Œç›®å½•ç»“æ„</span><br />
            <span style="color: #28a745">âœ“ å¿½ç•¥éExcelæ–‡ä»¶</span>
          </small>

          <!-- ZIPæ‰¹é‡å¤„ç†è¿›åº¦æ¡ -->
          <div
            id="zipProgressContainer"
            style="display: none; margin-top: 15px"
          >
            <div style="margin-bottom: 8px">
              <span id="zipProgressText" style="font-size: 14px; color: #333"
                >å‡†å¤‡å¤„ç†...</span
              >
              <span
                id="zipProgressPercent"
                style="float: right; font-size: 14px; color: #666"
                >0%</span
              >
            </div>
            <div
              style="
                width: 100%;
                background-color: #f0f0f0;
                border-radius: 4px;
                overflow: hidden;
              "
            >
              <div
                id="zipProgressBar"
                style="
                  width: 0%;
                  height: 20px;
                  background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
                  transition: width 0.3s ease;
                  border-radius: 4px;
                "
              ></div>
            </div>
            <div
              id="zipProgressDetails"
              style="margin-top: 8px; font-size: 12px; color: #666"
            >
              <span id="zipCurrentFile"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group" id="customerResults" style="display: none">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <div style="display: flex; align-items: center; gap: 10px">
            <h3 style="margin: 0" id="resultsTitle">å®¢æˆ·åˆ—è¡¨:</h3>
            <button
              onclick="toggleTableCollapse()"
              id="collapseBtn"
              class="collapse-btn"
              style="
                background-color: #6c757d;
                color: white;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                min-width: 60px;
              "
              title="æŠ˜å /å±•å¼€è¡¨æ ¼åŒºåŸŸ"
            >
              æŠ˜å 
            </button>
          </div>
          <button
            onclick="batchDownloadFromTable()"
            id="batchDownloadBtn"
            style="display: none; width: 0px; height: 0px"
          >
            æ‰“åŒ…ä¸‹è½½æ‰€æœ‰è´¦å•(ZIP)
          </button>
        </div>

        <!-- è¡¨æ ¼å†…å®¹åŒºåŸŸ -->
        <div id="tableContentArea" class="table-content-area expanded">
          <!-- å®¢æˆ·ç­›é€‰åŒºåŸŸ -->
          <div
            id="customerFilterSection"
            style="
              margin-bottom: 15px;
              padding: 10px;
              background-color: #f8f9fa;
              border-radius: 5px;
              display: none;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <div style="display: flex; align-items: center; gap: 10px">
                <label style="font-weight: bold; margin-bottom: 0"
                  >ç­›é€‰æ¡ä»¶:</label
                >
                <select
                  id="filterType"
                  onchange="applyFilter()"
                  style="
                    padding: 6px 8px;
                    border-radius: 4px;
                    border: 1px solid #ddd;
                  "
                >
                  <option value="all">å…¨éƒ¨å®¢æˆ·</option>
                  <option value="downloadable">å¯ä¸‹è½½å®¢æˆ·</option>
                  <option value="no-debt">æ— å¾…è¿˜é‡‘é¢</option>
                  <option value="no-data">æœªæŸ¥åˆ°è´¦å•</option>
                  <option value="failed">æŸ¥è¯¢å¤±è´¥</option>
                  <option value="teyixing">ç‰¹æ˜“è¡Œ</option>
                  <option value="chalvguanjia">å·®æ—…ç®¡å®¶</option>
                </select>
              </div>

              <div
                style="display: flex; align-items: center; gap: 10px; flex: 1"
              >
                <label
                  for="customerFilter"
                  style="font-weight: bold; margin-bottom: 0"
                  >ç­›é€‰å®¢æˆ·:</label
                >
                <input
                  type="text"
                  id="customerFilter"
                  placeholder="è¾“å…¥å®¢æˆ·åç§°è¿›è¡Œç­›é€‰..."
                  style="
                    flex: 1;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                  oninput="filterCustomers()"
                />
                <button
                  onclick="clearFilter()"
                  style="background-color: #6c757d; padding: 8px 12px"
                >
                  æ¸…é™¤
                </button>
              </div>

              <span
                id="filterStatus"
                style="color: #666; font-size: 14px"
              ></span>
            </div>
          </div>

          <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
          <div
            id="actionButtonsSection"
            style="
              margin-bottom: 15px;
              padding: 10px;
              background-color: #f8f9fa;
              border-radius: 5px;
              display: none;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button
                onclick="loadLocalConfig(true)"
                style="background-color: #007bff"
              >
                åˆ·æ–°å®¢æˆ·åˆ—è¡¨
              </button>
              <button onclick="queryAllCustomerBills()" id="queryBtn">
                æŸ¥è¯¢å…¨éƒ¨è´¦å•
              </button>
              <button
                onclick="stopQuery()"
                id="stopBtn"
                style="background-color: #dc3545; display: none"
              >
                åœæ­¢æŸ¥è¯¢
              </button>
              <button
                onclick="batchDownloadFromTable()"
                style="background-color: #007bff"
              >
                æ‰“åŒ…ä¸‹è½½æ‰€æœ‰è´¦å•(ZIP)
              </button>
              <button
                onclick="batchDownloadChalvguanjiaFromTable()"
                style="background-color: #28a745"
              >
                æ‰“åŒ…ä¸‹è½½å·®æ—…ç®¡å®¶è´¦å•(ZIP)
              </button>
              <label
                style="
                  margin-left: 20px;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                "
              >
                <input
                  type="checkbox"
                  id="removeZeroRecords"
                  onchange="toggleRemoveZeroRecords()"
                />
                <span>ç§»é™¤é›¶è®°å½•</span>
              </label>
            </div>
          </div>

          <div id="customerBillsTable"></div>
        </div>
      </div>

      <!-- è¿›åº¦æ¡Dialog -->
      <div class="progress-dialog" id="progressDialog">
        <div class="progress-dialog-content">
          <div class="progress-dialog-header">
            <h3>æ‰¹é‡ä¸‹è½½è¿›åº¦</h3>
            <button class="progress-dialog-close" onclick="cancelDownload()">
              &times;
            </button>
          </div>
          <div class="progress-dialog-body">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">å‡†å¤‡ä¸­...</div>
            <div class="progress-details">
              <span id="progressDetails">æ­£åœ¨å‡†å¤‡ä¸‹è½½...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- æ ·å¼è®¾ç½®Dialog -->
      <div class="style-settings-dialog" id="styleSettingsDialog">
        <div class="style-settings-dialog-content">
          <div class="progress-dialog-header">
            <h3>Excelæ ·å¼è®¾ç½®</h3>
            <button class="progress-dialog-close" onclick="hideStyleSettings()">
              &times;
            </button>
          </div>
          <div class="progress-dialog-body">
            <form id="styleSettingsForm">
              <!-- åŸºæœ¬è®¾ç½® -->
              <h4
                style="
                  margin: 0 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                åŸºæœ¬è®¾ç½®
              </h4>

              <div class="style-form-group">
                <label for="startFromSheet">èµ·å§‹å·¥ä½œè¡¨:</label>
                <select id="startFromSheet">
                  <option value="1">ç¬¬1ä¸ªå·¥ä½œè¡¨</option>
                  <option value="2" selected>ç¬¬2ä¸ªå·¥ä½œè¡¨</option>
                  <option value="3">ç¬¬3ä¸ªå·¥ä½œè¡¨</option>
                </select>
              </div>

              <div class="style-checkbox-group">
                <input type="checkbox" id="processAllSheets" checked />
                <label for="processAllSheets">å¤„ç†æ‰€æœ‰åç»­å·¥ä½œè¡¨</label>
              </div>

              <!-- å­—ä½“è®¾ç½® -->
              <h4
                style="
                  margin: 20px 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                å­—ä½“è®¾ç½®
              </h4>

              <div class="style-form-group">
                <label for="fontFamily">å­—ä½“:</label>
                <select id="fontFamily">
                  <option value="å®‹ä½“" selected>å®‹ä½“</option>
                  <option value="å¾®è½¯é›…é»‘">å¾®è½¯é›…é»‘</option>
                  <option value="Arial">Arial</option>
                  <option value="Calibri">Calibri</option>
                  <option value="Times New Roman">Times New Roman</option>
                </select>
              </div>

              <div class="style-form-group">
                <label for="fontSize">å­—å·:</label>
                <input
                  type="number"
                  id="fontSize"
                  value="10"
                  min="6"
                  max="72"
                  step="1"
                />
              </div>

              <div class="style-form-group">
                <label for="fontColor">å­—ä½“é¢œè‰²:</label>
                <input type="color" id="fontColor" value="#000000" />
              </div>

              <!-- è¡Œåˆ—è®¾ç½® -->
              <h4
                style="
                  margin: 20px 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                è¡Œåˆ—è®¾ç½®
              </h4>

              <div class="style-form-group">
                <label for="rowHeight">è¡Œé«˜(ç£…):</label>
                <input
                  type="number"
                  id="rowHeight"
                  value="22"
                  min="10"
                  max="100"
                  step="1"
                />
              </div>

              <div class="style-form-group">
                <label for="columnWidth">åˆ—å®½(å­—ç¬¦):</label>
                <input
                  type="number"
                  id="columnWidth"
                  value=""
                  min="1"
                  max="50"
                  step="0.5"
                  placeholder="ä¸è®¾ç½®åˆ™ä¿æŒåŸæœ‰å®½åº¦"
                />
              </div>

              <!-- å¯¹é½è®¾ç½® -->
              <h4
                style="
                  margin: 20px 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                å¯¹é½è®¾ç½®
              </h4>

              <div class="style-form-group">
                <label for="horizontalAlign">æ°´å¹³å¯¹é½:</label>
                <select id="horizontalAlign">
                  <option value="left" selected>å·¦å¯¹é½</option>
                  <option value="center">å±…ä¸­</option>
                  <option value="right">å³å¯¹é½</option>
                </select>
              </div>

              <div class="style-form-group">
                <label for="verticalAlign">å‚ç›´å¯¹é½:</label>
                <select id="verticalAlign">
                  <option value="top">é¡¶éƒ¨å¯¹é½</option>
                  <option value="middle" selected>å±…ä¸­å¯¹é½</option>
                  <option value="bottom">åº•éƒ¨å¯¹é½</option>
                </select>
              </div>

              <!-- è¾¹æ¡†è®¾ç½® -->
              <h4
                style="
                  margin: 20px 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                è¾¹æ¡†è®¾ç½®
              </h4>

              <div class="style-checkbox-group">
                <input type="checkbox" id="addBorders" checked />
                <label for="addBorders">æ·»åŠ è¾¹æ¡†</label>
              </div>

              <div class="style-form-group">
                <label for="borderStyle">è¾¹æ¡†æ ·å¼:</label>
                <select id="borderStyle">
                  <option value="thin" selected>ç»†çº¿</option>
                  <option value="medium">ä¸­ç­‰</option>
                  <option value="thick">ç²—çº¿</option>
                  <option value="dotted">ç‚¹çº¿</option>
                  <option value="dashed">è™šçº¿</option>
                </select>
              </div>

              <div class="style-form-group">
                <label for="borderColor">è¾¹æ¡†é¢œè‰²:</label>
                <input type="color" id="borderColor" value="#000000" />
              </div>

              <!-- é¢„è§ˆ -->
              <div class="style-preview">
                <h4>æ ·å¼é¢„è§ˆ</h4>
                <table class="style-preview-table" id="stylePreviewTable">
                  <tr>
                    <td>ç¤ºä¾‹æ–‡æœ¬</td>
                    <td>Sample Text</td>
                  </tr>
                  <tr>
                    <td>æ•°å­—123</td>
                    <td>Number 456</td>
                  </tr>
                </table>
              </div>

              <!-- æŒ‰é’® -->
              <div
                style="
                  text-align: center;
                  margin-top: 20px;
                  padding-top: 15px;
                  border-top: 1px solid #eee;
                "
              >
                <button
                  type="button"
                  onclick="resetStyleSettings()"
                  style="background-color: #6c757d; margin-right: 10px"
                >
                  é‡ç½®é»˜è®¤
                </button>
                <button
                  type="button"
                  onclick="hideStyleSettings()"
                  style="background-color: #dc3545; margin-right: 10px"
                >
                  å–æ¶ˆ
                </button>
                <button
                  type="button"
                  onclick="saveStyleSettings()"
                  style="background-color: #28a745"
                >
                  ä¿å­˜è®¾ç½®
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- è´¦å•æ˜ç»†Dialog -->
      <div
        class="style-settings-dialog"
        id="billDetailDialog"
        style="display: none"
      >
        <div class="style-settings-dialog-content">
          <div class="progress-dialog-header">
            <h3>è´¦å•æ˜ç»†</h3>
            <button class="progress-dialog-close" onclick="hideBillDetail()">
              &times;
            </button>
          </div>
          <div class="progress-dialog-body">
            <div
              id="billDetailLoading"
              style="text-align: center; padding: 20px; display: none"
            >
              <div
                style="
                  display: inline-block;
                  width: 20px;
                  height: 20px;
                  border: 3px solid #f3f3f3;
                  border-top: 3px solid #007bff;
                  border-radius: 50%;
                  animation: spin 1s linear infinite;
                "
              ></div>
              <p style="margin-top: 10px; color: #666">æ­£åœ¨åŠ è½½è´¦å•æ˜ç»†...</p>
            </div>
            <div
              id="billDetailContent"
              style="max-height: 60vh; overflow-y: auto"
            >
              <!-- è´¦å•æ˜ç»†å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
            <div
              id="billDetailError"
              style="
                display: none;
                text-align: center;
                padding: 20px;
                color: #dc3545;
              "
            >
              <!-- é”™è¯¯ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
          </div>
        </div>
      </div>

      <div class="log" id="logContainer">
        <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px">
          ğŸ“‹ æ“ä½œæ—¥å¿—
        </h4>
        <div id="logContent"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
      let isDownloading = false;
      let shouldStopDownload = false; // åœæ­¢ä¸‹è½½æ ‡å¿—
      let downloadAbortController = null; // ä¸‹è½½è¯·æ±‚æ§åˆ¶å™¨
      let customerConfig = {};
      let queryResults = []; // å­˜å‚¨æŸ¥è¯¢ç»“æœç”¨äºæ‰¹é‡ä¸‹è½½
      let currentUser = null; // å­˜å‚¨å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
      let projectDirectoryHandle = null; // å­˜å‚¨é¡¹ç›®ç›®å½•å¥æŸ„
      let isQuerying = false; // æŸ¥è¯¢çŠ¶æ€æ ‡å¿—
      let shouldStopQuery = false; // åœæ­¢æŸ¥è¯¢æ ‡å¿—
      let originalCustomerList = []; // å­˜å‚¨åŸå§‹å®¢æˆ·åˆ—è¡¨ç”¨äºç­›é€‰
      let currentFilter = ""; // å½“å‰ç­›é€‰æ¡ä»¶

      // Excelæ ·å¼è®¾ç½®
      let excelStyleSettings = {
        startFromSheet: 2,
        processAllSheets: true,
        fontFamily: "å®‹ä½“",
        fontSize: 10,
        fontColor: "#000000",
        rowHeight: 22,
        columnWidth: null,
        horizontalAlign: "left",
        verticalAlign: "middle",
        addBorders: true,
        borderStyle: "thin",
        borderColor: "#000000"
      };

      // è¡¨æ ¼æŠ˜å çŠ¶æ€
      let isTableCollapsed = false;

      function formatDateTime(dateTimeStr) {
        if (!dateTimeStr || dateTimeStr === "-") {
          return "-";
        }

        try {
          // å¤„ç†å„ç§å¯èƒ½çš„æ—¶é—´æ ¼å¼
          let date;

          // å¦‚æœåŒ…å« 'T' è¯´æ˜æ˜¯ISOæ ¼å¼
          if (dateTimeStr.includes("T")) {
            date = new Date(dateTimeStr);
          }
          // å¦‚æœåŒ…å« 'Z' è¯´æ˜æ˜¯UTCæ ¼å¼
          else if (dateTimeStr.includes("Z")) {
            date = new Date(dateTimeStr);
          }
          // å…¶ä»–æ ¼å¼å°è¯•ç›´æ¥è§£æ
          else {
            date = new Date(dateTimeStr);
          }

          // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
          if (isNaN(date.getTime())) {
            return dateTimeStr; // å¦‚æœæ— æ³•è§£æï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²
          }

          // æ ¼å¼åŒ–ä¸º YYYY-MM-DD
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");

          return `${year}-${month}-${day}`;
        } catch (error) {
          // å¦‚æœæ ¼å¼åŒ–å¤±è´¥ï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²
          return dateTimeStr;
        }
      }

      function generateFileName(customerName, billStartDate, billEndDate) {
        if (
          !billStartDate ||
          !billEndDate ||
          billStartDate === "-" ||
          billEndDate === "-"
        ) {
          return "-";
        }

        try {
          // è§£ææ—¥æœŸ
          const startDate = new Date(billStartDate);
          const endDate = new Date(billEndDate);

          if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            return "-";
          }

          // æ ¼å¼åŒ–ä¸º M.D æ ¼å¼
          const startMonth = startDate.getMonth() + 1;
          const startDay = startDate.getDate();
          const endMonth = endDate.getMonth() + 1;
          const endDay = endDate.getDate();

          // è·å–å®¢æˆ·é…ç½®ä¸­çš„fileNameï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å®Œæ•´å®¢æˆ·å
          const customerData = customerConfig[customerName];
          const displayName =
            customerData && customerData.fileName
              ? customerData.fileName
              : customerName;

          // ç”Ÿæˆæ–‡ä»¶åï¼šfileName+èµ·å§‹æ—¥æœŸ-æˆªæ­¢æ—¥æœŸ
          return `${displayName}${startMonth}.${startDay}-${endMonth}.${endDay}`;
        } catch (error) {
          return "-";
        }
      }

      function isAbnormalBillDate(billDateStr) {
        if (!billDateStr || billDateStr === "-") {
          return false;
        }

        try {
          const billDate = new Date(billDateStr);
          if (isNaN(billDate.getTime())) {
            return false;
          }

          // æ£€æŸ¥æ˜¯å¦ä¸ºå½“æœˆ1å·
          return billDate.getDate() !== 1;
        } catch (error) {
          return false;
        }
      }

      function showToast(message, type = "success", duration = 3000) {
        // ç§»é™¤å·²å­˜åœ¨çš„toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        // åˆ›å»ºæ–°çš„toastå…ƒç´ 
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(toast);

        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
          toast.classList.add("show");
        }, 100);

        // è‡ªåŠ¨éšè—
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 300);
        }, duration);
      }

      // è¡¨æ ¼æŠ˜å /å±•å¼€åŠŸèƒ½
      function toggleTableCollapse() {
        const tableContentArea = document.getElementById("tableContentArea");
        const collapseBtn = document.getElementById("collapseBtn");

        if (!tableContentArea || !collapseBtn) {
          return;
        }

        isTableCollapsed = !isTableCollapsed;

        if (isTableCollapsed) {
          // æŠ˜å è¡¨æ ¼
          tableContentArea.classList.add("collapsed");
          tableContentArea.classList.remove("expanded");
          collapseBtn.textContent = "å±•å¼€";
          collapseBtn.classList.add("collapsed");
          collapseBtn.title = "å±•å¼€è¡¨æ ¼åŒºåŸŸ";
        } else {
          // å±•å¼€è¡¨æ ¼
          tableContentArea.classList.remove("collapsed");
          tableContentArea.classList.add("expanded");
          collapseBtn.textContent = "æŠ˜å ";
          collapseBtn.classList.remove("collapsed");
          collapseBtn.title = "æŠ˜å è¡¨æ ¼åŒºåŸŸ";
        }

        // ä¿å­˜æŠ˜å çŠ¶æ€åˆ°localStorage
        localStorage.setItem("tableCollapsed", isTableCollapsed.toString());
      }

      // ä»localStorageæ¢å¤æŠ˜å çŠ¶æ€
      function restoreTableCollapseState() {
        const saved = localStorage.getItem("tableCollapsed");
        if (saved === "true") {
          // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²åŠ è½½
          setTimeout(() => {
            toggleTableCollapse();
          }, 100);
        }
      }

      async function performLogin() {
        const loginBtn = document.getElementById("loginBtn");
        const loginStatus = document.getElementById("loginStatus");

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        loginBtn.disabled = true;
        loginBtn.textContent = "ç™»å½•ä¸­...";
        loginStatus.textContent = "æ­£åœ¨ç™»å½•...";
        loginStatus.style.color = "#17a2b8";

        try {
          addLog("å¼€å§‹ç™»å½•...", "info");

          const response = await fetch(
            "https://staff-api-gateway.teyixing.com/v1/staff/login",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json"
              },
              body: JSON.stringify({
                identity: "17688731379",
                password: "xin90879"
              })
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.code === 0 && data.data && data.data.token) {
            // ç™»å½•æˆåŠŸ
            currentUser = data.data;

            // ä¿å­˜ç™»å½•ä¿¡æ¯åˆ°localStorage
            localStorage.setItem("userToken", data.data.token);
            localStorage.setItem("userInfo", JSON.stringify(data.data));

            // è‡ªåŠ¨å¡«å……token
            document.getElementById("token").value = data.data.token;

            // æ›´æ–°UIçŠ¶æ€
            loginBtn.textContent = "é‡æ–°ç™»å½•";
            loginBtn.style.backgroundColor = "#28a745";
            loginBtn.disabled = false;
            loginStatus.textContent = `æ¬¢è¿ï¼Œ${data.data.staff.name} (${data.data.staff.workNo})`;
            loginStatus.style.color = "#28a745";

            addLog(`âœ“ ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${data.data.staff.name}`, "success");
            addLog(
              `Tokenå·²è‡ªåŠ¨å¡«å……: ${data.data.token.substring(0, 20)}...`,
              "info"
            );
            addLog("ç™»å½•çŠ¶æ€å·²ä¿å­˜ï¼Œä¸‹æ¬¡è®¿é—®å°†è‡ªåŠ¨æ¢å¤", "info");

            // æ˜¾ç¤ºç™»å½•æˆåŠŸçš„toastæç¤º
            showToast(`ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${data.data.staff.name}`, "success");
          } else {
            throw new Error(data.message || "ç™»å½•å¤±è´¥");
          }
        } catch (error) {
          // ç™»å½•å¤±è´¥
          loginBtn.disabled = false;
          loginBtn.textContent = "é‡æ–°ç™»å½•";
          loginBtn.style.backgroundColor = "#dc3545";
          loginStatus.textContent = "ç™»å½•å¤±è´¥";
          loginStatus.style.color = "#dc3545";

          addLog(`âœ— ç™»å½•å¤±è´¥: ${error.message}`, "error");

          // æ˜¾ç¤ºç™»å½•å¤±è´¥çš„toastæç¤º
          showToast(`ç™»å½•å¤±è´¥: ${error.message}`, "error");
        }
      }

      function clearTokenAndLogin() {
        // æ¸…é™¤tokenå’Œç”¨æˆ·ä¿¡æ¯
        document.getElementById("token").value = "";
        currentUser = null;
        localStorage.removeItem("userToken");
        localStorage.removeItem("userInfo");

        // é‡ç½®ç™»å½•æŒ‰é’®çŠ¶æ€
        const loginBtn = document.getElementById("loginBtn");
        const loginStatus = document.getElementById("loginStatus");

        loginBtn.textContent = "é‡æ–°ç™»å½•";
        loginBtn.style.backgroundColor = "#28a745";
        loginBtn.disabled = false;
        loginStatus.textContent = "Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•";
        loginStatus.style.color = "#dc3545";

        addLog("Tokenå·²è¿‡æœŸï¼Œå·²æ¸…é™¤ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•", "error");
      }

      function stopQuery() {
        shouldStopQuery = true;
        isQuerying = false;

        const queryBtn = document.getElementById("queryBtn");
        const stopBtn = document.getElementById("stopBtn");
        const resultsTitle = document.getElementById("resultsTitle");

        queryBtn.disabled = false;
        queryBtn.textContent = "æŸ¥è¯¢å…¨éƒ¨è´¦å•";
        stopBtn.style.display = "none";

        if (resultsTitle) {
          resultsTitle.textContent = "æŸ¥è¯¢å·²åœæ­¢";
        }

        addLog("ç”¨æˆ·æ‰‹åŠ¨åœæ­¢æŸ¥è¯¢", "info");
      }

      function filterCustomers() {
        // å¦‚æœåœ¨æŸ¥è¯¢ç»“æœé¡µé¢ï¼ˆæœ‰customer-row-å¼€å¤´çš„è¡Œï¼‰ï¼Œä½¿ç”¨applyFilter
        const queryResultRows = document.querySelectorAll(
          '[id^="customer-row-"]'
        );
        if (queryResultRows.length > 0) {
          applyFilter();
          return;
        }

        // å¦‚æœåœ¨å®¢æˆ·åˆ—è¡¨é¡µé¢ï¼Œä½¿ç”¨åŸæ¥çš„é€»è¾‘
        const filterInput = document.getElementById("customerFilter");
        const filterValue = filterInput.value.trim().toLowerCase();
        currentFilter = filterValue;

        // è·å–æ‰€æœ‰å®¢æˆ·è¡Œ
        const customerRows = document.querySelectorAll(
          '[id^="customer-list-row-"]'
        );
        let visibleCount = 0;
        let totalCount = customerRows.length;

        customerRows.forEach(row => {
          const customerNameCell = row.querySelector(
            ".customer-name-display, td:nth-child(2)"
          );
          if (customerNameCell) {
            const customerName = customerNameCell.textContent.toLowerCase();

            if (filterValue === "" || customerName.includes(filterValue)) {
              row.style.display = "";
              visibleCount++;
            } else {
              row.style.display = "none";
            }
          }
        });

        // æ›´æ–°ç­›é€‰çŠ¶æ€
        const filterStatus = document.getElementById("filterStatus");
        if (filterValue === "") {
          filterStatus.textContent = `æ˜¾ç¤ºå…¨éƒ¨ ${totalCount} ä¸ªå®¢æˆ·`;
        } else {
          filterStatus.textContent = `æ‰¾åˆ° ${visibleCount} / ${totalCount} ä¸ªå®¢æˆ·`;
        }
      }

      function clearFilter() {
        const filterInput = document.getElementById("customerFilter");
        const filterType = document.getElementById("filterType");
        filterInput.value = "";
        filterType.value = "all";
        currentFilter = "";
        filterCustomers();
      }

      function applyFilter() {
        const filterType = document.getElementById("filterType").value;
        const customerFilter = document
          .getElementById("customerFilter")
          .value.trim();

        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          return;
        }

        const customerNames = Object.keys(customerConfig);
        const tableBody = document.querySelector("#customerBillsTable tbody");

        if (!tableBody) {
          return;
        }

        let visibleCount = 0;
        let totalCount = customerNames.length;

        customerNames.forEach((customerName, index) => {
          const row = document.getElementById(`customer-row-${index}`);
          if (!row) return;

          let shouldShow = true;

          // é¦–å…ˆåº”ç”¨ç­›é€‰æ¡ä»¶
          if (filterType !== "all") {
            const statusCell = row.querySelector(".status");
            const unpaidAmountCell = row.querySelector(".unpaid-amount");
            const status = statusCell ? statusCell.textContent.trim() : "";
            const unpaidAmountText = unpaidAmountCell
              ? unpaidAmountCell.textContent.trim()
              : "";

            // æå–é‡‘é¢æ•°å€¼
            const debtAmount = unpaidAmountText.includes("Â¥")
              ? parseFloat(
                  unpaidAmountText.replace("Â¥", "").replace(",", "")
                ) || 0
              : 0;

            switch (filterType) {
              case "downloadable":
                shouldShow = status === "å·²æŸ¥åˆ°" && debtAmount > 0;
                break;
              case "no-debt":
                shouldShow = status === "å·²æŸ¥åˆ°" && debtAmount === 0;
                break;
              case "no-data":
                shouldShow = status === "æœªæŸ¥åˆ°è´¦å•";
                break;
              case "failed":
                shouldShow = status === "æŸ¥è¯¢å¤±è´¥";
                break;
              case "teyixing":
                // ç­›é€‰ç‰¹æ˜“è¡Œå®¢æˆ·
                const systemCellTey = row.querySelector(".system-name");
                const systemNameTey = systemCellTey
                  ? systemCellTey.textContent.trim()
                  : "";
                shouldShow = systemNameTey.includes("ç‰¹æ˜“è¡Œ");
                break;
              case "chalvguanjia":
                // ç­›é€‰å·®æ—…ç®¡å®¶å®¢æˆ·
                const systemCellClg = row.querySelector(".system-name");
                const systemNameClg = systemCellClg
                  ? systemCellClg.textContent.trim()
                  : "";
                shouldShow = systemNameClg.includes("å·®æ—…ç®¡å®¶");
                break;
            }
          }

          // ç„¶ååº”ç”¨å®¢æˆ·åç§°ç­›é€‰
          if (shouldShow && customerFilter) {
            shouldShow = customerName
              .toLowerCase()
              .includes(customerFilter.toLowerCase());
          }

          if (shouldShow) {
            row.style.display = "";
            visibleCount++;
          } else {
            row.style.display = "none";
          }
        });

        // æ›´æ–°ç­›é€‰çŠ¶æ€
        const filterStatus = document.getElementById("filterStatus");
        const filterTypeText = document.querySelector(
          `#filterType option[value="${filterType}"]`
        ).textContent;

        if (filterType === "all" && !customerFilter) {
          filterStatus.textContent = `æ˜¾ç¤º ${visibleCount}/${totalCount} ä¸ªå®¢æˆ·`;
        } else {
          filterStatus.textContent = `${filterTypeText} - æ‰¾åˆ° ${visibleCount}/${totalCount} ä¸ªå®¢æˆ·`;
        }
      }

      async function querySingleCustomer(customerName) {
        const token = document.getElementById("token").value.trim();

        if (!token) {
          alert("è¯·è¾“å…¥Token");
          return;
        }

        if (isQuerying) {
          alert("æ­£åœ¨æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨åå†è¯•");
          return;
        }

        try {
          addLog(`æ­£åœ¨æŸ¥è¯¢å®¢æˆ·: ${customerName}`, "info");

          // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æŸ¥è¯¢ä¸­"
          updateCustomerStatus(customerName, "æŸ¥è¯¢ä¸­", "info");

          const response = await fetch(
            "https://staff-api-gateway.teyixing.com/admin/v1/finance/getCreditBills",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
                Accept: "application/json, text/plain, */*"
              },
              body: JSON.stringify({
                corpNameLike: customerName,
                status: null,
                overdue: null,
                pageNumber: 1,
                pageSize: 10
              })
            }
          );

          // æ£€æŸ¥401é”™è¯¯ï¼ˆTokenè¿‡æœŸï¼‰
          if (response.status === 401) {
            addLog("Tokenå·²è¿‡æœŸ", "error");
            alert(
              "Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼\n\nè¯·ç‚¹å‡»'ä¸€é”®ç™»å½•'é‡æ–°è·å–Tokenã€‚"
            );
            clearTokenAndLogin();
            return;
          }

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.data && data.data.content && data.data.content.length > 0) {
            // åªå–ç¬¬ä¸€æ¡è®°å½•
            const firstRecord = data.data.content[0];
            const result = {
              customerName: customerName,
              ...firstRecord
            };

            // æ›´æ–°è¯¥å®¢æˆ·çš„è´¦å•ä¿¡æ¯
            updateCustomerBillInfo(customerName, result);

            // æ›´æ–°queryResultsæ•°ç»„ï¼Œç¡®ä¿æ‰¹é‡ä¸‹è½½åŒ…å«æ­¤ç»“æœ
            updateQueryResults(result);

            addLog(`âœ“ æŸ¥è¯¢æˆåŠŸ: ${customerName}`, "success");
            showToast(`æŸ¥è¯¢æˆåŠŸ: ${customerName}`, "success");
          } else {
            // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æœªæŸ¥åˆ°è´¦å•"
            updateCustomerStatus(customerName, "æœªæŸ¥åˆ°è´¦å•", "warning");
            // ä¸ºæœªæŸ¥åˆ°è´¦å•çš„å®¢æˆ·æ·»åŠ æ“ä½œæŒ‰é’®
            addActionButtonsForCustomer(customerName);
            addLog(`âš  æœªæ‰¾åˆ°æ•°æ®: ${customerName}`, "info");
            showToast(`æœªæŸ¥åˆ°è´¦å•: ${customerName}`, "warning");
          }
        } catch (error) {
          // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æŸ¥è¯¢å¤±è´¥"
          updateCustomerStatus(customerName, "æŸ¥è¯¢å¤±è´¥", "error");
          // ä¸ºæŸ¥è¯¢å¤±è´¥çš„å®¢æˆ·æ·»åŠ æ“ä½œæŒ‰é’®
          addActionButtonsForCustomer(customerName);
          addLog(`âœ— æŸ¥è¯¢å¤±è´¥: ${customerName} - ${error.message}`, "error");
          showToast(`æŸ¥è¯¢å¤±è´¥: ${customerName}`, "error");
        }
      }

      function editCustomerFromQuery(customerName) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index !== -1) {
          editCustomerName(index);
        }
      }

      function deleteCustomerFromQuery(customerName) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index !== -1) {
          deleteCustomer(index);
        }
      }

      async function querySingleCustomerFromList(customerName) {
        const token = document.getElementById("token").value.trim();

        if (!token) {
          showToast(`è¯·è¾“å…¥Token`, "error");
          return;
        }

        if (isQuerying) {
          showToast(`æ­£åœ¨æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨åå†è¯•`, "error");
          return;
        }

        try {
          // å…ˆåˆ‡æ¢åˆ°æŸ¥è¯¢ç»“æœè§†å›¾
          const resultsDiv = document.getElementById("customerResults");
          const filterSection = document.getElementById(
            "customerFilterSection"
          );
          resultsDiv.style.display = "block";
          filterSection.style.display = "block";

          // åˆå§‹åŒ–æŸ¥è¯¢è¡¨æ ¼
          initializeQueryTable();

          addLog(`æ­£åœ¨æŸ¥è¯¢å®¢æˆ·: ${customerName}`, "info");

          // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æŸ¥è¯¢ä¸­"
          updateCustomerStatus(customerName, "æŸ¥è¯¢ä¸­", "info");

          const response = await fetch(
            "https://staff-api-gateway.teyixing.com/admin/v1/finance/getCreditBills",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
                Accept: "application/json, text/plain, */*"
              },
              body: JSON.stringify({
                corpNameLike: customerName,
                status: null,
                overdue: null,
                pageNumber: 1,
                pageSize: 10
              })
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          // æ£€æŸ¥401é”™è¯¯ï¼ˆTokenè¿‡æœŸï¼‰
          if (data.code === 401) {
            addLog("Tokenå·²è¿‡æœŸ", "error");
            showToast(`Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼`, "error");
            clearTokenAndLogin();
            return;
          }
          if (data.data && data.data.content && data.data.content.length > 0) {
            // åªå–ç¬¬ä¸€æ¡è®°å½•
            const firstRecord = data.data.content[0];
            const result = {
              customerName: customerName,
              ...firstRecord
            };

            // æ›´æ–°è¯¥å®¢æˆ·çš„è´¦å•ä¿¡æ¯
            updateCustomerBillInfo(customerName, result);

            // æ›´æ–°queryResultsæ•°ç»„ï¼Œç¡®ä¿æ‰¹é‡ä¸‹è½½åŒ…å«æ­¤ç»“æœ
            updateQueryResults(result);

            addLog(`âœ“ æŸ¥è¯¢æˆåŠŸ: ${customerName}`, "success");
            showToast(`æŸ¥è¯¢æˆåŠŸ: ${customerName}`, "success");
          } else {
            // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æœªæŸ¥åˆ°è´¦å•"
            updateCustomerStatus(customerName, "æœªæŸ¥åˆ°è´¦å•", "warning");
            // ä¸ºæœªæŸ¥åˆ°è´¦å•çš„å®¢æˆ·æ·»åŠ æ“ä½œæŒ‰é’®
            addActionButtonsForCustomer(customerName);
            addLog(`âš  æœªæ‰¾åˆ°æ•°æ®: ${customerName}`, "info");
            showToast(`æœªæŸ¥åˆ°è´¦å•: ${customerName}`, "warning");
          }
        } catch (error) {
          // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æŸ¥è¯¢å¤±è´¥"
          updateCustomerStatus(customerName, "æŸ¥è¯¢å¤±è´¥", "error");
          // ä¸ºæŸ¥è¯¢å¤±è´¥çš„å®¢æˆ·æ·»åŠ æ“ä½œæŒ‰é’®
          addActionButtonsForCustomer(customerName);
          addLog(`âœ— æŸ¥è¯¢å¤±è´¥: ${customerName} - ${error.message}`, "error");
          showToast(`æŸ¥è¯¢å¤±è´¥: ${customerName}`, "error");
        }
      }

      function updateResultsTitle() {
        if (!queryResults || queryResults.length === 0) {
          return;
        }

        const resultsTitle = document.getElementById("resultsTitle");
        const totalResults = queryResults.length;

        // ç»Ÿè®¡èƒ½ä¸‹è½½çš„å®¢æˆ·æ•°é‡ï¼ˆdebtAmount > 0ï¼‰
        const downloadableCount = queryResults.filter(record => {
          const debtAmount = parseFloat(record.debtAmount) || 0;
          return debtAmount > 0;
        }).length;

        // ç»Ÿè®¡å„ç§çŠ¶æ€çš„å®¢æˆ·æ•°é‡
        const customerNames = Object.keys(customerConfig);
        let foundCount = 0;
        let noDataCount = 0;
        let failedCount = 0;

        customerNames.forEach(customerName => {
          const customerNames = Object.keys(customerConfig);
          const index = customerNames.indexOf(customerName);
          if (index !== -1) {
            const row = document.getElementById(`customer-row-${index}`);
            if (row) {
              const statusCell = row.querySelector(".status");
              const status = statusCell ? statusCell.textContent : "";

              if (status === "å·²æŸ¥åˆ°") {
                foundCount++;
              } else if (status === "æœªæŸ¥åˆ°è´¦å•") {
                noDataCount++;
              } else if (status === "æŸ¥è¯¢å¤±è´¥") {
                failedCount++;
              }
            }
          }
        });

        resultsTitle.innerHTML = `æŸ¥è¯¢ç»“æœ (å…±æŸ¥åˆ°${foundCount}æ¡è´¦å•ï¼ŒæœªæŸ¥åˆ°${noDataCount}æ¡ï¼Œå¤±è´¥${failedCount}æ¡ï¼Œå¯ä¸‹è½½${downloadableCount}æ¡ )`;
      }

      function updateQueryResults(newResult) {
        // å¦‚æœqueryResultsè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
        if (!queryResults) {
          queryResults = [];
        }

        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥å®¢æˆ·çš„ç»“æœ
        const existingIndex = queryResults.findIndex(
          result => result.customerName === newResult.customerName
        );

        if (existingIndex !== -1) {
          // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°ç°æœ‰ç»“æœ
          queryResults[existingIndex] = newResult;
          addLog(`æ›´æ–°äº† ${newResult.customerName} çš„æŸ¥è¯¢ç»“æœ`, "info");
        } else {
          // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°ç»“æœ
          queryResults.push(newResult);
          addLog(`æ·»åŠ äº† ${newResult.customerName} çš„æŸ¥è¯¢ç»“æœ`, "info");
        }

        // æ›´æ–°æ‰¹é‡ä¸‹è½½æŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
        const batchDownloadBtn = document.getElementById("batchDownloadBtn");
        if (queryResults.length > 0) {
          batchDownloadBtn.style.display = "inline-block";
        }

        // æ›´æ–°æ ‡é¢˜ç»Ÿè®¡ä¿¡æ¯
        updateResultsTitle();
      }

      async function loadLocalConfig(
        showToastNotification = false,
        event = null
      ) {
        // é˜²æ­¢ä»»ä½•é»˜è®¤è¡Œä¸º
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        try {
          const response = await fetch("./download_config.json");
          if (!response.ok) {
            throw new Error(`æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶: ${response.status}`);
          }

          customerConfig = await response.json();
          addLog(
            `æˆåŠŸåŠ è½½æœ¬åœ°é…ç½®ï¼ŒåŒ…å« ${
              Object.keys(customerConfig).length
            } ä¸ªå®¢æˆ·`,
            "success"
          );

          // æ˜¾ç¤ºåŠ è½½çš„å®¢æˆ·åˆ—è¡¨
          const customerNames = Object.keys(customerConfig).join(", ");
          addLog(`å®¢æˆ·åˆ—è¡¨: ${customerNames}`, "info");

          // æ˜¾ç¤ºé»˜è®¤çš„å®¢æˆ·åˆ—è¡¨è¡¨æ ¼
          displayCustomerList();

          // åªæœ‰æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®æ—¶æ‰æ˜¾ç¤ºtoastæç¤º
          if (showToastNotification) {
            showToast(
              `åˆ·æ–°æˆåŠŸï¼åŠ è½½äº† ${Object.keys(customerConfig).length} ä¸ªå®¢æˆ·`,
              "success"
            );
          }
        } catch (error) {
          addLog(`åŠ è½½æœ¬åœ°é…ç½®å¤±è´¥: ${error.message}`, "error");

          // åªæœ‰æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®æ—¶æ‰æ˜¾ç¤ºtoastæç¤º
          if (showToastNotification) {
            showToast(`åˆ·æ–°å¤±è´¥: ${error.message}`, "error");
          }
        }
      }

      function displayCustomerList() {
        const resultsDiv = document.getElementById("customerResults");
        const tableDiv = document.getElementById("customerBillsTable");
        const batchDownloadBtn = document.getElementById("batchDownloadBtn");
        const resultsTitle = document.getElementById("resultsTitle");
        const filterSection = document.getElementById("customerFilterSection");
        const actionButtonsSection = document.getElementById(
          "actionButtonsSection"
        );

        resultsDiv.style.display = "block";
        batchDownloadBtn.style.display = "none"; // éšè—æ‰¹é‡ä¸‹è½½æŒ‰é’®

        // æ›´æ–°æ ‡é¢˜
        const customerCount = customerConfig
          ? Object.keys(customerConfig).length
          : 0;
        resultsTitle.textContent = `å®¢æˆ·åˆ—è¡¨ (å…±${customerCount}ä¸ª):`;

        // æ˜¾ç¤ºç­›é€‰åŒºåŸŸå’Œæ“ä½œæŒ‰é’®åŒºåŸŸï¼ˆå¦‚æœæœ‰å®¢æˆ·æ•°æ®ï¼‰
        if (customerCount > 0) {
          filterSection.style.display = "block";
          actionButtonsSection.style.display = "block";
        } else {
          filterSection.style.display = "none";
          actionButtonsSection.style.display = "none";
        }

        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          tableDiv.innerHTML = "<p>æœªåŠ è½½å®¢æˆ·é…ç½®</p>";
          return;
        }

        let tableHTML = `
                      <table class="customer-table">
                        <thead>
                          <tr>
                            <th>åºå·</th>
                            <th>å®¢æˆ·åç§°</th>
                            <th>ç³»ç»Ÿ</th>
                            <th>æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody>
                    `;

        const customerNames = Object.keys(customerConfig);
        customerNames.forEach((customerName, index) => {
          const customerData = customerConfig[customerName];
          const systemName =
            customerData && customerData.system
              ? customerData.system
              : "ç‰¹æ˜“è¡Œ";
          const systemClass =
            systemName === "ç‰¹æ˜“è¡Œ" ? "system-teyixing" : "system-other";

          tableHTML += `
                        <tr id="customer-list-row-${index}">
                          <td class="row-index">${index + 1}</td>
                          <td class="customer-name-cell">
                            ${customerName}
                          </td>
                          <td class="system-name ${systemClass}">${systemName}</td>
                          <td>
                            <button onclick="querySingleCustomerFromList('${customerName}')" class="table-btn query">æŸ¥è¯¢</button>
                          </td>
                        </tr>
                      `;
        });

        tableHTML += "</tbody></table>";
        tableDiv.innerHTML = tableHTML;

        // åˆå§‹åŒ–ç­›é€‰çŠ¶æ€
        setTimeout(() => {
          filterCustomers();
        }, 100);
      }

      function editCustomerName(index) {
        const customerNames = Object.keys(customerConfig);
        const originalName = customerNames[index];
        const row = document.getElementById(`customer-list-row-${index}`);

        if (!row) return;

        const displaySpan = row.querySelector(".customer-name-display");
        const editInput = row.querySelector(".customer-name-edit");
        const editBtn = row.querySelector(".edit-btn");

        if (editBtn.textContent === "ç¼–è¾‘") {
          // è¿›å…¥ç¼–è¾‘æ¨¡å¼
          displaySpan.style.display = "none";
          editInput.style.display = "inline-block";
          editInput.focus();
          editInput.select();
          editBtn.textContent = "ä¿å­˜";
          editBtn.style.backgroundColor = "#28a745";
        } else {
          // ä¿å­˜ç¼–è¾‘
          const newName = editInput.value.trim();

          if (!newName) {
            alert("å®¢æˆ·åç§°ä¸èƒ½ä¸ºç©º");
            return;
          }

          if (newName !== originalName) {
            // æ£€æŸ¥æ–°åç§°æ˜¯å¦å·²å­˜åœ¨
            if (customerConfig.hasOwnProperty(newName)) {
              alert("è¯¥å®¢æˆ·åç§°å·²å­˜åœ¨");
              return;
            }

            // æ›´æ–°é…ç½® - å°†ä¿®æ”¹çš„å®¢æˆ·ç§»åˆ°ç¬¬ä¸€ä½
            delete customerConfig[originalName];

            // åˆ›å»ºæ–°çš„é…ç½®å¯¹è±¡ï¼Œå°†ä¿®æ”¹çš„å®¢æˆ·æ”¾åœ¨ç¬¬ä¸€ä½
            const newConfig = { [newName]: "" };
            Object.keys(customerConfig).forEach(key => {
              newConfig[key] = customerConfig[key];
            });
            customerConfig = newConfig;

            addLog(
              `å®¢æˆ·åç§°å·²æ›´æ–°: "${originalName}" â†’ "${newName}"`,
              "success"
            );

            // ä¿å­˜åˆ°æœ¬åœ°JSONæ–‡ä»¶
            saveConfigToLocal();
          }

          // é€€å‡ºç¼–è¾‘æ¨¡å¼
          displaySpan.textContent = newName;
          displaySpan.style.display = "inline-block";
          editInput.style.display = "none";
          editBtn.textContent = "ç¼–è¾‘";
          editBtn.style.backgroundColor = "#007bff";

          // åˆ·æ–°æ˜¾ç¤º
          displayCustomerList();
        }
      }

      function deleteCustomer(index) {
        const customerNames = Object.keys(customerConfig);
        const customerName = customerNames[index];

        if (confirm(`ç¡®å®šè¦åˆ é™¤å®¢æˆ· "${customerName}" å—ï¼Ÿ`)) {
          delete customerConfig[customerName];
          addLog(`å·²åˆ é™¤å®¢æˆ·: ${customerName}`, "info");

          // ä¿å­˜åˆ°æœ¬åœ°JSONæ–‡ä»¶
          saveConfigToLocal();

          // åˆ·æ–°æ˜¾ç¤º
          displayCustomerList();
        }
      }

      function addNewCustomer(event = null) {
        // é˜²æ­¢ä»»ä½•é»˜è®¤è¡Œä¸º
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        const newName = prompt("è¯·è¾“å…¥æ–°å®¢æˆ·åç§°:");

        if (!newName || !newName.trim()) {
          return;
        }

        const cleanedName = cleanCustomerName(newName.trim());

        if (customerConfig.hasOwnProperty(cleanedName)) {
          alert("è¯¥å®¢æˆ·åç§°å·²å­˜åœ¨");
          return;
        }

        // å°†æ–°å®¢æˆ·æ·»åŠ åˆ°ç¬¬ä¸€ä½
        const newConfig = { [cleanedName]: "" };
        Object.keys(customerConfig).forEach(key => {
          newConfig[key] = customerConfig[key];
        });
        customerConfig = newConfig;

        if (newName.trim() !== cleanedName) {
          addLog(
            `å®¢æˆ·åç§°å·²å¤„ç†: "${newName.trim()}" â†’ "${cleanedName}"`,
            "info"
          );
        }

        addLog(`å·²æ·»åŠ æ–°å®¢æˆ·: ${cleanedName}`, "success");

        // ä¿å­˜åˆ°æœ¬åœ°JSONæ–‡ä»¶
        saveConfigToLocal();

        // åˆ·æ–°æ˜¾ç¤º
        displayCustomerList();
      }

      async function saveConfigToLocal() {
        try {
          const configJson = JSON.stringify(customerConfig, null, 2);

          // å°è¯•é€šè¿‡Node.jsæœåŠ¡å™¨ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
          try {
            const response = await fetch("http://localhost:3000/save_config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: configJson
            });

            if (response.ok) {
              addLog("âœ“ é…ç½®å·²ç›´æ¥ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶", "success");
              showToast("é…ç½®ä¿å­˜æˆåŠŸï¼", "success");
              return;
            } else {
              throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`);
            }
          } catch (err) {
            addLog(`æ— æ³•è¿æ¥åˆ°Node.jsæœåŠ¡å™¨: ${err.message}`, "info");
          }

          addLog("æ— æ³•è¿æ¥åˆ°Node.jsæœåŠ¡å™¨ï¼Œä½¿ç”¨æµè§ˆå™¨ä¿å­˜æ–¹å¼", "info");

          // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æµè§ˆå™¨çš„æ–‡ä»¶ç³»ç»Ÿè®¿é—®API
          if ("showSaveFilePicker" in window) {
            try {
              const fileHandle = await window.showSaveFilePicker({
                suggestedName: "download_config.json",
                types: [
                  {
                    description: "JSONé…ç½®æ–‡ä»¶",
                    accept: { "application/json": [".json"] }
                  }
                ]
              });

              const writable = await fileHandle.createWritable();
              await writable.write(configJson);
              await writable.close();

              addLog("âœ“ é…ç½®å·²ä¿å­˜ï¼Œè¯·å°†æ–‡ä»¶æ”¾åˆ°é¡¹ç›®ç›®å½•", "success");
              showToast("é…ç½®æ–‡ä»¶ä¿å­˜æˆåŠŸï¼", "success");
              return;
            } catch (err) {
              if (err.name === "AbortError") {
                addLog("ç”¨æˆ·å–æ¶ˆä¿å­˜æ“ä½œ", "info");
                return;
              }
            }
          }

          // æœ€åçš„é™çº§æ–¹æ¡ˆï¼šä¸‹è½½æ–‡ä»¶
          const blob = new Blob([configJson], { type: "application/json" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "download_config.json";
          a.style.display = "none";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog("âœ“ é…ç½®æ–‡ä»¶å·²ä¸‹è½½", "success");
          addLog("è¯·å°†ä¸‹è½½çš„æ–‡ä»¶æ›¿æ¢é¡¹ç›®ç›®å½•ä¸­çš„ download_config.json", "info");
          showToast("é…ç½®æ–‡ä»¶å·²ä¸‹è½½åˆ°æœ¬åœ°ï¼", "success");
        } catch (error) {
          addLog(`ä¿å­˜é…ç½®å¤±è´¥: ${error.message}`, "error");
          showToast(`ä¿å­˜å¤±è´¥: ${error.message}`, "error");
        }
      }

      function initializeQueryTable() {
        const tableDiv = document.getElementById("customerBillsTable");
        const batchDownloadBtn = document.getElementById("batchDownloadBtn");
        const filterSection = document.getElementById("customerFilterSection");
        const actionButtonsSection = document.getElementById(
          "actionButtonsSection"
        );

        batchDownloadBtn.style.display = "none"; // éšè—æ‰¹é‡ä¸‹è½½æŒ‰é’®

        // æ˜¾ç¤ºç­›é€‰åŒºåŸŸå’Œæ“ä½œæŒ‰é’®åŒºåŸŸ
        if (customerConfig && Object.keys(customerConfig).length > 0) {
          filterSection.style.display = "block";
          actionButtonsSection.style.display = "block";
        }

        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          tableDiv.innerHTML = "<p>æœªåŠ è½½å®¢æˆ·é…ç½®</p>";
          return;
        }

        let tableHTML = `
                <table class="customer-table">
                  <thead>
                    <tr>
                      <th>åºå·</th>
                      <th>å®¢æˆ·åç§°</th>
                      <th>ç³»ç»Ÿ</th>
                      <th>æ–‡ä»¶å</th>
                      <th>è´¦å•ç¼–å·</th>
                      <th>å‡ºè´¦æ—¥</th>
                      <th>è´¦å•èµ·å§‹æ—¥</th>
                      <th>è´¦å•æˆªæ­¢æ—¥</th>
                      <th>æœ€è¿Ÿè¿˜æ¬¾æ—¥</th>
                      <th>è´¦å•é‡‘é¢</th>
                      <th>å·²è¿˜é‡‘é¢</th>
                      <th>å¾…è¿˜é‡‘é¢</th>
                      <th>è¿˜æ¬¾æ—¥æœŸ</th>
                      <th>çŠ¶æ€</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

        const customerNames = Object.keys(customerConfig);
        customerNames.forEach((customerName, index) => {
          const customerData = customerConfig[customerName];
          const systemName =
            customerData && customerData.system
              ? customerData.system
              : "ç‰¹æ˜“è¡Œ";
          const systemClass =
            systemName === "ç‰¹æ˜“è¡Œ" ? "system-teyixing" : "system-other";

          tableHTML += `
                  <tr id="customer-row-${index}">
                    <td class="row-index">${index + 1}</td>
                    <td class="customer-name">${customerName}</td>
                    <td class="system-name ${systemClass}">${systemName}</td>
                    <td class="file-name">-</td>
                    <td class="bill-no">-</td>
                    <td class="bill-date">-</td>
                    <td class="bill-start-date">-</td>
                    <td class="bill-end-date">-</td>
                    <td class="latest-repay-date">-</td>
                    <td class="bill-amount">-</td>
                    <td class="paid-amount">-</td>
                    <td class="unpaid-amount">-</td>
                    <td class="repay-date">-</td>
                    <td class="status">å¾…æŸ¥è¯¢</td>
                    <td class="action">
                      <button onclick="querySingleCustomer('${customerName}')" class="table-btn query">æŸ¥è¯¢</button>
                    </td>
                  </tr>
                `;
        });

        tableHTML += "</tbody></table>";
        tableDiv.innerHTML = tableHTML;

        // åˆå§‹åŒ–ç­›é€‰çŠ¶æ€
        setTimeout(() => {
          filterCustomers();
        }, 100);
      }

      function updateCustomerStatus(customerName, status, type) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index === -1) return;

        const row = document.getElementById(`customer-row-${index}`);
        if (!row) return;

        const statusCell = row.querySelector(".status");
        statusCell.textContent = status;

        // æ ¹æ®çŠ¶æ€ç±»å‹è®¾ç½®æ ·å¼
        statusCell.className = "status";
        if (type === "error") {
          statusCell.style.color = "#dc3545";
        } else if (type === "warning") {
          statusCell.style.color = "#ffc107";
        } else if (type === "info") {
          statusCell.style.color = "#17a2b8";
        } else {
          statusCell.style.color = "#28a745";
        }

        // æ ¹æ®çŠ¶æ€å¤„ç†æ ·å¼
        const customerNameCell = row.querySelector(".customer-name");
        const billDateCell = row.querySelector(".bill-date");

        if (status !== "å·²æŸ¥åˆ°") {
          // æ¸…é™¤å¼‚å¸¸å‡ºè´¦æ—¥æ ·å¼
          if (customerNameCell) {
            customerNameCell.classList.remove("abnormal-bill-date");
          }
          if (billDateCell) {
            billDateCell.classList.remove("abnormal-bill-date-cell");
          }
        }

        // ä¸ºæœªæŸ¥åˆ°è´¦å•çš„å®¢æˆ·æ ‡æ©™è‰²æ•´è¡Œ
        if (status === "æœªæŸ¥åˆ°è´¦å•") {
          row.classList.add("no-bill-found-row");
        } else {
          // æ¸…é™¤æ©™è‰²æ•´è¡Œæ ·å¼
          row.classList.remove("no-bill-found-row");
        }

        // æ›´æ–°æ ‡é¢˜ç»Ÿè®¡ä¿¡æ¯
        setTimeout(() => {
          updateResultsTitle();
        }, 100);
      }

      function updateCustomerBillInfo(customerName, billData) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index === -1) return;

        const row = document.getElementById(`customer-row-${index}`);
        if (!row) return;

        // æ›´æ–°è´¦å•ä¿¡æ¯
        row.querySelector(".bill-no").textContent = billData.billNo || "-";
        row.querySelector(".bill-date").textContent = formatDateTime(
          billData.billDate
        );
        row.querySelector(".bill-start-date").textContent = formatDateTime(
          billData.billStartDate
        );
        row.querySelector(".bill-end-date").textContent = formatDateTime(
          billData.billEndDate
        );
        row.querySelector(".latest-repay-date").textContent = formatDateTime(
          billData.latestRepayDate
        );
        row.querySelector(".bill-amount").textContent = billData.billAmount
          ? `Â¥${billData.billAmount}`
          : "-";
        row.querySelector(".paid-amount").textContent = billData.paidAmount
          ? `Â¥${billData.paidAmount}`
          : "-";
        row.querySelector(".unpaid-amount").textContent = billData.debtAmount
          ? `Â¥${billData.debtAmount}`
          : "-";
        row.querySelector(".repay-date").textContent = formatDateTime(
          billData.repayDate
        );

        // æ›´æ–°æ–‡ä»¶å
        const fileName = generateFileName(
          customerName,
          billData.billStartDate,
          billData.billEndDate
        );
        row.querySelector(".file-name").textContent = fileName;
        row.querySelector(".status").textContent = "å·²æŸ¥åˆ°";
        row.querySelector(".status").style.color = "#28a745";

        // æ£€æŸ¥å‡ºè´¦æ—¥æ˜¯å¦å¼‚å¸¸ï¼Œå¦‚æœæ˜¯åˆ™æ ‡çº¢å®¢æˆ·åç§°å’Œå‡ºè´¦æ—¥æ ¼å­
        const customerNameCell = row.querySelector(".customer-name");
        const billDateCell = row.querySelector(".bill-date");
        if (isAbnormalBillDate(billData.billDate)) {
          customerNameCell.classList.add("abnormal-bill-date");
          billDateCell.classList.add("abnormal-bill-date-cell");
          addLog(
            `âš  å®¢æˆ· ${customerName} çš„å‡ºè´¦æ—¥ä¸æ˜¯1å·: ${formatDateTime(
              billData.billDate
            )}`,
            "warning"
          );
        } else {
          customerNameCell.classList.remove("abnormal-bill-date");
          billDateCell.classList.remove("abnormal-bill-date-cell");
        }

        // æ·»åŠ æ“ä½œæŒ‰é’®
        const debtAmount = parseFloat(billData.debtAmount) || 0;
        const downloadBtnClass =
          debtAmount > 0 ? "table-btn download" : "table-btn download disabled";
        const downloadBtnClick =
          debtAmount > 0
            ? `onclick="downloadBill('${
                billData.billId
              }', '${customerName}', '${billData.billNo || ""}', '${
                billData.debtAmount || 0
              }', '${billData.billStartDate || ""}', '${
                billData.billEndDate || ""
              }')"`
            : `onclick="alert('è¯¥å®¢æˆ·å¾…è¿˜é‡‘é¢ä¸ºÂ¥${debtAmount}ï¼Œæ— éœ€ä¸‹è½½è´¦å•')" style="cursor: not-allowed;"`;

        row.querySelector(".action").innerHTML = `
                <button ${downloadBtnClick} class="${downloadBtnClass}">ä¸‹è½½</button>
                <button onclick="querySingleCustomer('${customerName}')" class="table-btn query">æŸ¥è¯¢</button>
                <button onclick="showBillDetail('${
                  billData.billId
                }', '${customerName}', '${
                  billData.billNo || ""
                }')" class="table-btn detail">æ˜ç»†</button>
              `;
      }

      function addActionButtonsForCustomer(customerName) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index === -1) return;

        const row = document.getElementById(`customer-row-${index}`);
        if (!row) return;

        // æ·»åŠ æ“ä½œæŒ‰é’®ï¼ˆæ²¡æœ‰ä¸‹è½½æŒ‰é’®ï¼Œå› ä¸ºæ²¡æœ‰è´¦å•ï¼‰
        row.querySelector(".action").innerHTML = `
                <button onclick="querySingleCustomer('${customerName}')" class="table-btn query">æŸ¥è¯¢</button>
              `;
      }

      function handleExcelFile(event) {
        // é˜²æ­¢ä»»ä½•é»˜è®¤è¡Œä¸º
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        const fileInput = document.getElementById("excelFile");
        const file = fileInput.files[0];

        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });

            // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            // è½¬æ¢ä¸ºJSONæ•°æ®
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // å¤„ç†å®¢æˆ·æ•°æ®
            processExcelData(jsonData);
          } catch (error) {
            addLog(`Excelæ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}`, "error");
          }
        };

        reader.readAsArrayBuffer(file);

        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œé¿å…é‡å¤å¤„ç†
        fileInput.value = "";
      }

      // æ˜¾ç¤ºæ ·å¼è®¾ç½®å¯¹è¯æ¡†
      function showStyleSettings() {
        const dialog = document.getElementById("styleSettingsDialog");
        dialog.style.display = "flex";

        // åŠ è½½å½“å‰è®¾ç½®åˆ°è¡¨å•
        loadStyleSettingsToForm();

        // æ›´æ–°é¢„è§ˆ
        updateStylePreview();
      }

      // éšè—æ ·å¼è®¾ç½®å¯¹è¯æ¡†
      function hideStyleSettings() {
        const dialog = document.getElementById("styleSettingsDialog");
        dialog.style.display = "none";
      }

      // ==================== è´¦å•æ˜ç»†åŠŸèƒ½ ====================

      // æ˜¾ç¤ºè´¦å•æ˜ç»†
      async function showBillDetail(billId, customerName, billNo) {
        const dialog = document.getElementById("billDetailDialog");
        const loading = document.getElementById("billDetailLoading");
        const content = document.getElementById("billDetailContent");
        const error = document.getElementById("billDetailError");

        // æ˜¾ç¤ºå¯¹è¯æ¡†
        dialog.style.display = "flex";

        // é‡ç½®çŠ¶æ€
        loading.style.display = "block";
        content.style.display = "none";
        error.style.display = "none";
        content.innerHTML = "";
        error.innerHTML = "";

        // æ›´æ–°æ ‡é¢˜
        const title = dialog.querySelector("h3");
        title.textContent = `è´¦å•æ˜ç»† - ${customerName} (${billNo || billId})`;

        try {
          addLog(
            `æ­£åœ¨è·å–è´¦å•æ˜ç»†: ${customerName} - ${billNo || billId}`,
            "info"
          );

          const token = document.getElementById("token").value.trim();
          if (!token) {
            throw new Error("è¯·å…ˆè¾“å…¥è®¿é—®ä»¤ç‰Œ");
          }

          // è°ƒç”¨APIè·å–è´¦å•æ˜ç»†
          const response = await fetch(
            `https://staff-api-gateway.teyixing.com/admin/v1/finance/getCreditBillDetail?billId=${billId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`
              }
            }
          );

          if (!response.ok) {
            if (response.status === 401) {
              throw new Error("è®¿é—®ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();

          if (result.code !== 0) {
            throw new Error(result.message || "è·å–è´¦å•æ˜ç»†å¤±è´¥");
          }

          // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
          loading.style.display = "none";
          content.style.display = "block";

          // æ¸²æŸ“è´¦å•æ˜ç»†
          renderBillDetail(result.data, customerName, billNo || billId);

          addLog(`âœ… è´¦å•æ˜ç»†è·å–æˆåŠŸ: ${customerName}`, "success");
        } catch (error) {
          // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºé”™è¯¯
          loading.style.display = "none";
          error.style.display = "block";
          error.innerHTML = `
            <h4>è·å–è´¦å•æ˜ç»†å¤±è´¥</h4>
            <p>${error.message}</p>
            <button onclick="showBillDetail('${billId}', '${customerName}', '${billNo}')"
                    style="background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
              é‡è¯•
            </button>
          `;

          addLog(
            `âŒ è·å–è´¦å•æ˜ç»†å¤±è´¥: ${customerName} - ${error.message}`,
            "error"
          );
          console.error("è·å–è´¦å•æ˜ç»†å¤±è´¥:", error);
        }
      }

      // éšè—è´¦å•æ˜ç»†å¯¹è¯æ¡†
      function hideBillDetail() {
        const dialog = document.getElementById("billDetailDialog");
        dialog.style.display = "none";
      }

      // æ¸²æŸ“è´¦å•æ˜ç»†æ•°æ®
      function renderBillDetail(data, customerName, billIdentifier) {
        const content = document.getElementById("billDetailContent");

        if (!data) {
          content.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
              <h4>æš‚æ— è´¦å•æ˜ç»†æ•°æ®</h4>
            </div>
          `;
          return;
        }

        // è®¡ç®—æ˜¯å¦é€¾æœŸ
        const isOverdue = checkIfOverdue(data.repaymentDate, data.repaidTime);
        const overdueText = isOverdue ? "æ˜¯" : "å¦";
        const overdueColor = isOverdue ? "#dc3545" : "#28a745";

        // æ ¼å¼åŒ–è´¦å•åŒºé—´
        const billPeriod = formatBillPeriod(
          data.billStartDate,
          data.billEndDate
        );

        // æ ¼å¼åŒ–è¿˜æ¬¾æ—¥æœŸ
        const repaymentDateFormatted = formatDate(data.repaymentDate);

        // åŸºæœ¬ä¿¡æ¯
        const basicInfo = `
          <div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 8px;">è´¦å•åŸºæœ¬ä¿¡æ¯</h4>

            <!-- å…¬å¸åç§°å ä¸€è¡Œ -->
            <div style="margin-bottom: 8px;">
              <strong>å…¬å¸åç§°:</strong> ${data.corpName || "-"}
            </div>

            <!-- è´¦å•åŒºé—´å ä¸€è¡Œ -->
            <div style="margin-bottom: 8px;">
              <strong>è´¦å•åŒºé—´:</strong> ${billPeriod}
            </div>

            <!-- æœ€è¿Ÿè¿˜æ¬¾æ—¥å’Œæ˜¯å¦é€¾æœŸå ä¸€è¡Œ -->
            <div style="margin-bottom: 8px;">
              <strong>æœ€è¿Ÿè¿˜æ¬¾æ—¥:</strong> ${repaymentDateFormatted}
              <span style="margin-left: 30px;"><strong>æ˜¯å¦é€¾æœŸ:</strong> ${overdueText}</span>
            </div>

            <!-- è´¦å•é‡‘é¢å’Œæ¬ æ¬¾é‡‘é¢å ä¸€è¡Œ -->
            <div style="margin-bottom: 15px;">
              <strong>è´¦å•é‡‘é¢:</strong> Â¥${data.billAmount || "0"}
              <span style="margin-left: 30px;"><strong>æ¬ æ¬¾é‡‘é¢:</strong> Â¥${
                data.debtAmount || "0"
              }</span>
            </div>


          </div>
        `;

        // ä¿¡è´·è´¦å•æ˜ç»†ä¿¡æ¯
        let creditBillInfo = "";
        if (data.creditBillFeeInfo) {
          const feeInfo = data.creditBillFeeInfo;

          // è®¡ç®—è´¹ç”¨æ˜ç»†å­—ç¬¦ä¸²ï¼ŒåŒ…å«è°ƒæ•´é‡‘é¢
          const feeBreakdown = `å›½å†…æœºç¥¨ ${feeInfo.flightTotal || 0} + ç«è½¦ç¥¨ ${
            feeInfo.trainTotal || 0
          } + å›½å†…é…’åº— ${feeInfo.hotelTotal || 0} + å›½é™…æœºç¥¨ ${
            feeInfo.intFlightTotal || 0
          } + å›½é™…é…’åº— ${feeInfo.intHotelTotal || 0} + å…¶ä»–äº§å“ ${
            feeInfo.commonOrderTotal || 0
          } + è°ƒæ•´é‡‘é¢ ${feeInfo.adjustTotal || 0}`;

          creditBillInfo = `
            <div style="background-color: #e8f5e8; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 8px;"> è´¹ç”¨æ˜ç»†</h4>

              <!-- è´¦å•é‡‘é¢æ€»è§ˆ -->
              <div style="margin-bottom: 10px;">
                <strong>è´¦å•é‡‘é¢(å…ƒ):</strong> Â¥${
                  data.billAmount || "0"
                }${createCopyIcon(data.billAmount || "0", "è´¦å•é‡‘é¢")}
              </div>

              <!-- è´¹ç”¨åˆ†è§£ï¼ˆåŒ…å«è°ƒæ•´é‡‘é¢ï¼‰ -->
              <div style="margin-bottom: 10px; white-space: nowrap; overflow-x: auto;">
                ${feeBreakdown}
              </div>
            </div>
          `;
        }

        // ç»„åˆæ‰€æœ‰å†…å®¹
        content.innerHTML = basicInfo + creditBillInfo;
      }

      // ==================== è´¦å•æ˜ç»†è¾…åŠ©å‡½æ•° ====================

      // æ£€æŸ¥æ˜¯å¦é€¾æœŸ
      function checkIfOverdue(repaymentDate, repaidTime) {
        if (!repaymentDate) return false;

        // å¦‚æœå·²ç»è¿˜æ¬¾ï¼Œåˆ™ä¸ç®—é€¾æœŸ
        if (repaidTime) return false;

        const repaymentDateTime = new Date(repaymentDate);
        const currentTime = new Date();

        // å¦‚æœå½“å‰æ—¶é—´è¶…è¿‡è¿˜æ¬¾æ—¥æœŸï¼Œåˆ™ä¸ºé€¾æœŸ
        return currentTime > repaymentDateTime;
      }

      // æ ¼å¼åŒ–è´¦å•åŒºé—´
      function formatBillPeriod(startDate, endDate) {
        if (!startDate || !endDate) return "-";

        const start = formatDate(startDate);
        const end = formatDate(endDate);

        return `${start} è‡³ ${end}`;
      }

      // æ ¼å¼åŒ–æ—¥æœŸï¼ˆåªæ˜¾ç¤ºæ—¥æœŸéƒ¨åˆ†ï¼‰
      function formatDate(dateString) {
        if (!dateString) return "-";

        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return "-";

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");

          return `${year}-${month}-${day}`;
        } catch (error) {
          return "-";
        }
      }

      // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ï¼ˆæ˜¾ç¤ºå®Œæ•´çš„æ—¥æœŸå’Œæ—¶é—´ï¼‰
      function formatDateTime(dateTimeString) {
        if (!dateTimeString) return "-";

        try {
          const date = new Date(dateTimeString);
          if (isNaN(date.getTime())) return "-";

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          const seconds = String(date.getSeconds()).padStart(2, "0");

          return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        } catch (error) {
          return "-";
        }
      }

      // åŠ è½½è®¾ç½®åˆ°è¡¨å•
      function loadStyleSettingsToForm() {
        document.getElementById("startFromSheet").value =
          excelStyleSettings.startFromSheet;
        document.getElementById("processAllSheets").checked =
          excelStyleSettings.processAllSheets;
        document.getElementById("fontFamily").value =
          excelStyleSettings.fontFamily;
        document.getElementById("fontSize").value = excelStyleSettings.fontSize;
        document.getElementById("fontColor").value =
          excelStyleSettings.fontColor;
        document.getElementById("rowHeight").value =
          excelStyleSettings.rowHeight;
        document.getElementById("columnWidth").value =
          excelStyleSettings.columnWidth || "";
        document.getElementById("horizontalAlign").value =
          excelStyleSettings.horizontalAlign;
        document.getElementById("verticalAlign").value =
          excelStyleSettings.verticalAlign;
        document.getElementById("addBorders").checked =
          excelStyleSettings.addBorders;
        document.getElementById("borderStyle").value =
          excelStyleSettings.borderStyle;
        document.getElementById("borderColor").value =
          excelStyleSettings.borderColor;
      }

      // ä¿å­˜æ ·å¼è®¾ç½®
      function saveStyleSettings() {
        // ä»è¡¨å•è·å–è®¾ç½®
        excelStyleSettings.startFromSheet = parseInt(
          document.getElementById("startFromSheet").value
        );
        excelStyleSettings.processAllSheets =
          document.getElementById("processAllSheets").checked;
        excelStyleSettings.fontFamily =
          document.getElementById("fontFamily").value;
        excelStyleSettings.fontSize = parseInt(
          document.getElementById("fontSize").value
        );
        excelStyleSettings.fontColor =
          document.getElementById("fontColor").value;
        excelStyleSettings.rowHeight = parseInt(
          document.getElementById("rowHeight").value
        );
        excelStyleSettings.columnWidth = document.getElementById("columnWidth")
          .value
          ? parseFloat(document.getElementById("columnWidth").value)
          : null;
        excelStyleSettings.horizontalAlign =
          document.getElementById("horizontalAlign").value;
        excelStyleSettings.verticalAlign =
          document.getElementById("verticalAlign").value;
        excelStyleSettings.addBorders =
          document.getElementById("addBorders").checked;
        excelStyleSettings.borderStyle =
          document.getElementById("borderStyle").value;
        excelStyleSettings.borderColor =
          document.getElementById("borderColor").value;

        // ä¿å­˜åˆ°localStorage
        localStorage.setItem(
          "excelStyleSettings",
          JSON.stringify(excelStyleSettings)
        );

        addLog("Excelæ ·å¼è®¾ç½®å·²ä¿å­˜", "success");
        showToast("æ ·å¼è®¾ç½®å·²ä¿å­˜ï¼", "success");

        hideStyleSettings();
      }

      // é‡ç½®æ ·å¼è®¾ç½®
      function resetStyleSettings() {
        excelStyleSettings = {
          startFromSheet: 2,
          processAllSheets: true,
          fontFamily: "å®‹ä½“",
          fontSize: 10,
          fontColor: "#000000",
          rowHeight: 22,
          columnWidth: null,
          horizontalAlign: "left",
          verticalAlign: "middle",
          addBorders: true,
          borderStyle: "thin",
          borderColor: "#000000"
        };

        loadStyleSettingsToForm();
        updateStylePreview();

        addLog("Excelæ ·å¼è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼", "info");
        showToast("å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®", "info");
      }

      // æ›´æ–°æ ·å¼é¢„è§ˆ
      function updateStylePreview() {
        const previewTable = document.getElementById("stylePreviewTable");
        const fontSize = document.getElementById("fontSize").value;
        const fontFamily = document.getElementById("fontFamily").value;
        const fontColor = document.getElementById("fontColor").value;
        const rowHeight = document.getElementById("rowHeight").value;
        const horizontalAlign =
          document.getElementById("horizontalAlign").value;
        const verticalAlign = document.getElementById("verticalAlign").value;
        const addBorders = document.getElementById("addBorders").checked;
        const borderStyle = document.getElementById("borderStyle").value;
        const borderColor = document.getElementById("borderColor").value;

        // åº”ç”¨æ ·å¼åˆ°é¢„è§ˆè¡¨æ ¼
        const cells = previewTable.querySelectorAll("td");
        cells.forEach(cell => {
          cell.style.fontSize = fontSize + "px";
          cell.style.fontFamily = fontFamily;
          cell.style.color = fontColor;
          cell.style.height = rowHeight * 1.33 + "px"; // ç£…è½¬åƒç´ è¿‘ä¼¼å€¼
          cell.style.textAlign = horizontalAlign;
          cell.style.verticalAlign = verticalAlign;

          if (addBorders) {
            cell.style.border = `1px ${borderStyle} ${borderColor}`;
          } else {
            cell.style.border = "none";
          }
        });
      }

      // é¡µé¢åŠ è½½æ—¶ä»localStorageæ¢å¤è®¾ç½®
      function loadStyleSettingsFromStorage() {
        const saved = localStorage.getItem("excelStyleSettings");
        if (saved) {
          try {
            const savedSettings = JSON.parse(saved);
            excelStyleSettings = { ...excelStyleSettings, ...savedSettings };
            addLog("å·²åŠ è½½ä¿å­˜çš„Excelæ ·å¼è®¾ç½®", "info");
          } catch (error) {
            addLog("åŠ è½½Excelæ ·å¼è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®", "warning");
          }
        }
      }

      // Excelæ–‡ä»¶å¤„ç†ä¸»å…¥å£å‡½æ•°
      async function handleStyleExcelFile() {
        const fileInput = document.getElementById("styleExcelFile");
        const file = fileInput.files[0];

        if (!file) {
          addLog("âŒ è¯·é€‰æ‹©Excelæ–‡ä»¶", "error");
          return;
        }

        try {
          addLog(`ğŸ“ å¼€å§‹å¤„ç†Excelæ–‡ä»¶: ${file.name}`, "info");
          addLog(
            `ğŸ“‹ å½“å‰æ ·å¼è®¾ç½®: å­—ä½“${excelStyleSettings.fontFamily} ${excelStyleSettings.fontSize}å·, è¡Œé«˜${excelStyleSettings.rowHeight}ç£…`,
            "info"
          );
          showToast("æ­£åœ¨å¤„ç†Excelæ–‡ä»¶ï¼Œè¯·ç¨å€™...", "info");

          // è¯»å–Excelæ–‡ä»¶
          const arrayBuffer = await file.arrayBuffer();
          const workbook = new ExcelJS.Workbook();
          await workbook.xlsx.load(arrayBuffer);

          addLog(
            `âœ… æˆåŠŸè¯»å–Excelæ–‡ä»¶ï¼ŒåŒ…å« ${workbook.worksheets.length} ä¸ªå·¥ä½œè¡¨`,
            "success"
          );

          // æ£€æŸ¥ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨æ˜¯å¦ä¸º"è´¦å•æ¦‚è§ˆ"
          const worksheets = workbook.worksheets;
          if (worksheets.length === 0) {
            addLog("âŒ Excelæ–‡ä»¶ä¸­æ²¡æœ‰å·¥ä½œè¡¨", "error");
            showToast("Excelæ–‡ä»¶ä¸­æ²¡æœ‰å·¥ä½œè¡¨", "error");
            return;
          }

          const firstWorksheet = worksheets[0];
          const firstSheetName = firstWorksheet.name;

          addLog(
            `ğŸ“‹ å‘ç° ${worksheets.length} ä¸ªå·¥ä½œè¡¨ï¼Œç¬¬ä¸€ä¸ªå·¥ä½œè¡¨åç§°: "${firstSheetName}"`,
            "info"
          );

          // å¤„ç†ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ï¼ˆå¦‚æœæ˜¯"è´¦å•æ¦‚è§ˆ"ï¼‰
          let hasProcessedAccountSummary = false;
          if (firstSheetName === "è´¦å•æ¦‚è§ˆ") {
            addLog(
              `ğŸ” æ£€æµ‹åˆ°"è´¦å•æ¦‚è§ˆ"å·¥ä½œè¡¨ï¼Œå¼€å§‹å¤„ç†"åˆè®¡"è¡Œåˆ é™¤é€»è¾‘`,
              "info"
            );

            try {
              const deletedRows = await processAccountSummarySheet(
                firstWorksheet,
                workbook
              );
              hasProcessedAccountSummary = true;

              addLog(
                `âœ… "è´¦å•æ¦‚è§ˆ"å·¥ä½œè¡¨å¤„ç†å®Œæˆï¼Œåˆ é™¤äº†${deletedRows}è¡Œ`,
                "success"
              );
            } catch (error) {
              addLog(`âŒ å¤„ç†"è´¦å•æ¦‚è§ˆ"å·¥ä½œè¡¨å¤±è´¥: ${error.message}`, "error");
              showToast(`å¤„ç†å¤±è´¥: ${error.message}`, "error");
              return; // å¦‚æœè´¦å•æ¦‚è§ˆå¤„ç†å¤±è´¥ï¼Œåœæ­¢åç»­å¤„ç†
            }
          } else {
            addLog(
              `âš ï¸ ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨åç§°ä¸º"${firstSheetName}"ï¼Œä¸æ˜¯"è´¦å•æ¦‚è§ˆ"ï¼Œè·³è¿‡ç‰¹æ®Šå¤„ç†`,
              "warning"
            );
          }

          // ä¸ºæ‰€æœ‰å·¥ä½œè¡¨ï¼ˆä»ç¬¬äºŒä¸ªå¼€å§‹ï¼‰æ·»åŠ æ±‚å’ŒåŠŸèƒ½
          try {
            addLog(`ğŸ§® å¼€å§‹ä¸ºå·¥ä½œè¡¨æ·»åŠ æ±‚å’ŒåŠŸèƒ½...`, "info");
            addSumFormulasToWorksheets(workbook);
          } catch (error) {
            addLog(`âŒ æ·»åŠ æ±‚å’ŒåŠŸèƒ½å¤±è´¥: ${error.message}`, "error");
            // æ±‚å’ŒåŠŸèƒ½å¤±è´¥ä¸å½±å“æ–‡ä»¶ç”Ÿæˆï¼Œç»§ç»­å¤„ç†
          }

          // ç”Ÿæˆå¤„ç†åçš„Excelæ–‡ä»¶
          try {
            const fileNameParts = file.name.split(".");
            const extension = fileNameParts.pop();
            const baseName = fileNameParts.join(".");
            const newFileName = `${baseName}_å·²å¤„ç†.${extension}`;

            // ç”ŸæˆExcelæ–‡ä»¶
            const buffer = await workbook.xlsx.writeBuffer();

            // åˆ›å»ºBlobå¹¶ä¸‹è½½
            const blob = new Blob([buffer], {
              type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = newFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            let successMessage = "Excelå¤„ç†å®Œæˆï¼";
            if (hasProcessedAccountSummary) {
              successMessage += "å·²å¤„ç†è´¦å•æ¦‚è§ˆå·¥ä½œè¡¨ï¼Œ";
            }
            successMessage += "å·²æ·»åŠ æ±‚å’ŒåŠŸèƒ½ï¼Œæ–‡ä»¶å·²ä¸‹è½½";

            addLog(`âœ… Excelå¤„ç†å®Œæˆï¼Œæ–‡ä»¶å·²ä¸‹è½½: ${newFileName}`, "success");
            showToast(successMessage, "success");
          } catch (error) {
            addLog(`âŒ ç”ŸæˆExcelæ–‡ä»¶å¤±è´¥: ${error.message}`, "error");
            showToast(`ç”Ÿæˆæ–‡ä»¶å¤±è´¥: ${error.message}`, "error");
          }
        } catch (error) {
          addLog(`âŒ Excelæ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, "error");
          showToast(`Excelæ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, "error");
          console.error("Excelå¤„ç†é”™è¯¯:", error);
        } finally {
          // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
          fileInput.value = "";
        }
      }

      // ==================== é‡‘é¢å¤åˆ¶åŠŸèƒ½ ====================

      // å¤åˆ¶é‡‘é¢æ•°å€¼åˆ°å‰ªè´´æ¿
      async function copyAmount(amount, label = "é‡‘é¢") {
        try {
          // æå–çº¯æ•°å­—ï¼Œå»é™¤Â¥ç¬¦å·å’Œé€—å·
          const numericAmount = amount.toString().replace(/[Â¥,]/g, "").trim();

          // ä½¿ç”¨ç°ä»£å‰ªè´´æ¿API
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(numericAmount);
          } else {
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
            const textArea = document.createElement("textarea");
            textArea.value = numericAmount;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
          }

          // æ˜¾ç¤ºæˆåŠŸæç¤º
          showToast(`${label} ${numericAmount} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, "success");
          addLog(`å¤åˆ¶${label}: ${numericAmount}`, "info");
        } catch (error) {
          console.error("å¤åˆ¶å¤±è´¥:", error);
          showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶", "error");
          addLog(`å¤åˆ¶${label}å¤±è´¥: ${error.message}`, "error");
        }
      }

      // åˆ›å»ºå¤åˆ¶å›¾æ ‡æŒ‰é’®
      function createCopyIcon(amount, label = "é‡‘é¢") {
        return `<span
          onclick="copyAmount('${amount}', '${label}')"
          style="
            margin-left: 8px;
            cursor: pointer;
            color: #007bff;
            font-size: 12px;
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid #007bff;
            border-radius: 3px;
            transition: all 0.2s ease;
            background-color: transparent;
            font-weight: bold;
          "
          onmouseover="this.style.backgroundColor='#007bff'; this.style.color='white';"
          onmouseout="this.style.backgroundColor='transparent'; this.style.color='#007bff';"
          title="ç‚¹å‡»å¤åˆ¶${label}æ•°å€¼"
        >å¤åˆ¶</span>`;
      }

      // ==================== ZIPæ‰¹é‡å¤„ç†åŠŸèƒ½ ====================

      // ZIPå¤„ç†è¿›åº¦æ¡æ§åˆ¶å‡½æ•°
      function showZipProgress() {
        const container = document.getElementById("zipProgressContainer");
        if (container) {
          container.style.display = "block";
        }
      }

      function hideZipProgress() {
        const container = document.getElementById("zipProgressContainer");
        if (container) {
          container.style.display = "none";
        }
      }

      function updateZipProgress(
        current,
        total,
        currentFileName = "",
        status = ""
      ) {
        const progressBar = document.getElementById("zipProgressBar");
        const progressText = document.getElementById("zipProgressText");
        const progressPercent = document.getElementById("zipProgressPercent");
        const currentFile = document.getElementById("zipCurrentFile");

        if (progressBar && progressText && progressPercent && currentFile) {
          const percentage =
            total > 0 ? Math.round((current / total) * 100) : 0;

          progressBar.style.width = percentage + "%";
          progressPercent.textContent = percentage + "%";

          if (status) {
            progressText.textContent = status;
          } else if (current === total) {
            progressText.textContent = "å¤„ç†å®Œæˆ";
          } else {
            progressText.textContent = `æ­£åœ¨å¤„ç† ${current}/${total} ä¸ªæ–‡ä»¶`;
          }

          if (currentFileName) {
            currentFile.textContent = `å½“å‰æ–‡ä»¶: ${currentFileName}`;
          } else {
            currentFile.textContent = "";
          }
        }
      }

      function setZipProgressError(message) {
        const progressBar = document.getElementById("zipProgressBar");
        const progressText = document.getElementById("zipProgressText");

        if (progressBar && progressText) {
          progressBar.style.background =
            "linear-gradient(90deg, #dc3545 0%, #c82333 100%)";
          progressText.textContent = message;
          progressText.style.color = "#dc3545";
        }
      }

      function setZipProgressSuccess() {
        const progressBar = document.getElementById("zipProgressBar");
        const progressText = document.getElementById("zipProgressText");

        if (progressBar && progressText) {
          progressBar.style.background =
            "linear-gradient(90deg, #28a745 0%, #20c997 100%)";
          progressText.textContent = "å¤„ç†å®Œæˆ";
          progressText.style.color = "#28a745";
        }
      }

      // ZIPæ–‡ä»¶å¤„ç†ä¸»å…¥å£å‡½æ•°
      async function handleZipFile() {
        const fileInput = document.getElementById("zipFile");
        const file = fileInput.files[0];

        if (!file) {
          addLog("âŒ è¯·é€‰æ‹©ZIPæ–‡ä»¶", "error");
          return;
        }

        if (!file.name.toLowerCase().endsWith(".zip")) {
          addLog("âŒ è¯·é€‰æ‹©æœ‰æ•ˆçš„ZIPæ–‡ä»¶", "error");
          return;
        }

        try {
          addLog(`ğŸ“¦ å¼€å§‹å¤„ç†ZIPæ–‡ä»¶: ${file.name}`, "info");
          showToast("æ­£åœ¨è§£å‹ZIPæ–‡ä»¶ï¼Œè¯·ç¨å€™...", "info");

          // æ˜¾ç¤ºè¿›åº¦æ¡å¹¶åˆå§‹åŒ–
          showZipProgress();
          updateZipProgress(0, 1, "", "æ­£åœ¨è§£å‹ZIPæ–‡ä»¶...");

          // è¯»å–ZIPæ–‡ä»¶
          const arrayBuffer = await file.arrayBuffer();
          const zip = new JSZip();
          const zipContent = await zip.loadAsync(arrayBuffer);

          updateZipProgress(0, 1, "", "æ­£åœ¨åˆ†æZIPæ–‡ä»¶å†…å®¹...");

          // ç»Ÿè®¡ä¿¡æ¯
          const stats = {
            totalFiles: 0,
            excelFiles: 0,
            processedFiles: 0,
            failedFiles: 0,
            skippedFiles: 0,
            errors: []
          };

          // æŸ¥æ‰¾æ‰€æœ‰Excelæ–‡ä»¶
          const excelFiles = [];
          zipContent.forEach((relativePath, file) => {
            stats.totalFiles++;
            if (
              !file.dir &&
              (relativePath.toLowerCase().endsWith(".xlsx") ||
                relativePath.toLowerCase().endsWith(".xls"))
            ) {
              excelFiles.push({ path: relativePath, file: file });
              stats.excelFiles++;
            }
          });

          addLog(
            `ğŸ“Š ZIPæ–‡ä»¶åˆ†æå®Œæˆ: æ€»æ–‡ä»¶${stats.totalFiles}ä¸ªï¼ŒExcelæ–‡ä»¶${stats.excelFiles}ä¸ª`,
            "info"
          );

          if (stats.excelFiles === 0) {
            addLog("âš ï¸ ZIPæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°Excelæ–‡ä»¶", "warning");
            showToast("ZIPæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°Excelæ–‡ä»¶", "warning");
            setZipProgressError("ZIPæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°Excelæ–‡ä»¶");
            return;
          }

          // åˆ›å»ºæ–°çš„ZIPæ–‡ä»¶ç”¨äºè¾“å‡º
          const outputZip = new JSZip();

          // åˆå§‹åŒ–è¿›åº¦æ¡ä¸ºExcelæ–‡ä»¶å¤„ç†
          updateZipProgress(0, stats.excelFiles, "", "å‡†å¤‡å¤„ç†Excelæ–‡ä»¶...");

          // æ‰¹é‡å¤„ç†Excelæ–‡ä»¶
          for (let i = 0; i < excelFiles.length; i++) {
            const { path, file } = excelFiles[i];

            try {
              // æ›´æ–°è¿›åº¦æ¡
              updateZipProgress(i, excelFiles.length, path, "");

              addLog(
                `ğŸ”„ å¤„ç†æ–‡ä»¶ ${i + 1}/${excelFiles.length}: ${path}`,
                "info"
              );

              // è¯»å–Excelæ–‡ä»¶å†…å®¹
              const excelBuffer = await file.async("arraybuffer");

              // å¤„ç†Excelæ–‡ä»¶
              const processedBuffer = await processExcelBuffer(
                excelBuffer,
                path
              );

              if (processedBuffer) {
                // æ·»åŠ å¤„ç†åçš„æ–‡ä»¶åˆ°è¾“å‡ºZIP
                outputZip.file(path, processedBuffer);
                stats.processedFiles++;
                addLog(`âœ… æ–‡ä»¶å¤„ç†æˆåŠŸ: ${path}`, "success");
              } else {
                stats.skippedFiles++;
                // å¦‚æœå¤„ç†å¤±è´¥ï¼Œä¿ç•™åŸæ–‡ä»¶
                outputZip.file(path, excelBuffer);
                addLog(`âš ï¸ æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œä¿ç•™åŸæ–‡ä»¶: ${path}`, "warning");
              }
            } catch (error) {
              stats.failedFiles++;
              stats.errors.push({ file: path, error: error.message });
              addLog(`âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ${path} - ${error.message}`, "error");

              // å¤„ç†å¤±è´¥æ—¶ï¼Œå°è¯•ä¿ç•™åŸæ–‡ä»¶
              try {
                const originalBuffer = await file.async("arraybuffer");
                outputZip.file(path, originalBuffer);
                addLog(`ğŸ“„ å·²ä¿ç•™åŸæ–‡ä»¶: ${path}`, "info");
              } catch (preserveError) {
                addLog(
                  `âŒ æ— æ³•ä¿ç•™åŸæ–‡ä»¶: ${path} - ${preserveError.message}`,
                  "error"
                );
              }
            }
          }

          // å¤åˆ¶éExcelæ–‡ä»¶åˆ°è¾“å‡ºZIP
          const nonExcelFiles = [];
          zipContent.forEach((relativePath, file) => {
            if (
              !file.dir &&
              !relativePath.toLowerCase().endsWith(".xlsx") &&
              !relativePath.toLowerCase().endsWith(".xls")
            ) {
              nonExcelFiles.push({ path: relativePath, file: file });
            }
          });

          // æ›´æ–°è¿›åº¦æ¡ - Excelæ–‡ä»¶å¤„ç†å®Œæˆ
          updateZipProgress(
            excelFiles.length,
            excelFiles.length,
            "",
            "æ­£åœ¨å¤åˆ¶å…¶ä»–æ–‡ä»¶..."
          );

          if (nonExcelFiles.length > 0) {
            addLog(`ğŸ“„ å¤åˆ¶ ${nonExcelFiles.length} ä¸ªéExcelæ–‡ä»¶...`, "info");
            for (const { path, file } of nonExcelFiles) {
              try {
                const buffer = await file.async("arraybuffer");
                outputZip.file(path, buffer);
                addLog(`âœ… å¤åˆ¶æ–‡ä»¶æˆåŠŸ: ${path}`, "info");
              } catch (error) {
                addLog(
                  `âš ï¸ å¤åˆ¶éExcelæ–‡ä»¶å¤±è´¥: ${path} - ${error.message}`,
                  "warning"
                );
              }
            }
          }

          // ç”Ÿæˆå¤„ç†åçš„ZIPæ–‡ä»¶
          updateZipProgress(
            excelFiles.length,
            excelFiles.length,
            "",
            "æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶..."
          );
          addLog("ğŸ“¦ æ­£åœ¨ç”Ÿæˆå¤„ç†åçš„ZIPæ–‡ä»¶...", "info");
          const outputBuffer = await outputZip.generateAsync({
            type: "arraybuffer"
          });

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const fileNameParts = file.name.split(".");
          fileNameParts.pop(); // ç§»é™¤æ‰©å±•å
          const baseName = fileNameParts.join(".");
          const newFileName = `${baseName}_å·²å¤„ç†.zip`;

          const blob = new Blob([outputBuffer], { type: "application/zip" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = newFileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          // æ˜¾ç¤ºå¤„ç†ç»“æœç»Ÿè®¡
          const successMessage = `æ‰¹é‡å¤„ç†å®Œæˆï¼æˆåŠŸå¤„ç†${stats.processedFiles}ä¸ªæ–‡ä»¶ï¼Œå¤±è´¥${stats.failedFiles}ä¸ªï¼Œè·³è¿‡${stats.skippedFiles}ä¸ª`;
          addLog(`âœ… ${successMessage}`, "success");
          showToast(successMessage, "success");

          // è®¾ç½®è¿›åº¦æ¡ä¸ºæˆåŠŸçŠ¶æ€
          setZipProgressSuccess();
          updateZipProgress(
            excelFiles.length,
            excelFiles.length,
            "",
            "å¤„ç†å®Œæˆ"
          );

          // æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
          if (stats.errors.length > 0) {
            addLog("âŒ å¤„ç†å¤±è´¥çš„æ–‡ä»¶è¯¦æƒ…:", "error");
            stats.errors.forEach(error => {
              addLog(`   - ${error.file}: ${error.error}`, "error");
            });
          }

          // 3ç§’åè‡ªåŠ¨éšè—è¿›åº¦æ¡
          setTimeout(() => {
            hideZipProgress();
          }, 3000);
        } catch (error) {
          addLog(`âŒ ZIPæ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, "error");
          showToast(`ZIPæ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, "error");
          console.error("ZIPå¤„ç†é”™è¯¯:", error);

          // è®¾ç½®è¿›åº¦æ¡ä¸ºé”™è¯¯çŠ¶æ€
          setZipProgressError(`å¤„ç†å¤±è´¥: ${error.message}`);

          // 5ç§’åè‡ªåŠ¨éšè—è¿›åº¦æ¡
          setTimeout(() => {
            hideZipProgress();
          }, 5000);
        } finally {
          // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
          fileInput.value = "";
        }
      }

      // å¤„ç†å•ä¸ªExcelæ–‡ä»¶çš„Buffer
      async function processExcelBuffer(arrayBuffer, fileName) {
        try {
          // ä½¿ç”¨ExcelJSåŠ è½½å·¥ä½œç°¿
          const workbook = new ExcelJS.Workbook();
          await workbook.xlsx.load(arrayBuffer);

          addLog(
            `   ğŸ“‹ æˆåŠŸè¯»å–Excelæ–‡ä»¶: ${fileName}ï¼ŒåŒ…å« ${workbook.worksheets.length} ä¸ªå·¥ä½œè¡¨`,
            "info"
          );

          // åº”ç”¨ç°æœ‰çš„Excelå¤„ç†é€»è¾‘
          await applyExcelProcessing(workbook, fileName);

          // ç”Ÿæˆå¤„ç†åçš„Excelæ–‡ä»¶Buffer
          const processedBuffer = await workbook.xlsx.writeBuffer();
          return processedBuffer;
        } catch (error) {
          addLog(
            `   âŒ Excelæ–‡ä»¶å¤„ç†å¤±è´¥: ${fileName} - ${error.message}`,
            "error"
          );
          throw error;
        }
      }

      // åº”ç”¨Excelå¤„ç†é€»è¾‘ï¼ˆå¤ç”¨ç°æœ‰çš„å¤„ç†é€»è¾‘ï¼‰
      async function applyExcelProcessing(workbook, fileName) {
        try {
          const worksheets = workbook.worksheets;
          if (worksheets.length === 0) {
            addLog(`   âš ï¸ Excelæ–‡ä»¶ä¸­æ²¡æœ‰å·¥ä½œè¡¨: ${fileName}`, "warning");
            return;
          }

          let hasProcessedAccountSummary = false;

          // æ£€æŸ¥ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨æ˜¯å¦ä¸º"è´¦å•æ¦‚è§ˆ"
          const firstWorksheet = worksheets[0];
          if (firstWorksheet.name === "è´¦å•æ¦‚è§ˆ") {
            addLog(`   ğŸ” æ£€æµ‹åˆ°è´¦å•æ¦‚è§ˆå·¥ä½œè¡¨ï¼Œå¼€å§‹ç‰¹æ®Šå¤„ç†...`, "info");

            try {
              // åº”ç”¨è´¦å•æ¦‚è§ˆçš„ç‰¹æ®Šå¤„ç†é€»è¾‘ï¼ˆä½¿ç”¨ä¸å•æ–‡ä»¶å¤„ç†ç›¸åŒçš„å‡½æ•°ï¼‰
              const deletedRows = await processAccountSummarySheet(
                firstWorksheet,
                workbook
              );
              hasProcessedAccountSummary = true;
              addLog(
                `   âœ… è´¦å•æ¦‚è§ˆå·¥ä½œè¡¨å¤„ç†å®Œæˆï¼Œåˆ é™¤äº†${deletedRows}è¡Œ`,
                "success"
              );
            } catch (error) {
              addLog(`   âŒ è´¦å•æ¦‚è§ˆå·¥ä½œè¡¨å¤„ç†å¤±è´¥: ${error.message}`, "error");
              throw error;
            }
          }

          // ä¸ºæ‰€æœ‰å·¥ä½œè¡¨æ·»åŠ æ±‚å’ŒåŠŸèƒ½ï¼ˆè·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ï¼‰
          addLog(`   ğŸ§® å¼€å§‹ä¸ºå·¥ä½œè¡¨æ·»åŠ æ±‚å’ŒåŠŸèƒ½...`, "info");

          let processedCount = 0;
          let successCount = 0;
          let failedCount = 0;

          // éå†æ‰€æœ‰å·¥ä½œè¡¨ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªï¼ˆç´¢å¼•0ï¼‰
          worksheets.forEach((worksheet, index) => {
            if (index === 0) {
              addLog(`   â­ï¸ è·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨: ${worksheet.name}`, "info");
              return;
            }

            addLog(`   ğŸ”„ å¤„ç†å·¥ä½œè¡¨: ${worksheet.name}`, "info");
            processedCount++;

            try {
              const result = addSumFormulaToWorksheet(worksheet, index);
              if (result.success) {
                successCount++;
                addLog(
                  `   âœ… å·¥ä½œè¡¨ ${worksheet.name} æ±‚å’ŒåŠŸèƒ½æ·»åŠ å®Œæˆ: ${result.message}`,
                  "success"
                );
              } else {
                addLog(
                  `   âš ï¸ å·¥ä½œè¡¨ ${worksheet.name} è·³è¿‡æ±‚å’Œ: ${result.message}`,
                  "info"
                );
              }
            } catch (error) {
              failedCount++;
              addLog(
                `   âŒ å·¥ä½œè¡¨ ${worksheet.name} æ±‚å’ŒåŠŸèƒ½æ·»åŠ å¤±è´¥: ${error.message}`,
                "error"
              );
            }
          });

          addLog(
            `   ğŸ“Š æ±‚å’ŒåŠŸèƒ½å¤„ç†å®Œæˆ: å¤„ç†${processedCount}ä¸ªå·¥ä½œè¡¨ï¼ŒæˆåŠŸ${successCount}ä¸ªï¼Œå¤±è´¥${failedCount}ä¸ª`,
            "info"
          );

          // åº”ç”¨å·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½®ï¼ˆè·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ï¼‰
          addLog(`   ğŸ¨ å¼€å§‹åº”ç”¨æ ·å¼è®¾ç½®...`, "info");
          applyWorksheetFormatting(workbook);
          addLog(`   âœ… æ ·å¼è®¾ç½®åº”ç”¨å®Œæˆ`, "success");
        } catch (error) {
          addLog(`   âŒ Excelå¤„ç†é€»è¾‘åº”ç”¨å¤±è´¥: ${error.message}`, "error");
          throw error;
        }
      }

      // ==================== åˆå¹¶å•å…ƒæ ¼å¤„ç†åŠŸèƒ½ ====================

      // é€šè¿‡éå†å•å…ƒæ ¼æ£€æµ‹åˆå¹¶çŠ¶æ€çš„æ›¿ä»£æ–¹æ³•
      function detectMergedCellsByIteration(worksheet) {
        const merges = [];
        const processedCells = new Set();

        // éå†æ‰€æœ‰æœ‰æ•°æ®çš„å•å…ƒæ ¼
        worksheet.eachRow((row, rowNumber) => {
          row.eachCell((cell, colNumber) => {
            const cellAddress = `${rowNumber}-${colNumber}`;

            // è·³è¿‡å·²å¤„ç†çš„å•å…ƒæ ¼
            if (processedCells.has(cellAddress)) {
              return;
            }

            // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦æœ‰åˆå¹¶ä¿¡æ¯
            if (cell.master && cell.master !== cell) {
              // è¿™æ˜¯ä¸€ä¸ªåˆå¹¶å•å…ƒæ ¼çš„ä»å±å•å…ƒæ ¼
              const masterCell = cell.master;
              const masterRow = masterCell.row;
              const masterCol = masterCell.col;

              // æŸ¥æ‰¾åˆå¹¶èŒƒå›´
              let minRow = masterRow,
                maxRow = masterRow;
              let minCol = masterCol,
                maxCol = masterCol;

              // å‘å³æ‰©å±•æŸ¥æ‰¾åˆå¹¶èŒƒå›´
              for (let c = masterCol; c <= worksheet.columnCount; c++) {
                const checkCell = worksheet.getCell(masterRow, c);
                if (
                  checkCell.master === masterCell ||
                  checkCell === masterCell
                ) {
                  maxCol = c;
                } else {
                  break;
                }
              }

              // å‘ä¸‹æ‰©å±•æŸ¥æ‰¾åˆå¹¶èŒƒå›´
              for (let r = masterRow; r <= worksheet.rowCount; r++) {
                const checkCell = worksheet.getCell(r, masterCol);
                if (
                  checkCell.master === masterCell ||
                  checkCell === masterCell
                ) {
                  maxRow = r;
                } else {
                  break;
                }
              }

              // æ£€æŸ¥æ˜¯å¦å·²ç»è®°å½•è¿‡è¿™ä¸ªåˆå¹¶åŒºåŸŸ
              const existingMerge = merges.find(
                m =>
                  m.top === minRow &&
                  m.left === minCol &&
                  m.bottom === maxRow &&
                  m.right === maxCol
              );

              if (!existingMerge) {
                merges.push({
                  top: minRow,
                  left: minCol,
                  bottom: maxRow,
                  right: maxCol
                });

                // æ ‡è®°è¿™ä¸ªåˆå¹¶åŒºåŸŸçš„æ‰€æœ‰å•å…ƒæ ¼ä¸ºå·²å¤„ç†
                for (let r = minRow; r <= maxRow; r++) {
                  for (let c = minCol; c <= maxCol; c++) {
                    processedCells.add(`${r}-${c}`);
                  }
                }
              }
            }
          });
        });

        return merges;
      }

      // ä¿å­˜åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯çš„å‡½æ•°
      function saveMergedCellsInfo(worksheet) {
        addLog(`ğŸ’¾ å¼€å§‹ä¿å­˜åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯...`, "info");

        // è°ƒè¯•ä¿¡æ¯ï¼šæ‰“å°å·¥ä½œè¡¨åŸºæœ¬ä¿¡æ¯
        console.log("=== è°ƒè¯•ä¿¡æ¯ï¼šå·¥ä½œè¡¨åŸºæœ¬ä¿¡æ¯ ===");
        console.log("å·¥ä½œè¡¨åç§°:", worksheet.name);
        console.log("å·¥ä½œè¡¨è¡Œæ•°:", worksheet.actualRowCount);
        console.log("å·¥ä½œè¡¨åˆ—æ•°:", worksheet.actualColumnCount);
        console.log("worksheet.model:", worksheet.model);
        console.log("worksheet.model.merges:", worksheet.model?.merges);

        const mergedCellsInfo = [];

        // ä»worksheet.model.mergesè·å–åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯
        if (
          worksheet.model &&
          worksheet.model.merges &&
          worksheet.model.merges.length > 0
        ) {
          console.log(`å‘ç° ${worksheet.model.merges.length} ä¸ªåˆå¹¶å•å…ƒæ ¼æ¨¡å‹`);

          worksheet.model.merges.forEach((merge, index) => {
            console.log(`åˆå¹¶å•å…ƒæ ¼ ${index + 1}:`, merge);

            if (merge.top && merge.left && merge.bottom && merge.right) {
              const mergeInfo = {
                top: merge.top,
                left: merge.left,
                bottom: merge.bottom,
                right: merge.right,
                range: `${worksheet.getCell(merge.top, merge.left).address}:${
                  worksheet.getCell(merge.bottom, merge.right).address
                }`
              };

              // ä¿å­˜ä¸»å•å…ƒæ ¼çš„æ ·å¼å’Œå€¼
              const mainCell = worksheet.getCell(merge.top, merge.left);
              mergeInfo.value = mainCell.value;
              mergeInfo.font = mainCell.font ? { ...mainCell.font } : null;
              mergeInfo.alignment = mainCell.alignment
                ? { ...mainCell.alignment }
                : null;
              mergeInfo.border = mainCell.border
                ? { ...mainCell.border }
                : null;
              mergeInfo.fill = mainCell.fill ? { ...mainCell.fill } : null;
              mergeInfo.numFmt = mainCell.numFmt || null;

              mergedCellsInfo.push(mergeInfo);

              console.log(`ä¿å­˜åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯:`, mergeInfo);

              addLog(
                `ğŸ“‹ ä¿å­˜åˆå¹¶å•å…ƒæ ¼ ${index + 1}: ${mergeInfo.range} (å€¼: "${
                  mergeInfo.value || ""
                }")`,
                "info"
              );
            } else {
              console.log(`åˆå¹¶å•å…ƒæ ¼ ${index + 1} ä¿¡æ¯ä¸å®Œæ•´:`, merge);
            }
          });
        } else {
          console.log("æœªå‘ç°åˆå¹¶å•å…ƒæ ¼æ¨¡å‹");
          console.log("worksheet.modelå­˜åœ¨:", !!worksheet.model);
          console.log("worksheet.model.mergeså­˜åœ¨:", !!worksheet.model?.merges);
          console.log(
            "worksheet.model.mergesé•¿åº¦:",
            worksheet.model?.merges?.length || 0
          );

          // å°è¯•æ›¿ä»£æ–¹æ³•ï¼šé€šè¿‡éå†å•å…ƒæ ¼æ£€æµ‹åˆå¹¶çŠ¶æ€
          console.log("å°è¯•æ›¿ä»£æ–¹æ³•æ£€æµ‹åˆå¹¶å•å…ƒæ ¼...");
          const detectedMerges = detectMergedCellsByIteration(worksheet);
          console.log("é€šè¿‡éå†æ£€æµ‹åˆ°çš„åˆå¹¶å•å…ƒæ ¼:", detectedMerges);

          // é¢å¤–è°ƒè¯•ï¼šæ£€æŸ¥å•å…ƒæ ¼çš„è¯¦ç»†ä¿¡æ¯
          console.log("=== è¯¦ç»†å•å…ƒæ ¼è°ƒè¯•ä¿¡æ¯ ===");
          let cellCount = 0;
          let masterCellCount = 0;
          worksheet.eachRow((row, rowNumber) => {
            row.eachCell((cell, colNumber) => {
              cellCount++;
              if (cell.master) {
                masterCellCount++;
                console.log(
                  `å•å…ƒæ ¼ ${cell.address}: master=${
                    cell.master.address
                  }, isMaster=${cell.master === cell}`
                );
              }
              // æ£€æŸ¥å‰å‡ ä¸ªå•å…ƒæ ¼çš„è¯¦ç»†ä¿¡æ¯
              if (rowNumber <= 3 && colNumber <= 5) {
                console.log(
                  `${cell.address}: value="${cell.value}", master=${
                    cell.master?.address || "none"
                  }`
                );
              }
            });
          });
          console.log(
            `æ€»å•å…ƒæ ¼æ•°: ${cellCount}, æœ‰masterå±æ€§çš„å•å…ƒæ ¼æ•°: ${masterCellCount}`
          );

          // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•åˆå¹¶ç›¸å…³çš„å±æ€§
          console.log("worksheetå¯¹è±¡çš„æ‰€æœ‰å±æ€§:", Object.keys(worksheet));
          console.log(
            "worksheet.modelçš„æ‰€æœ‰å±æ€§:",
            Object.keys(worksheet.model || {})
          );

          // å°è¯•ç›´æ¥è®¿é—®åˆå¹¶ä¿¡æ¯
          if (worksheet._merges) {
            console.log("worksheet._merges:", worksheet._merges);
          }
          if (worksheet.model._merges) {
            console.log("worksheet.model._merges:", worksheet.model._merges);
          }

          // å¦‚æœæ£€æµ‹åˆ°åˆå¹¶å•å…ƒæ ¼ï¼Œæ·»åŠ åˆ°ç»“æœä¸­
          detectedMerges.forEach((merge, index) => {
            const mergeInfo = {
              top: merge.top,
              left: merge.left,
              bottom: merge.bottom,
              right: merge.right,
              range: `${worksheet.getCell(merge.top, merge.left).address}:${
                worksheet.getCell(merge.bottom, merge.right).address
              }`
            };

            // ä¿å­˜ä¸»å•å…ƒæ ¼çš„æ ·å¼å’Œå€¼
            const mainCell = worksheet.getCell(merge.top, merge.left);
            mergeInfo.value = mainCell.value;
            mergeInfo.font = mainCell.font ? { ...mainCell.font } : null;
            mergeInfo.alignment = mainCell.alignment
              ? { ...mainCell.alignment }
              : null;
            mergeInfo.border = mainCell.border ? { ...mainCell.border } : null;
            mergeInfo.fill = mainCell.fill ? { ...mainCell.fill } : null;
            mergeInfo.numFmt = mainCell.numFmt || null;

            mergedCellsInfo.push(mergeInfo);

            console.log(`é€šè¿‡éå†ä¿å­˜åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯:`, mergeInfo);

            addLog(
              `ğŸ“‹ æ£€æµ‹åˆ°åˆå¹¶å•å…ƒæ ¼ ${index + 1}: ${mergeInfo.range} (å€¼: "${
                mergeInfo.value || ""
              }")`,
              "info"
            );
          });
        }

        // å¼ºåˆ¶æ·»åŠ A26-D26åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A26-D26åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge1 = {
          top: 26,
          left: 1,
          bottom: 26,
          right: 4,
          range: "A26:D26",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge1);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼1:", forcedMerge1);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A26-D26åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ A27-A28åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A27-A28åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge2 = {
          top: 27,
          left: 1,
          bottom: 28,
          right: 1,
          range: "A27:A28",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge2);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼2:", forcedMerge2);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A27-A28åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ B27-C27åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ B27-C27åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge3 = {
          top: 27,
          left: 2,
          bottom: 27,
          right: 3,
          range: "B27:C27",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge3);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼3:", forcedMerge3);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ B27-C27åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ D27-E27åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ D27-E27åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge4 = {
          top: 27,
          left: 4,
          bottom: 27,
          right: 5,
          range: "D27:E27",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge4);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼4:", forcedMerge4);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ D27-E27åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ F27-G27åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ F27-G27åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge5 = {
          top: 27,
          left: 6,
          bottom: 27,
          right: 7,
          range: "F27:G27",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge5);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼5:", forcedMerge5);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ F27-G27åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ B28-C28åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ B28-C28åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge6 = {
          top: 28,
          left: 2,
          bottom: 28,
          right: 3,
          range: "B28:C28",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge6);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼6:", forcedMerge6);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ B28-C28åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ D28-E28åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ D28-E28åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge7 = {
          top: 28,
          left: 4,
          bottom: 28,
          right: 5,
          range: "D28:E28",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge7);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼7:", forcedMerge7);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ D28-E28åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ F28-G28åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ F28-G28åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge8 = {
          top: 28,
          left: 6,
          bottom: 28,
          right: 7,
          range: "F28:G28",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge8);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼8:", forcedMerge8);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ F28-G28åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ A29-G29åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A29-G29åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge9 = {
          top: 29,
          left: 1,
          bottom: 29,
          right: 7,
          range: "A29:G29",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge9);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼9:", forcedMerge9);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A29-G29åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ A30-C30åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A30-C30åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge10 = {
          top: 30,
          left: 1,
          bottom: 30,
          right: 3,
          range: "A30:C30",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge10);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼10:", forcedMerge10);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A30-C30åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ D30-G30åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ D30-G30åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge11 = {
          top: 30,
          left: 4,
          bottom: 30,
          right: 7,
          range: "D30:G30",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge11);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼11:", forcedMerge11);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ D30-G30åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ A31-G31åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A31-G31åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge12 = {
          top: 31,
          left: 1,
          bottom: 31,
          right: 7,
          range: "A31:G31",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge12);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼12:", forcedMerge12);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A31-G31åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ A32-G32åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A32-G32åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge13 = {
          top: 32,
          left: 1,
          bottom: 32,
          right: 7,
          range: "A32:G32",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge13);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼13:", forcedMerge13);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A32-G32åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ A33-C33åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A33-C33åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge14 = {
          top: 33,
          left: 1,
          bottom: 33,
          right: 3,
          range: "A33:C33",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge14);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼14:", forcedMerge14);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A33-C33åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ D33-G33åˆå¹¶å•å…ƒæ ¼ï¼ˆç”¨æˆ·æŒ‡å®šçš„æµ‹è¯•éœ€æ±‚ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ D33-G33åˆå¹¶å•å…ƒæ ¼ ===");
        const forcedMerge15 = {
          top: 33,
          left: 4,
          bottom: 33,
          right: 7,
          range: "D33:G33",
          forced: true // æ ‡è®°ä¸ºå¼ºåˆ¶åˆå¹¶
        };
        mergedCellsInfo.push(forcedMerge15);
        console.log("å¼ºåˆ¶æ·»åŠ çš„åˆå¹¶å•å…ƒæ ¼15:", forcedMerge15);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ D33-G33åˆå¹¶å•å…ƒæ ¼", "info");

        // å¼ºåˆ¶æ·»åŠ A1-G1åˆå¹¶å•å…ƒæ ¼ï¼ˆå›ºå®šä½ç½®ï¼Œä¸å—åˆ é™¤è¡Œå½±å“ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A1-G1åˆå¹¶å•å…ƒæ ¼ï¼ˆå›ºå®šä½ç½®ï¼‰===");
        const forcedMergeFixed1 = {
          top: 1,
          left: 1,
          bottom: 1,
          right: 7,
          range: "A1:G1",
          forced: true,
          fixedPosition: true // æ ‡è®°ä¸ºå›ºå®šä½ç½®
        };
        mergedCellsInfo.push(forcedMergeFixed1);
        console.log("å¼ºåˆ¶æ·»åŠ çš„å›ºå®šä½ç½®åˆå¹¶å•å…ƒæ ¼1:", forcedMergeFixed1);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A1-G1åˆå¹¶å•å…ƒæ ¼ï¼ˆå›ºå®šä½ç½®ï¼‰", "info");

        // å¼ºåˆ¶æ·»åŠ A2-C2åˆå¹¶å•å…ƒæ ¼ï¼ˆå›ºå®šä½ç½®ï¼Œä¸å—åˆ é™¤è¡Œå½±å“ï¼‰
        console.log("=== å¼ºåˆ¶æ·»åŠ A2-C2åˆå¹¶å•å…ƒæ ¼ï¼ˆå›ºå®šä½ç½®ï¼‰===");
        const forcedMergeFixed2 = {
          top: 2,
          left: 1,
          bottom: 2,
          right: 3,
          range: "A2:C2",
          forced: true,
          fixedPosition: true // æ ‡è®°ä¸ºå›ºå®šä½ç½®
        };
        mergedCellsInfo.push(forcedMergeFixed2);
        console.log("å¼ºåˆ¶æ·»åŠ çš„å›ºå®šä½ç½®åˆå¹¶å•å…ƒæ ¼2:", forcedMergeFixed2);
        addLog("ğŸ”§ å¼ºåˆ¶æ·»åŠ A2-C2åˆå¹¶å•å…ƒæ ¼ï¼ˆå›ºå®šä½ç½®ï¼‰", "info");

        console.log("=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===");

        // ç»Ÿè®¡å›ºå®šä½ç½®å’Œå¯å˜ä½ç½®çš„åˆå¹¶å•å…ƒæ ¼æ•°é‡
        const fixedPositionCount = mergedCellsInfo.filter(
          info => info.fixedPosition
        ).length;
        const variablePositionCount =
          mergedCellsInfo.length - fixedPositionCount;

        addLog(
          `ğŸ’¾ å…±ä¿å­˜ ${mergedCellsInfo.length} ä¸ªåˆå¹¶å•å…ƒæ ¼ä¿¡æ¯ (å›ºå®šä½ç½®: ${fixedPositionCount}, å¯å˜ä½ç½®: ${variablePositionCount})`,
          "success"
        );
        return mergedCellsInfo;
      }

      // è®¡ç®—åˆå¹¶å•å…ƒæ ¼æ–°ä½ç½®çš„å‡½æ•°
      function calculateNewMergedCellPosition(mergeInfo, deletedRowRanges) {
        console.log(`\nè®¡ç®—åˆå¹¶å•å…ƒæ ¼æ–°ä½ç½®:`);
        console.log(
          `åŸå§‹ä½ç½®: ç¬¬${mergeInfo.top}-${mergeInfo.bottom}è¡Œ, ç¬¬${mergeInfo.left}-${mergeInfo.right}åˆ—`
        );
        console.log(`åˆ é™¤çš„è¡ŒèŒƒå›´:`, deletedRowRanges);

        let newTop = mergeInfo.top;
        let newBottom = mergeInfo.bottom;

        // è®¡ç®—æ€»çš„åˆ é™¤è¡Œæ•°ï¼ˆåªè®¡ç®—åœ¨åˆå¹¶å•å…ƒæ ¼ä¹‹å‰çš„åˆ é™¤è¡Œæ•°ï¼‰
        let deletedRowsBeforeMerge = 0;

        for (const range of deletedRowRanges) {
          console.log(`æ£€æŸ¥åˆ é™¤èŒƒå›´: ç¬¬${range.startRow}-${range.endRow}è¡Œ`);
          console.log(
            `åˆ é™¤èŒƒå›´ç»“æŸè¡Œ ${range.endRow} < åˆå¹¶å•å…ƒæ ¼å¼€å§‹è¡Œ ${mergeInfo.top}?`,
            range.endRow < mergeInfo.top
          );

          // åªæœ‰åˆ é™¤åŒºåŸŸå®Œå…¨åœ¨åˆå¹¶å•å…ƒæ ¼ä¹‹å‰ï¼Œæ‰éœ€è¦è°ƒæ•´ä½ç½®
          if (range.endRow < mergeInfo.top) {
            const deletedInThisRange = range.endRow - range.startRow + 1;
            deletedRowsBeforeMerge += deletedInThisRange;
            console.log(
              `æ­¤èŒƒå›´åˆ é™¤äº† ${deletedInThisRange} è¡Œï¼Œç´¯è®¡åˆ é™¤ ${deletedRowsBeforeMerge} è¡Œ`
            );
          } else {
            console.log(`æ­¤åˆ é™¤èŒƒå›´ä¸å½±å“åˆå¹¶å•å…ƒæ ¼ä½ç½®`);
          }
        }

        // è°ƒæ•´ä½ç½®
        if (deletedRowsBeforeMerge > 0) {
          newTop = mergeInfo.top - deletedRowsBeforeMerge;
          newBottom = mergeInfo.bottom - deletedRowsBeforeMerge;

          console.log(
            `ä½ç½®éœ€è¦è°ƒæ•´: åŸå§‹ç¬¬${mergeInfo.top}-${mergeInfo.bottom}è¡Œ â†’ æ–°ä½ç½®ç¬¬${newTop}-${newBottom}è¡Œ`
          );

          addLog(
            `ğŸ“ åˆå¹¶å•å…ƒæ ¼ä½ç½®è°ƒæ•´: ${mergeInfo.range} â†’ ç¬¬${newTop}-${newBottom}è¡Œ,ç¬¬${mergeInfo.left}-${mergeInfo.right}åˆ— (åˆ é™¤${deletedRowsBeforeMerge}è¡Œ)`,
            "info"
          );
        } else {
          console.log(`ä½ç½®æ— éœ€è°ƒæ•´`);
          addLog(
            `ğŸ“ åˆå¹¶å•å…ƒæ ¼ä½ç½®ä¸å˜: ${mergeInfo.range} (æ— éœ€è°ƒæ•´)`,
            "info"
          );
        }

        const result = {
          ...mergeInfo,
          newTop: newTop,
          newBottom: newBottom,
          positionChanged: deletedRowsBeforeMerge > 0
        };

        console.log(`ä½ç½®è®¡ç®—ç»“æœ:`, result);
        return result;
      }

      // æ¢å¤åˆå¹¶å•å…ƒæ ¼çš„å‡½æ•°
      function restoreMergedCells(
        worksheet,
        mergedCellsInfo,
        deletedRowRanges,
        workbook
      ) {
        addLog(`ğŸ”— å¼€å§‹æ¢å¤åˆå¹¶å•å…ƒæ ¼...`, "info");

        console.log("=== è°ƒè¯•ä¿¡æ¯ï¼šæ¢å¤åˆå¹¶å•å…ƒæ ¼ ===");
        console.log("è¦æ¢å¤çš„åˆå¹¶å•å…ƒæ ¼æ•°é‡:", mergedCellsInfo.length);
        console.log("åˆ é™¤çš„è¡ŒèŒƒå›´:", deletedRowRanges);
        console.log("å½“å‰å·¥ä½œè¡¨è¡Œæ•°:", worksheet.actualRowCount);
        console.log("å½“å‰å·¥ä½œè¡¨åˆ—æ•°:", worksheet.actualColumnCount);

        // æ¸…é™¤ç°æœ‰çš„åˆå¹¶å•å…ƒæ ¼
        if (worksheet.model && worksheet.model.merges) {
          const originalMergeCount = worksheet.model.merges.length;
          // å…ˆå–æ¶ˆæ‰€æœ‰ç°æœ‰çš„åˆå¹¶å•å…ƒæ ¼
          const existingMerges = [...worksheet.model.merges];
          existingMerges.forEach(merge => {
            try {
              worksheet.unMergeCells(merge);
              console.log(`å–æ¶ˆåˆå¹¶: ${merge}`);
            } catch (error) {
              console.log(`å–æ¶ˆåˆå¹¶å¤±è´¥: ${merge}, é”™è¯¯: ${error.message}`);
            }
          });
          console.log(`æ¸…é™¤äº† ${originalMergeCount} ä¸ªç°æœ‰åˆå¹¶å•å…ƒæ ¼`);
          addLog(`ğŸ§¹ æ¸…é™¤äº† ${originalMergeCount} ä¸ªç°æœ‰åˆå¹¶å•å…ƒæ ¼`, "info");
        }

        let restoredCount = 0;
        let skippedCount = 0;
        const processedRanges = new Set(); // ç”¨äºæ£€æµ‹é‡å¤çš„åˆå¹¶èŒƒå›´

        mergedCellsInfo.forEach((mergeInfo, index) => {
          console.log(`\nå¤„ç†åˆå¹¶å•å…ƒæ ¼ ${index + 1}:`, mergeInfo);

          let newMergeInfo;

          // æ£€æŸ¥æ˜¯å¦ä¸ºå›ºå®šä½ç½®çš„åˆå¹¶å•å…ƒæ ¼
          if (mergeInfo.fixedPosition) {
            console.log(`å›ºå®šä½ç½®åˆå¹¶å•å…ƒæ ¼ï¼Œä¸è¿›è¡Œä½ç½®è®¡ç®—`);
            newMergeInfo = {
              newTop: mergeInfo.top,
              newBottom: mergeInfo.bottom,
              left: mergeInfo.left,
              right: mergeInfo.right,
              positionChanged: false,
              value: mergeInfo.value,
              font: mergeInfo.font,
              alignment: mergeInfo.alignment,
              border: mergeInfo.border,
              fill: mergeInfo.fill,
              numFmt: mergeInfo.numFmt
            };
          } else {
            // è®¡ç®—æ–°ä½ç½®ï¼ˆåªå¯¹éå›ºå®šä½ç½®çš„åˆå¹¶å•å…ƒæ ¼ï¼‰
            newMergeInfo = calculateNewMergedCellPosition(
              mergeInfo,
              deletedRowRanges
            );
          }

          console.log(`æœ€ç»ˆä½ç½®:`, newMergeInfo);

          // éªŒè¯æ–°ä½ç½®æ˜¯å¦æœ‰æ•ˆï¼ˆæ”¾å®½è¡Œæ•°é™åˆ¶ï¼Œå› ä¸ºåˆ é™¤è¡ŒåactualRowCountå¯èƒ½ä¸å‡†ç¡®ï¼‰
          const isValidPosition =
            newMergeInfo.newTop > 0 &&
            newMergeInfo.newBottom > 0 &&
            newMergeInfo.left > 0 &&
            newMergeInfo.right > 0 &&
            newMergeInfo.newTop <= newMergeInfo.newBottom &&
            newMergeInfo.left <= newMergeInfo.right &&
            newMergeInfo.left <= worksheet.actualColumnCount &&
            newMergeInfo.right <= worksheet.actualColumnCount;

          console.log(`ä½ç½®æœ‰æ•ˆæ€§æ£€æŸ¥:`, {
            newTop: newMergeInfo.newTop,
            newBottom: newMergeInfo.newBottom,
            left: newMergeInfo.left,
            right: newMergeInfo.right,
            worksheetRows: worksheet.actualRowCount,
            worksheetCols: worksheet.actualColumnCount,
            isValid: isValidPosition,
            reason: !isValidPosition ? "ä½ç½®éªŒè¯å¤±è´¥" : "ä½ç½®éªŒè¯é€šè¿‡"
          });

          if (isValidPosition) {
            try {
              // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡ç›¸åŒçš„åˆå¹¶èŒƒå›´
              const rangeKey = `${newMergeInfo.newTop}-${newMergeInfo.left}-${newMergeInfo.newBottom}-${newMergeInfo.right}`;
              if (processedRanges.has(rangeKey)) {
                console.log(`è·³è¿‡é‡å¤çš„åˆå¹¶èŒƒå›´: ${rangeKey}`);
                addLog(
                  `âš ï¸ è·³è¿‡é‡å¤çš„åˆå¹¶å•å…ƒæ ¼ ${index + 1}: èŒƒå›´å·²å­˜åœ¨`,
                  "warning"
                );
                skippedCount++;
                return;
              }
              processedRanges.add(rangeKey);

              // ç¡®ä¿ç›®æ ‡è¡Œå­˜åœ¨ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
              for (
                let row = newMergeInfo.newTop;
                row <= newMergeInfo.newBottom;
                row++
              ) {
                for (
                  let col = newMergeInfo.left;
                  col <= newMergeInfo.right;
                  col++
                ) {
                  const cell = worksheet.getCell(row, col);
                  // è®¿é—®å•å…ƒæ ¼ä¼šè‡ªåŠ¨åˆ›å»ºå®ƒ
                  console.log(`ç¡®ä¿å•å…ƒæ ¼å­˜åœ¨: ${cell.address}`);
                }
              }

              console.log(
                `å°è¯•åˆå¹¶å•å…ƒæ ¼: (${newMergeInfo.newTop}, ${newMergeInfo.left}, ${newMergeInfo.newBottom}, ${newMergeInfo.right})`
              );

              // æ¢å¤åˆå¹¶å•å…ƒæ ¼
              console.log(`å¼€å§‹æ‰§è¡Œåˆå¹¶æ“ä½œ...`);
              worksheet.mergeCells(
                newMergeInfo.newTop,
                newMergeInfo.left,
                newMergeInfo.newBottom,
                newMergeInfo.right
              );

              console.log(
                `åˆå¹¶å•å…ƒæ ¼æˆåŠŸ: ${newMergeInfo.newTop},${newMergeInfo.left} åˆ° ${newMergeInfo.newBottom},${newMergeInfo.right}`
              );

              // æ¢å¤ä¸»å•å…ƒæ ¼çš„å€¼å’Œæ ·å¼
              const mainCell = worksheet.getCell(
                newMergeInfo.newTop,
                newMergeInfo.left
              );

              console.log(`æ¢å¤ä¸»å•å…ƒæ ¼å€¼å’Œæ ·å¼:`, {
                value: newMergeInfo.value,
                hasFont: !!newMergeInfo.font,
                hasAlignment: !!newMergeInfo.alignment,
                hasBorder: !!newMergeInfo.border,
                hasFill: !!newMergeInfo.fill
              });

              // åªæ¢å¤éç©ºçš„å€¼å’Œæ ·å¼ï¼Œé¿å…å½±å“å…¶ä»–å•å…ƒæ ¼
              if (
                newMergeInfo.value !== undefined &&
                newMergeInfo.value !== null
              ) {
                mainCell.value = newMergeInfo.value;
              }

              // åªæœ‰å½“æ ·å¼ä¸ä¸ºnullä¸”ä¸ä¸ºundefinedæ—¶æ‰åº”ç”¨
              if (
                newMergeInfo.font &&
                Object.keys(newMergeInfo.font).length > 0
              ) {
                mainCell.font = newMergeInfo.font;
              }
              if (
                newMergeInfo.alignment &&
                Object.keys(newMergeInfo.alignment).length > 0
              ) {
                mainCell.alignment = newMergeInfo.alignment;
              }
              if (
                newMergeInfo.border &&
                Object.keys(newMergeInfo.border).length > 0
              ) {
                mainCell.border = newMergeInfo.border;
              }
              if (
                newMergeInfo.fill &&
                Object.keys(newMergeInfo.fill).length > 0
              ) {
                mainCell.fill = newMergeInfo.fill;
              }
              if (newMergeInfo.numFmt) {
                mainCell.numFmt = newMergeInfo.numFmt;
              }

              const newRange = `${mainCell.address}:${
                worksheet.getCell(newMergeInfo.newBottom, newMergeInfo.right)
                  .address
              }`;

              console.log(`åˆå¹¶å•å…ƒæ ¼æ¢å¤æˆåŠŸ: ${newRange}`);

              const positionStatus = mergeInfo.fixedPosition
                ? "(å›ºå®šä½ç½®)"
                : newMergeInfo.positionChanged
                  ? "(ä½ç½®å·²è°ƒæ•´)"
                  : "(ä½ç½®ä¸å˜)";

              addLog(
                `âœ… æ¢å¤åˆå¹¶å•å…ƒæ ¼ ${index + 1}: ${newRange} ${positionStatus}`,
                "success"
              );
              restoredCount++;
            } catch (error) {
              console.log(`åˆå¹¶å•å…ƒæ ¼å¤±è´¥:`, error);
              addLog(
                `âŒ æ¢å¤åˆå¹¶å•å…ƒæ ¼ ${index + 1} å¤±è´¥: ${error.message}`,
                "error"
              );
              skippedCount++;
            }
          } else {
            console.log(`è·³è¿‡æ— æ•ˆä½ç½®çš„åˆå¹¶å•å…ƒæ ¼`);
            addLog(
              `âš ï¸ è·³è¿‡æ— æ•ˆä½ç½®çš„åˆå¹¶å•å…ƒæ ¼ ${index + 1}: æ–°ä½ç½®è¶…å‡ºå·¥ä½œè¡¨èŒƒå›´`,
              "warning"
            );
            skippedCount++;
          }
        });

        console.log("=== æ¢å¤åˆå¹¶å•å…ƒæ ¼è°ƒè¯•ä¿¡æ¯ç»“æŸ ===");

        addLog(
          `ğŸ”— åˆå¹¶å•å…ƒæ ¼æ¢å¤å®Œæˆ: æˆåŠŸ ${restoredCount} ä¸ªï¼Œè·³è¿‡ ${skippedCount} ä¸ª`,
          "success"
        );

        // è°ƒæ•´ç‰¹å®šåˆå¹¶å•å…ƒæ ¼çš„è¾¹æ¡†ï¼ˆA30-C30çš„å³è¾¹æ¡†ï¼‰
        adjustSpecificMergedCellBorder(worksheet, deletedRowRanges);

        // åº”ç”¨å·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½®ï¼ˆè·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ï¼‰
        applyWorksheetFormatting(workbook);
      }

      // è°ƒæ•´ç‰¹å®šåˆå¹¶å•å…ƒæ ¼è¾¹æ¡†çš„å‡½æ•°ï¼ˆç§»é™¤A30-C30çš„å³è¾¹æ¡†ï¼‰
      function adjustSpecificMergedCellBorder(worksheet, deletedRowRanges) {
        try {
          addLog(`ğŸ”§ å¼€å§‹è°ƒæ•´A30-C30åˆå¹¶å•å…ƒæ ¼çš„å³è¾¹æ¡†...`, "info");
          console.log("=== è°ƒæ•´ç‰¹å®šåˆå¹¶å•å…ƒæ ¼è¾¹æ¡† ===");

          // å®šä¹‰åŸå§‹A30-C30åˆå¹¶å•å…ƒæ ¼çš„ä½ç½®
          const originalMergeInfo = {
            top: 30,
            left: 1,
            bottom: 30,
            right: 3,
            range: "A30:C30"
          };

          console.log(`åŸå§‹åˆå¹¶å•å…ƒæ ¼ä½ç½®: ${originalMergeInfo.range}`);

          // è®¡ç®—åˆ é™¤è¡Œåçš„æ–°ä½ç½®
          const newMergeInfo = calculateNewMergedCellPosition(
            originalMergeInfo,
            deletedRowRanges
          );

          console.log(
            `è®¡ç®—åçš„æ–°ä½ç½®: è¡Œ${newMergeInfo.newTop}-${newMergeInfo.newBottom}, åˆ—${originalMergeInfo.left}-${originalMergeInfo.right}`
          );

          // éªŒè¯æ–°ä½ç½®æ˜¯å¦æœ‰æ•ˆ
          if (newMergeInfo.newTop <= 0 || newMergeInfo.newBottom <= 0) {
            console.log("è®¡ç®—åçš„ä½ç½®æ— æ•ˆï¼Œè·³è¿‡è¾¹æ¡†è°ƒæ•´");
            addLog(`âš ï¸ A30-C30åˆå¹¶å•å…ƒæ ¼ä½ç½®æ— æ•ˆï¼Œè·³è¿‡è¾¹æ¡†è°ƒæ•´`, "warning");
            return;
          }

          // è·å–åˆå¹¶å•å…ƒæ ¼èŒƒå›´å†…æœ€å³ä¾§åˆ—ï¼ˆCåˆ—ï¼‰çš„æ‰€æœ‰å•å…ƒæ ¼
          const rightColumnIndex = originalMergeInfo.right; // Cåˆ— = 3

          console.log(
            `ç§»é™¤ç¬¬${rightColumnIndex}åˆ—ï¼ˆCåˆ—ï¼‰åœ¨è¡Œ${newMergeInfo.newTop}-${newMergeInfo.newBottom}èŒƒå›´å†…çš„å³è¾¹æ¡†`
          );

          // ç§»é™¤è¯¥èŒƒå›´å†…æ‰€æœ‰å•å…ƒæ ¼çš„å³è¾¹æ¡†
          for (
            let row = newMergeInfo.newTop;
            row <= newMergeInfo.newBottom;
            row++
          ) {
            const cell = worksheet.getCell(row, rightColumnIndex);

            // ä¿ç•™ç°æœ‰è¾¹æ¡†ï¼Œåªç§»é™¤å³è¾¹æ¡†
            if (cell.border) {
              const existingBorder = { ...cell.border };
              delete existingBorder.right; // ç§»é™¤å³è¾¹æ¡†
              cell.border = existingBorder;
              console.log(`ç§»é™¤å•å…ƒæ ¼ ${cell.address} çš„å³è¾¹æ¡†`);
            } else {
              console.log(`å•å…ƒæ ¼ ${cell.address} æ²¡æœ‰è¾¹æ¡†ï¼Œè·³è¿‡`);
            }
          }

          const newRange = `${
            worksheet.getCell(newMergeInfo.newTop, originalMergeInfo.left)
              .address
          }:${
            worksheet.getCell(newMergeInfo.newBottom, originalMergeInfo.right)
              .address
          }`;

          console.log(`A30-C30åˆå¹¶å•å…ƒæ ¼å³è¾¹æ¡†è°ƒæ•´å®Œæˆ: ${newRange}`);
          addLog(`ğŸ”§ A30-C30åˆå¹¶å•å…ƒæ ¼å³è¾¹æ¡†è°ƒæ•´å®Œæˆ: ${newRange}`, "success");

          // ç»§ç»­å¤„ç†H29å·¦è¾¹æ¡†æ·»åŠ 
          addH29LeftBorder(worksheet, deletedRowRanges);
        } catch (error) {
          console.log(`è°ƒæ•´ç‰¹å®šåˆå¹¶å•å…ƒæ ¼è¾¹æ¡†å¤±è´¥:`, error);
          addLog(`âŒ è°ƒæ•´A30-C30åˆå¹¶å•å…ƒæ ¼è¾¹æ¡†å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ä¸ºH29å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†çš„å‡½æ•°
      function addH29LeftBorder(worksheet, deletedRowRanges) {
        try {
          addLog(`ğŸ¨ å¼€å§‹ä¸ºH29å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†...`, "info");
          console.log("=== ä¸ºH29å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡† ===");

          // å®šä¹‰åŸå§‹H29å•å…ƒæ ¼çš„ä½ç½®ï¼ˆç¬¬29è¡Œï¼Œç¬¬8åˆ—ï¼‰
          const originalCellInfo = {
            top: 29,
            left: 8,
            bottom: 29,
            right: 8,
            range: "H29"
          };

          console.log(`åŸå§‹å•å…ƒæ ¼ä½ç½®: ${originalCellInfo.range}`);

          // è®¡ç®—åˆ é™¤è¡Œåçš„æ–°ä½ç½®
          const newCellInfo = calculateNewMergedCellPosition(
            originalCellInfo,
            deletedRowRanges
          );

          console.log(
            `è®¡ç®—åçš„æ–°ä½ç½®: è¡Œ${newCellInfo.newTop}, åˆ—${originalCellInfo.left}`
          );

          // éªŒè¯æ–°ä½ç½®æ˜¯å¦æœ‰æ•ˆ
          if (newCellInfo.newTop <= 0) {
            console.log("è®¡ç®—åçš„ä½ç½®æ— æ•ˆï¼Œè·³è¿‡è¾¹æ¡†æ·»åŠ ");
            addLog(`âš ï¸ H29å•å…ƒæ ¼ä½ç½®æ— æ•ˆï¼Œè·³è¿‡è¾¹æ¡†æ·»åŠ `, "warning");
            return;
          }

          // å®šä¹‰å·¦è¾¹æ¡†æ ·å¼
          const leftBorderStyle = {
            style: "thin",
            color: { argb: "FF000000" } // é»‘è‰²
          };

          // è·å–Håˆ—åœ¨æ–°è¡Œä½ç½®çš„å•å…ƒæ ¼
          const cell = worksheet.getCell(
            newCellInfo.newTop,
            originalCellInfo.left
          );

          console.log(`ä¸ºå•å…ƒæ ¼ ${cell.address} æ·»åŠ å·¦è¾¹æ¡†`);

          // ä¿ç•™ç°æœ‰è¾¹æ¡†ï¼Œæ·»åŠ å·¦è¾¹æ¡†
          if (!cell.border) cell.border = {};
          const existingBorder = { ...cell.border };
          cell.border = {
            ...existingBorder,
            left: leftBorderStyle
          };

          console.log(`H29å•å…ƒæ ¼å·¦è¾¹æ¡†æ·»åŠ å®Œæˆ: ${cell.address}`);
          addLog(`ğŸ¨ H29å•å…ƒæ ¼å·¦è¾¹æ¡†æ·»åŠ å®Œæˆ: ${cell.address}`, "success");

          // ç»§ç»­å¤„ç†H30-H33å•å…ƒæ ¼çš„å·¦è¾¹æ¡†æ·»åŠ 
          addH30ToH33LeftBorder(worksheet, deletedRowRanges);
        } catch (error) {
          console.log(`ä¸ºH29å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†å¤±è´¥:`, error);
          addLog(`âŒ ä¸ºH29å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ä¸ºH30-H33å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†çš„å‡½æ•°
      function addH30ToH33LeftBorder(worksheet, deletedRowRanges) {
        try {
          addLog(`ğŸ¨ å¼€å§‹ä¸ºH30-H33å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†...`, "info");
          console.log("=== ä¸ºH30-H33å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡† ===");

          // å®šä¹‰H30-H33å•å…ƒæ ¼çš„åŸå§‹ä½ç½®
          const targetCells = [
            { row: 30, name: "H30" },
            { row: 31, name: "H31" },
            { row: 32, name: "H32" },
            { row: 33, name: "H33" }
          ];

          // å®šä¹‰å·¦è¾¹æ¡†æ ·å¼
          const leftBorderStyle = {
            style: "thin",
            color: { argb: "FF000000" } // é»‘è‰²
          };

          let successCount = 0;
          let failedCount = 0;

          // éå†å¤„ç†æ¯ä¸ªç›®æ ‡å•å…ƒæ ¼
          targetCells.forEach((targetCell, index) => {
            try {
              console.log(`\nå¤„ç†å•å…ƒæ ¼ ${index + 1}: ${targetCell.name}`);

              // å®šä¹‰å•å…ƒæ ¼ä¿¡æ¯
              const cellInfo = {
                top: targetCell.row,
                left: 8, // Håˆ— = 8
                bottom: targetCell.row,
                right: 8,
                range: targetCell.name
              };

              console.log(`åŸå§‹å•å…ƒæ ¼ä½ç½®: ${cellInfo.range}`);

              // è®¡ç®—åˆ é™¤è¡Œåçš„æ–°ä½ç½®
              const newCellInfo = calculateNewMergedCellPosition(
                cellInfo,
                deletedRowRanges
              );

              console.log(
                `è®¡ç®—åçš„æ–°ä½ç½®: è¡Œ${newCellInfo.newTop}, åˆ—${cellInfo.left}`
              );

              // éªŒè¯æ–°ä½ç½®æ˜¯å¦æœ‰æ•ˆ
              if (newCellInfo.newTop <= 0) {
                console.log(`${targetCell.name} ä½ç½®æ— æ•ˆï¼Œè·³è¿‡è¾¹æ¡†æ·»åŠ `);
                addLog(
                  `âš ï¸ ${targetCell.name}å•å…ƒæ ¼ä½ç½®æ— æ•ˆï¼Œè·³è¿‡è¾¹æ¡†æ·»åŠ `,
                  "warning"
                );
                failedCount++;
                return;
              }

              // è·å–Håˆ—åœ¨æ–°è¡Œä½ç½®çš„å•å…ƒæ ¼
              const cell = worksheet.getCell(newCellInfo.newTop, cellInfo.left);

              console.log(`ä¸ºå•å…ƒæ ¼ ${cell.address} æ·»åŠ å·¦è¾¹æ¡†`);

              // ä¿ç•™ç°æœ‰è¾¹æ¡†ï¼Œæ·»åŠ å·¦è¾¹æ¡†
              if (!cell.border) cell.border = {};
              const existingBorder = { ...cell.border };
              cell.border = {
                ...existingBorder,
                left: leftBorderStyle
              };

              console.log(
                `${targetCell.name}å•å…ƒæ ¼å·¦è¾¹æ¡†æ·»åŠ å®Œæˆ: ${cell.address}`
              );
              successCount++;
            } catch (error) {
              console.log(`ä¸º${targetCell.name}å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†å¤±è´¥:`, error);
              failedCount++;
            }
          });

          // è¾“å‡ºå¤„ç†ç»“æœ
          console.log(
            `H30-H33å•å…ƒæ ¼å·¦è¾¹æ¡†å¤„ç†å®Œæˆ: æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failedCount} ä¸ª`
          );
          addLog(
            `ğŸ¨ H30-H33å•å…ƒæ ¼å·¦è¾¹æ¡†å¤„ç†å®Œæˆ: æˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failedCount} ä¸ª`,
            successCount > 0 ? "success" : "warning"
          );
        } catch (error) {
          console.log(`ä¸ºH30-H33å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†å¤±è´¥:`, error);
          addLog(`âŒ ä¸ºH30-H33å•å…ƒæ ¼æ·»åŠ å·¦è¾¹æ¡†å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ä¸ºå·¥ä½œè¡¨æ·»åŠ æ±‚å’ŒåŠŸèƒ½ï¼ˆä»ç¬¬äºŒä¸ªå·¥ä½œè¡¨å¼€å§‹ï¼‰
      function addSumFormulasToWorksheets(workbook) {
        try {
          addLog(`ğŸ§® å¼€å§‹ä¸ºå·¥ä½œè¡¨æ·»åŠ æ±‚å’ŒåŠŸèƒ½...`, "info");
          console.log("=== æ·»åŠ å·¥ä½œè¡¨æ±‚å’ŒåŠŸèƒ½ ===");

          const worksheets = workbook.worksheets;
          const totalWorksheets = worksheets.length;
          let processedCount = 0;
          let successCount = 0;
          let failedCount = 0;

          console.log(`å·¥ä½œç°¿æ€»å…±æœ‰ ${totalWorksheets} ä¸ªå·¥ä½œè¡¨`);

          // éå†æ‰€æœ‰å·¥ä½œè¡¨ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªï¼ˆç´¢å¼•0ï¼‰
          worksheets.forEach((worksheet, index) => {
            if (index === 0) {
              console.log(
                `è·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨: ${worksheet.name} (ç´¢å¼•: ${index})`
              );
              addLog(`â­ï¸ è·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨: ${worksheet.name}`, "info");
              return;
            }

            console.log(
              `å¤„ç†å·¥ä½œè¡¨ ${index + 1}: ${worksheet.name} (ç´¢å¼•: ${index})`
            );
            addLog(`ğŸ”„ å¤„ç†å·¥ä½œè¡¨: ${worksheet.name}`, "info");
            processedCount++;

            try {
              const result = addSumFormulaToWorksheet(worksheet, index);
              if (result.success) {
                successCount++;
                addLog(
                  `âœ… å·¥ä½œè¡¨ ${worksheet.name} æ±‚å’ŒåŠŸèƒ½æ·»åŠ å®Œæˆ: ${result.message}`,
                  "success"
                );
              } else {
                addLog(
                  `âš ï¸ å·¥ä½œè¡¨ ${worksheet.name} è·³è¿‡æ±‚å’Œ: ${result.message}`,
                  "info"
                );
              }
            } catch (error) {
              failedCount++;
              console.error(
                `å·¥ä½œè¡¨ ${worksheet.name} æ±‚å’ŒåŠŸèƒ½æ·»åŠ å¤±è´¥:`,
                error
              );
              addLog(
                `âŒ å·¥ä½œè¡¨ ${worksheet.name} æ±‚å’ŒåŠŸèƒ½æ·»åŠ å¤±è´¥: ${error.message}`,
                "error"
              );
            }
          });

          const summary = `å·¥ä½œè¡¨æ±‚å’ŒåŠŸèƒ½æ·»åŠ å®Œæˆ:
      - æ€»å·¥ä½œè¡¨æ•°: ${totalWorksheets}
      - è·³è¿‡å·¥ä½œè¡¨æ•°: 1 (ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨)
      - å¤„ç†å·¥ä½œè¡¨æ•°: ${processedCount}
      - æˆåŠŸæ·»åŠ æ•°: ${successCount}
      - å¤±è´¥æ·»åŠ æ•°: ${failedCount}`;

          console.log(summary);
          addLog(
            `ğŸ§® å·¥ä½œè¡¨æ±‚å’ŒåŠŸèƒ½æ·»åŠ å®Œæˆ: å¤„ç† ${processedCount} ä¸ªå·¥ä½œè¡¨ï¼ŒæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failedCount} ä¸ª`,
            successCount > 0 ? "success" : "info"
          );
        } catch (error) {
          console.error("æ·»åŠ å·¥ä½œè¡¨æ±‚å’ŒåŠŸèƒ½å¤±è´¥:", error);
          addLog(`âŒ æ·»åŠ å·¥ä½œè¡¨æ±‚å’ŒåŠŸèƒ½å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ä¸ºå•ä¸ªå·¥ä½œè¡¨æ·»åŠ æ±‚å’ŒåŠŸèƒ½
      function addSumFormulaToWorksheet(worksheet, sheetIndex) {
        try {
          const actualRowCount = worksheet.actualRowCount || 0;
          const actualColumnCount = worksheet.actualColumnCount || 0;

          console.log(
            `å·¥ä½œè¡¨ ${worksheet.name} æ•°æ®èŒƒå›´: ${actualRowCount} è¡Œ Ã— ${actualColumnCount} åˆ—`
          );

          // æ£€æŸ¥å·¥ä½œè¡¨æ˜¯å¦æœ‰æ•°æ®
          if (actualRowCount < 2 || actualColumnCount < 1) {
            return {
              success: false,
              message: `æ•°æ®ä¸è¶³ (${actualRowCount} è¡Œ Ã— ${actualColumnCount} åˆ—)`
            };
          }

          // æŸ¥æ‰¾ç¬¬ä¸€è¡Œä¸­çš„é‡‘é¢åˆ—
          const amountColumn = findAmountColumnInFirstRow(worksheet);
          if (!amountColumn) {
            return {
              success: false,
              message: "æœªæ‰¾åˆ°é‡‘é¢åˆ—"
            };
          }

          console.log(
            `æ‰¾åˆ°é‡‘é¢åˆ—: ${amountColumn.columnLetter} (ç¬¬${amountColumn.columnNumber}åˆ—), ç¬¬ä¸€è¡Œå€¼: ${amountColumn.firstRowValue}`
          );

          // è®¡ç®—æ±‚å’ŒèŒƒå›´ï¼šä»ç¬¬2è¡Œåˆ°æœ€åä¸€è¡Œ
          const sumStartRow = 2;
          const sumEndRow = actualRowCount;
          const sumTargetRow = actualRowCount + 1;

          // ç”Ÿæˆæ±‚å’Œå…¬å¼
          const sumFormula = `=SUM(${amountColumn.columnLetter}${sumStartRow}:${amountColumn.columnLetter}${sumEndRow})`;

          console.log(
            `æ±‚å’Œå…¬å¼: ${sumFormula}, ç›®æ ‡ä½ç½®: ${amountColumn.columnLetter}${sumTargetRow}`
          );

          // åœ¨ç›®æ ‡ä½ç½®æ·»åŠ æ±‚å’Œå…¬å¼
          const sumCell = worksheet.getCell(
            sumTargetRow,
            amountColumn.columnNumber
          );
          sumCell.value = { formula: sumFormula.substring(1) }; // å»æ‰å¼€å¤´çš„=å·ï¼ŒExcelJSä¼šè‡ªåŠ¨æ·»åŠ 

          // åœ¨Aåˆ—æ·»åŠ "åˆè®¡"æ ‡ç­¾
          const labelCell = worksheet.getCell(sumTargetRow, 1); // Aåˆ—æ˜¯ç¬¬1åˆ—
          labelCell.value = "åˆè®¡";

          // è®¾ç½®æ–°å¢æ±‚å’Œè¡Œçš„å®Œæ•´æ ·å¼
          console.log(
            `å¼€å§‹ä¸ºæ±‚å’Œè¡Œè®¾ç½®æ ·å¼: ç¬¬${sumTargetRow}è¡Œï¼Œä»Aåˆ—åˆ°ç¬¬${actualColumnCount}åˆ—`
          );

          // è®¾ç½®è¡Œé«˜ä¸º22ç£…
          const sumRow = worksheet.getRow(sumTargetRow);
          sumRow.height = 22;

          // å®šä¹‰ç»Ÿä¸€çš„è¾¹æ¡†æ ·å¼
          const borderStyle = {
            top: { style: "thin", color: { argb: "FF000000" } },
            left: { style: "thin", color: { argb: "FF000000" } },
            bottom: { style: "thin", color: { argb: "FF000000" } },
            right: { style: "thin", color: { argb: "FF000000" } }
          };

          // å®šä¹‰ç»Ÿä¸€çš„å­—ä½“æ ·å¼
          const fontStyle = {
            size: 10,
            name: "å®‹ä½“"
          };

          // ä¸ºæ•´è¡Œè®¾ç½®æ ·å¼ï¼ˆä»Aåˆ—åˆ°æœ€åä¸€ä¸ªæœ‰æ•°æ®çš„åˆ—ï¼‰
          for (let col = 1; col <= actualColumnCount; col++) {
            const cell = worksheet.getCell(sumTargetRow, col);

            // è®¾ç½®è¾¹æ¡†
            cell.border = borderStyle;

            // è®¾ç½®å­—ä½“
            cell.font = fontStyle;

            // å¦‚æœæ˜¯é‡‘é¢åˆ—ï¼Œä¿ç•™æ•°å­—æ ¼å¼
            if (col === amountColumn.columnNumber && sumEndRow >= 2) {
              const referenceCell = worksheet.getCell(
                sumEndRow,
                amountColumn.columnNumber
              );
              if (referenceCell.numFmt) {
                cell.numFmt = referenceCell.numFmt;
              }
            }

            // è®¾ç½®å¯¹é½æ–¹å¼ - æ‰€æœ‰å•å…ƒæ ¼éƒ½æ°´å¹³å±…ä¸­
            cell.alignment = { horizontal: "center", vertical: "middle" };
          }

          console.log(
            `æ±‚å’Œè¡Œæ ·å¼è®¾ç½®å®Œæˆ: ç¬¬${sumTargetRow}è¡Œï¼Œè®¾ç½®äº†${actualColumnCount}ä¸ªå•å…ƒæ ¼çš„è¾¹æ¡†ã€å­—ä½“å’Œå¯¹é½æ–¹å¼`
          );

          console.log(
            `æ±‚å’ŒåŠŸèƒ½æ·»åŠ å®Œæˆ: A${sumTargetRow}="åˆè®¡", ${amountColumn.columnLetter}${sumTargetRow}="${sumFormula}"`
          );

          return {
            success: true,
            message: `åœ¨ç¬¬${sumTargetRow}è¡Œæ·»åŠ æ±‚å’Œå…¬å¼ (${amountColumn.columnLetter}åˆ—)`
          };
        } catch (error) {
          console.error(`ä¸ºå·¥ä½œè¡¨ ${worksheet.name} æ·»åŠ æ±‚å’ŒåŠŸèƒ½å¤±è´¥:`, error);
          throw error;
        }
      }

      // æŸ¥æ‰¾ç¬¬ä¸€è¡Œä¸­çš„é‡‘é¢åˆ—ï¼ˆæŸ¥æ‰¾åç§°ä¸º"æ€»é‡‘é¢"çš„åˆ—ï¼‰
      function findAmountColumnInFirstRow(worksheet) {
        try {
          const actualColumnCount = worksheet.actualColumnCount || 0;
          let amountColumn = null;

          console.log(
            `æ‰«æç¬¬ä¸€è¡Œçš„ ${actualColumnCount} åˆ—ï¼ŒæŸ¥æ‰¾"æ€»é‡‘é¢"åˆ—...`
          );

          // æ‰«æç¬¬ä¸€è¡Œçš„æ‰€æœ‰åˆ—ï¼ŒæŸ¥æ‰¾"æ€»é‡‘é¢"
          for (let col = 1; col <= actualColumnCount; col++) {
            const cell = worksheet.getCell(1, col);
            const cellValue = cell.value;

            // è·³è¿‡ç©ºå€¼
            if (cellValue === null || cellValue === undefined) {
              continue;
            }

            // è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ
            const cellText = cellValue.toString().trim();

            console.log(
              `åˆ— ${col} (${getColumnLetter(col)}): å€¼="${cellValue}"`
            );

            // æ£€æŸ¥æ˜¯å¦ä¸º"æ€»é‡‘é¢"
            if (cellText === "æ€»é‡‘é¢") {
              amountColumn = {
                columnNumber: col,
                columnLetter: getColumnLetter(col),
                firstRowValue: cellValue
              };
              console.log(
                `âœ… æ‰¾åˆ°"æ€»é‡‘é¢"åˆ—: ${getColumnLetter(col)} (ç¬¬${col}åˆ—)`
              );
              break; // æ‰¾åˆ°åç«‹å³é€€å‡ºå¾ªç¯
            }
          }

          if (amountColumn) {
            console.log(
              `æœ€ç»ˆé€‰æ‹©é‡‘é¢åˆ—: ${amountColumn.columnLetter} (ç¬¬${amountColumn.columnNumber}åˆ—), æ ‡é¢˜: "${amountColumn.firstRowValue}"`
            );
          } else {
            console.log('æœªæ‰¾åˆ°"æ€»é‡‘é¢"åˆ—');
          }

          return amountColumn;
        } catch (error) {
          console.error("æŸ¥æ‰¾é‡‘é¢åˆ—å¤±è´¥:", error);
          return null;
        }
      }

      // å°†åˆ—å·è½¬æ¢ä¸ºExcelåˆ—å­—æ¯ï¼ˆå¦‚1->A, 2->B, 26->Z, 27->AAï¼‰
      function getColumnLetter(columnNumber) {
        let result = "";
        while (columnNumber > 0) {
          columnNumber--; // è°ƒæ•´ä¸º0åŸºç´¢å¼•
          result = String.fromCharCode(65 + (columnNumber % 26)) + result;
          columnNumber = Math.floor(columnNumber / 26);
        }
        return result;
      }

      // åº”ç”¨å·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½®çš„å‡½æ•°ï¼ˆè·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ï¼‰
      function applyWorksheetFormatting(workbook) {
        try {
          addLog(`ğŸ¨ å¼€å§‹åº”ç”¨å·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½®...`, "info");
          console.log("=== åº”ç”¨å·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½® ===");

          const worksheets = workbook.worksheets;
          const totalWorksheets = worksheets.length;
          let processedCount = 0;
          let successCount = 0;
          let failedCount = 0;

          console.log(`å·¥ä½œç°¿æ€»å…±æœ‰ ${totalWorksheets} ä¸ªå·¥ä½œè¡¨`);

          // éå†æ‰€æœ‰å·¥ä½œè¡¨ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªï¼ˆç´¢å¼•0ï¼‰
          worksheets.forEach((worksheet, index) => {
            if (index === 0) {
              console.log(
                `è·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨: ${worksheet.name} (ç´¢å¼•: ${index})`
              );
              addLog(`â­ï¸ è·³è¿‡ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨: ${worksheet.name}`, "info");
              return;
            }

            try {
              console.log(
                `\nå¤„ç†å·¥ä½œè¡¨ ${index + 1}: ${worksheet.name} (ç´¢å¼•: ${index})`
              );
              addLog(`ğŸ”„ å¤„ç†å·¥ä½œè¡¨: ${worksheet.name}`, "info");

              // è·å–å·¥ä½œè¡¨çš„æ•°æ®èŒƒå›´
              const actualRowCount = worksheet.actualRowCount || 1;
              const actualColumnCount = worksheet.actualColumnCount || 1;

              console.log(
                `å·¥ä½œè¡¨ ${worksheet.name} æ•°æ®èŒƒå›´: ${actualRowCount} è¡Œ Ã— ${actualColumnCount} åˆ—`
              );

              // è®¾ç½®æ ·å¼å‚æ•°
              const fontSize = 10; // å­—ä½“å¤§å° 10pt
              const rowHeight = 22; // è¡Œé«˜ 22

              let cellCount = 0;

              // éå†æ‰€æœ‰æ•°æ®åŒºåŸŸçš„å•å…ƒæ ¼
              for (let row = 1; row <= actualRowCount; row++) {
                // è®¾ç½®è¡Œé«˜
                const worksheetRow = worksheet.getRow(row);
                worksheetRow.height = rowHeight;

                for (let col = 1; col <= actualColumnCount; col++) {
                  const cell = worksheet.getCell(row, col);

                  // ä¿ç•™ç°æœ‰å­—ä½“å±æ€§ï¼Œåªä¿®æ”¹å¤§å°
                  if (!cell.font) cell.font = {};
                  const existingFont = { ...cell.font };
                  cell.font = {
                    ...existingFont,
                    size: fontSize
                  };

                  cellCount++;
                }
              }

              console.log(
                `å·¥ä½œè¡¨ ${worksheet.name} æ ·å¼è®¾ç½®å®Œæˆ: ${cellCount} ä¸ªå•å…ƒæ ¼ï¼Œè¡Œé«˜: ${rowHeight}ï¼Œå­—ä½“å¤§å°: ${fontSize}pt`
              );
              addLog(
                `âœ… å·¥ä½œè¡¨ ${worksheet.name} æ ·å¼è®¾ç½®å®Œæˆ: ${cellCount} ä¸ªå•å…ƒæ ¼`,
                "success"
              );

              processedCount++;
              successCount++;
            } catch (error) {
              console.log(`å·¥ä½œè¡¨ ${worksheet.name} æ ·å¼è®¾ç½®å¤±è´¥:`, error);
              addLog(
                `âŒ å·¥ä½œè¡¨ ${worksheet.name} æ ·å¼è®¾ç½®å¤±è´¥: ${error.message}`,
                "error"
              );

              processedCount++;
              failedCount++;
            }
          });

          // è¾“å‡ºæœ€ç»ˆç»Ÿè®¡ä¿¡æ¯
          console.log(`\nå·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½®å®Œæˆ:`);
          console.log(`- æ€»å·¥ä½œè¡¨æ•°: ${totalWorksheets}`);
          console.log(`- è·³è¿‡å·¥ä½œè¡¨æ•°: 1 (ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨)`);
          console.log(`- å¤„ç†å·¥ä½œè¡¨æ•°: ${processedCount}`);
          console.log(`- æˆåŠŸè®¾ç½®æ•°: ${successCount}`);
          console.log(`- å¤±è´¥è®¾ç½®æ•°: ${failedCount}`);

          addLog(
            `ğŸ¨ å·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½®å®Œæˆ: å¤„ç† ${processedCount} ä¸ªå·¥ä½œè¡¨ï¼ŒæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failedCount} ä¸ª`,
            successCount > 0 ? "success" : "warning"
          );
        } catch (error) {
          console.log(`åº”ç”¨å·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½®å¤±è´¥:`, error);
          addLog(`âŒ åº”ç”¨å·¥ä½œè¡¨æ ·å¼ç»Ÿä¸€è®¾ç½®å¤±è´¥: ${error.message}`, "error");
        }
      }

      // å¤„ç†"è´¦å•æ¦‚è§ˆ"å·¥ä½œè¡¨çš„ç‰¹æ®Šé€»è¾‘ - è‡ªåŠ¨åˆ é™¤ç¬¦åˆæ¡ä»¶çš„"åˆè®¡"è¡Œ
      async function processAccountSummarySheet(worksheet, workbook) {
        try {
          addLog(`ğŸ“Š å¼€å§‹å¤„ç†"è´¦å•æ¦‚è§ˆ"å·¥ä½œè¡¨çš„"åˆè®¡"è¡Œåˆ é™¤é€»è¾‘`, "info");
          addLog(
            `ğŸ“‹ å·¥ä½œè¡¨èŒƒå›´: ${worksheet.actualRowCount} è¡Œ Ã— ${worksheet.actualColumnCount} åˆ—`,
            "info"
          );

          if (!worksheet.actualRowCount || worksheet.actualRowCount === 0) {
            addLog(`âš ï¸ "è´¦å•æ¦‚è§ˆ"å·¥ä½œè¡¨ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†`, "warning");
            return 0;
          }

          // ç¬¬ä¸€æ­¥ï¼šä¿å­˜åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯
          const mergedCellsInfo = saveMergedCellsInfo(worksheet);

          // å­˜å‚¨éœ€è¦åˆ é™¤çš„è¡Œå·é›†åˆï¼Œé¿å…é‡å¤
          const rowsToDeleteSet = new Set();
          const deleteInfoList = [];
          let totalFoundCount = 0;

          // é›¶å€¼æ£€æµ‹å‡½æ•° - æ”¯æŒå¤šç§é›¶å€¼æ ¼å¼
          const isZeroValue = value => {
            // nullã€undefinedã€ç©ºå€¼
            if (value === null || value === undefined) return true;

            // æ•°å­—0
            if (value === 0) return true;

            // å­—ç¬¦ä¸²"0"
            if (value === "0") return true;

            // æ¥è¿‘0çš„æµ®ç‚¹æ•°
            if (typeof value === "number" && Math.abs(value) < 0.001)
              return true;

            // å­—ç¬¦ä¸²æ ¼å¼çš„é›¶å€¼
            if (typeof value === "string") {
              const trimmed = value.trim();
              if (trimmed === "") return true; // ç©ºå­—ç¬¦ä¸²
              if (trimmed === "0.0" || trimmed === "0.00") return true;

              // å°è¯•è§£æä¸ºæ•°å­—
              const parsed = parseFloat(trimmed);
              if (!isNaN(parsed) && Math.abs(parsed) < 0.001) return true;
            }

            return false;
          };

          // éå†æ‰€æœ‰è¡Œå’Œåˆ—ï¼ŒæŸ¥æ‰¾åŒ…å«"åˆè®¡"çš„å•å…ƒæ ¼
          for (let row = 1; row <= worksheet.actualRowCount; row++) {
            for (let col = 1; col <= worksheet.actualColumnCount; col++) {
              const cell = worksheet.getCell(row, col);
              const cellValue = cell.value;

              // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦åŒ…å«"åˆè®¡"æ–‡æœ¬ï¼ˆæ”¯æŒå­—ç¬¦ä¸²å’Œæ•°å­—è½¬å­—ç¬¦ä¸²ï¼‰
              const cellText = cellValue ? cellValue.toString() : "";
              if (cellText.includes("åˆè®¡")) {
                totalFoundCount++;
                addLog(
                  `ğŸ” å‘ç°"åˆè®¡"å•å…ƒæ ¼ ${
                    cell.address
                  }: "${cellValue}" (ç±»å‹: ${typeof cellValue})`,
                  "info"
                );

                // æ£€æŸ¥ä¸‹æ–¹ç›¸é‚»å•å…ƒæ ¼ï¼ˆåŒåˆ—ï¼Œä¸‹ä¸€è¡Œï¼‰
                if (row + 1 <= worksheet.actualRowCount) {
                  const nextRowCell = worksheet.getCell(row + 1, col);
                  const nextRowValue = nextRowCell.value;

                  addLog(
                    `ğŸ“‹ æ£€æŸ¥ä¸‹æ–¹å•å…ƒæ ¼ ${
                      nextRowCell.address
                    }: ${nextRowValue} (ç±»å‹: ${typeof nextRowValue})`,
                    "info"
                  );

                  const isZero = isZeroValue(nextRowValue);
                  addLog(
                    `ğŸ” é›¶å€¼åˆ¤å®š: ${nextRowCell.address} = ${nextRowValue} â†’ ${
                      isZero ? "æ˜¯é›¶å€¼" : "éé›¶å€¼"
                    }`,
                    isZero ? "warning" : "info"
                  );

                  if (isZero) {
                    addLog(
                      `âŒ æ ‡è®°åˆ é™¤åŒºåŸŸ: åˆè®¡å•å…ƒæ ¼ ${cell.address}="${cellValue}", é›¶å€¼å•å…ƒæ ¼ ${nextRowCell.address}="${nextRowValue}"`,
                      "warning"
                    );

                    // è®¡ç®—éœ€è¦åˆ é™¤çš„3è¡Œï¼šä¸Šä¸€è¡Œã€åˆè®¡è¡Œã€ä¸‹ä¸€è¡Œ
                    const deleteStartRow = Math.max(1, row - 1); // ä¸Šä¸€è¡Œï¼ˆç¡®ä¿ä¸å°äº1ï¼‰
                    const deleteEndRow = Math.min(
                      row + 1,
                      worksheet.actualRowCount
                    ); // ä¸‹ä¸€è¡Œï¼ˆç¡®ä¿ä¸è¶…è¿‡æœ€å¤§è¡Œæ•°ï¼‰

                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ ‡è®°è¿‡è¿™äº›è¡Œ
                    let alreadyMarked = false;
                    for (let r = deleteStartRow; r <= deleteEndRow; r++) {
                      if (rowsToDeleteSet.has(r)) {
                        alreadyMarked = true;
                        break;
                      }
                    }

                    if (!alreadyMarked) {
                      // æ ‡è®°è¿™äº›è¡Œä¸ºå¾…åˆ é™¤
                      for (let r = deleteStartRow; r <= deleteEndRow; r++) {
                        rowsToDeleteSet.add(r);
                      }

                      deleteInfoList.push({
                        startRow: deleteStartRow,
                        endRow: deleteEndRow,
                        totalCell: cell.address,
                        zeroCell: nextRowCell.address,
                        totalValue: cellValue,
                        zeroValue: nextRowValue
                      });

                      addLog(
                        `ğŸ“ æ ‡è®°åˆ é™¤è¡ŒèŒƒå›´: ç¬¬${deleteStartRow}-${deleteEndRow}è¡Œ (å…±${
                          deleteEndRow - deleteStartRow + 1
                        }è¡Œ)`,
                        "info"
                      );
                    } else {
                      addLog(
                        `âš ï¸ è¡ŒèŒƒå›´ ç¬¬${deleteStartRow}-${deleteEndRow}è¡Œ å·²è¢«æ ‡è®°ï¼Œè·³è¿‡é‡å¤æ ‡è®°`,
                        "warning"
                      );
                    }
                  } else {
                    addLog(
                      `âœ… ä¿ç•™"åˆè®¡"è¡Œ: ${cell.address} (ä¸‹æ–¹å€¼éé›¶: ${nextRowValue})`,
                      "info"
                    );
                  }
                } else {
                  addLog(
                    `âš ï¸ "åˆè®¡"å•å…ƒæ ¼ ${cell.address} å·²åœ¨æœ€åä¸€è¡Œï¼Œæ— æ³•æ£€æŸ¥ä¸‹æ–¹å•å…ƒæ ¼`,
                    "warning"
                  );
                }
              }
            }
          }

          // å¤„ç†ç»“æœç»Ÿè®¡
          addLog(
            `ğŸ“Š æ‰«æå®Œæˆ: å…±å‘ç° ${totalFoundCount} ä¸ª"åˆè®¡"å•å…ƒæ ¼ï¼Œå…¶ä¸­ ${deleteInfoList.length} ä¸ªç¬¦åˆåˆ é™¤æ¡ä»¶`,
            "info"
          );

          if (deleteInfoList.length === 0) {
            addLog(`âœ… æœªå‘ç°éœ€è¦åˆ é™¤çš„"åˆè®¡"è¡Œ`, "success");
            return 0; // è¿”å›åˆ é™¤çš„è¡Œæ•°
          }

          // æŒ‰èµ·å§‹è¡Œå·ä»å¤§åˆ°å°æ’åºï¼Œç¡®ä¿ä»ä¸‹å¾€ä¸Šåˆ é™¤ï¼ˆé¿å…è¡Œå·å˜åŒ–å½±å“ï¼‰
          deleteInfoList.sort((a, b) => b.startRow - a.startRow);

          addLog(
            `ğŸ—‘ï¸ å¼€å§‹æ‰§è¡Œåˆ é™¤æ“ä½œ (ä»ä¸‹å¾€ä¸Šåˆ é™¤ ${deleteInfoList.length} ä¸ªåŒºåŸŸ)`,
            "warning"
          );

          // æ‰§è¡Œåˆ é™¤æ“ä½œ
          let totalDeletedRows = 0;
          const deletedRowRanges = []; // è®°å½•åˆ é™¤çš„è¡ŒèŒƒå›´ï¼Œç”¨äºåˆå¹¶å•å…ƒæ ¼ä½ç½®è®¡ç®—

          for (let i = 0; i < deleteInfoList.length; i++) {
            const deleteInfo = deleteInfoList[i];
            const {
              startRow,
              endRow,
              totalCell,
              zeroCell,
              totalValue,
              zeroValue
            } = deleteInfo;
            const rowCount = endRow - startRow + 1;

            addLog(
              `ğŸ—‘ï¸ [${i + 1}/${
                deleteInfoList.length
              }] åˆ é™¤ç¬¬${startRow}-${endRow}è¡Œ (å…±${rowCount}è¡Œ)`,
              "warning"
            );
            addLog(
              `   â””â”€ åˆè®¡å•å…ƒæ ¼: ${totalCell}="${totalValue}", é›¶å€¼å•å…ƒæ ¼: ${zeroCell}="${zeroValue}"`,
              "info"
            );

            try {
              // è®°å½•åˆ é™¤çš„è¡ŒèŒƒå›´
              deletedRowRanges.push({
                startRow: startRow,
                endRow: endRow
              });

              // ä½¿ç”¨ExcelJSçš„spliceRowsæ–¹æ³•åˆ é™¤è¡Œ
              // spliceRows(startRow, deleteCount, ...insertRows)
              worksheet.spliceRows(startRow, rowCount);
              totalDeletedRows += rowCount;

              addLog(`   âœ… æˆåŠŸåˆ é™¤ç¬¬${startRow}-${endRow}è¡Œ`, "success");
            } catch (deleteError) {
              addLog(
                `   âŒ åˆ é™¤ç¬¬${startRow}-${endRow}è¡Œå¤±è´¥: ${deleteError.message}`,
                "error"
              );
              throw deleteError;
            }
          }

          // ç¬¬ä¸‰æ­¥ï¼šæ¢å¤åˆå¹¶å•å…ƒæ ¼
          if (totalDeletedRows > 0 && mergedCellsInfo.length > 0) {
            addLog(
              `ğŸ”— å¼€å§‹æ¢å¤åˆå¹¶å•å…ƒæ ¼ (åˆ é™¤äº†${totalDeletedRows}è¡Œ)...`,
              "info"
            );
            restoreMergedCells(
              worksheet,
              mergedCellsInfo,
              deletedRowRanges,
              workbook
            );
          } else if (mergedCellsInfo.length === 0) {
            addLog(`â„¹ï¸ å·¥ä½œè¡¨ä¸­æ²¡æœ‰åˆå¹¶å•å…ƒæ ¼ï¼Œè·³è¿‡æ¢å¤æ­¥éª¤`, "info");
          }

          addLog(
            `âœ… "è´¦å•æ¦‚è§ˆ"å·¥ä½œè¡¨å¤„ç†å®Œæˆï¼å…±åˆ é™¤ ${totalDeletedRows} è¡Œï¼Œå‰©ä½™ ${worksheet.actualRowCount} è¡Œ`,
            "success"
          );

          return totalDeletedRows; // è¿”å›åˆ é™¤çš„è¡Œæ•°
        } catch (error) {
          addLog(
            `âŒ å¤„ç†"è´¦å•æ¦‚è§ˆ"å·¥ä½œè¡¨æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`,
            "error"
          );
          console.error("processAccountSummarySheeté”™è¯¯è¯¦æƒ…:", error);
          throw error;
        }
      }

      function cleanCustomerName(name) {
        if (!name || typeof name !== "string") {
          return "";
        }

        // å»é™¤é¦–å°¾ç©ºç™½
        let cleanedName = name.trim();

        // å»é™¤å„ç§å‰ç¼€ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºå¤„ç†ï¼‰
        const prefixesToRemove = [
          // VIPç‰¹æ˜“è¡Œç›¸å…³å‰ç¼€
          "VIPç‰¹æ˜“è¡Œ",
          "vipç‰¹æ˜“è¡Œ",
          "Vipç‰¹æ˜“è¡Œ",
          "VIP ç‰¹æ˜“è¡Œ",
          "vip ç‰¹æ˜“è¡Œ",
          "Vip ç‰¹æ˜“è¡Œ",
          // æˆéƒ½ç‰¹æ˜“è¡Œå‰ç¼€
          "æˆéƒ½ç‰¹æ˜“è¡Œ",
          "æˆéƒ½ ç‰¹æ˜“è¡Œ",
          // å·®æ—…ç®¡å®¶-VIPå‰ç¼€
          "å·®æ—…ç®¡å®¶-VIP",
          "å·®æ—…ç®¡å®¶-vip",
          "å·®æ—…ç®¡å®¶-Vip",
          "å·®æ—…ç®¡å®¶ -VIP",
          "å·®æ—…ç®¡å®¶ -vip",
          "å·®æ—…ç®¡å®¶ - VIP",
          "å·®æ—…ç®¡å®¶ - vip",
          "å·®æ—…ç®¡å®¶VIP",
          "å·®æ—…ç®¡å®¶vip",
          "å·®æ—…ç®¡å®¶ VIP",
          "å·®æ—…ç®¡å®¶ vip"
        ];

        for (const prefix of prefixesToRemove) {
          if (cleanedName.startsWith(prefix)) {
            cleanedName = cleanedName.substring(prefix.length).trim();
            break;
          }
        }

        // å»é™¤å…¶ä»–å¯èƒ½çš„å‰ç¼€ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•ï¼‰
        const otherPrefixes = [
          "ç‰¹æ˜“è¡Œ",
          "ç‰¹æ˜“è¡Œ ",
          "å·®æ—…ç®¡å®¶-",
          "å·®æ—…ç®¡å®¶ -",
          "å·®æ—…ç®¡å®¶ - ",
          "å·®æ—…ç®¡å®¶",
          "å·®æ—…ç®¡å®¶ ",
          "VIP",
          "VIP ",
          "vip",
          "vip "
        ];

        for (const prefix of otherPrefixes) {
          if (cleanedName.startsWith(prefix)) {
            cleanedName = cleanedName.substring(prefix.length).trim();
            break;
          }
        }

        // ç¡®ä¿æ¸…ç†åçš„åç§°ä¸ä¸ºç©º
        return cleanedName || name.trim();
      }

      async function processExcelData(data) {
        if (!data || data.length === 0) {
          addLog("Excelæ–‡ä»¶ä¸ºç©º", "error");
          return;
        }

        let newCustomers = [];
        let duplicateCount = 0;

        // ä»ç¬¬äºŒè¡Œå¼€å§‹è¯»å–æ•°æ®ï¼ˆå‡è®¾ç¬¬ä¸€è¡Œæ˜¯æ ‡é¢˜ï¼‰
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (row && row[0]) {
            // å‡è®¾å®¢æˆ·åç§°åœ¨ç¬¬ä¸€åˆ—
            let customerName = String(row[0]).trim();

            // å¤„ç†å®¢æˆ·åç§°ï¼šå»é™¤"VIPç‰¹æ˜“è¡Œ"å‰ç¼€
            const originalName = customerName;
            customerName = cleanCustomerName(customerName);

            if (customerName) {
              // å¦‚æœåç§°è¢«ä¿®æ”¹äº†ï¼Œè®°å½•æ—¥å¿—
              if (originalName !== customerName) {
                addLog(
                  `åç§°å¤„ç†: "${originalName}" â†’ "${customerName}"`,
                  "info"
                );
              }

              // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
              if (
                customerConfig &&
                customerConfig.hasOwnProperty(customerName)
              ) {
                duplicateCount++;
              } else {
                newCustomers.push(customerName);
              }
            }
          }
        }

        if (newCustomers.length === 0) {
          addLog(`æ²¡æœ‰å‘ç°æ–°å®¢æˆ·ï¼Œé‡å¤å®¢æˆ·: ${duplicateCount}ä¸ª`, "info");
          return;
        }

        // æ˜¾ç¤ºé¢„è§ˆå¹¶è¯¢é—®ç”¨æˆ·æ˜¯å¦ç¡®è®¤å¯¼å…¥
        const confirmMessage = `
            å‡†å¤‡å¯¼å…¥ ${
              newCustomers.length
            } ä¸ªæ–°å®¢æˆ·ï¼Œé‡å¤å®¢æˆ·: ${duplicateCount}ä¸ª

            æ–°å¢å®¢æˆ·åˆ—è¡¨ï¼š
            ${newCustomers.slice(0, 10).join("\n")}${
              newCustomers.length > 10
                ? "\n...(è¿˜æœ‰" + (newCustomers.length - 10) + "ä¸ª)"
                : ""
            }

            æ˜¯å¦ç¡®è®¤å¯¼å…¥ï¼Ÿ`;

        if (confirm(confirmMessage)) {
          // å¢é‡æ·»åŠ åˆ°é…ç½®ä¸­
          if (!customerConfig) {
            customerConfig = {};
          }

          newCustomers.forEach(customerName => {
            customerConfig[customerName] = "";
          });

          addLog(
            `âœ“ æˆåŠŸå¯¼å…¥ ${newCustomers.length} ä¸ªæ–°å®¢æˆ·ï¼Œé‡å¤å®¢æˆ·: ${duplicateCount}ä¸ª`,
            "success"
          );
          addLog(
            `æ–°å¢å®¢æˆ·: ${newCustomers.slice(0, 5).join(", ")}${
              newCustomers.length > 5 ? "..." : ""
            }`,
            "info"
          );

          // é…ç½®å·²åœ¨å†…å­˜ä¸­æ›´æ–°ï¼Œä¿å­˜åˆ°æœ¬åœ°å¹¶åˆ·æ–°æ˜¾ç¤º
          addLog("âœ“ é…ç½®å·²æ›´æ–°å®Œæˆï¼Œç«‹å³ç”Ÿæ•ˆï¼", "success");

          // ä¿å­˜åˆ°æœ¬åœ°JSONæ–‡ä»¶
          saveConfigToLocal();

          displayCustomerList();
        } else {
          addLog("ç”¨æˆ·å–æ¶ˆå¯¼å…¥æ“ä½œ", "info");
        }
      }

      function exportCurrentConfig() {
        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          alert("æ²¡æœ‰å¯å¯¼å‡ºçš„é…ç½®æ•°æ®");
          return;
        }

        const configJson = JSON.stringify(customerConfig, null, 2);
        const blob = new Blob([configJson], { type: "application/json" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `download_config_${new Date()
          .toISOString()
          .slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        addLog("âœ“ å½“å‰é…ç½®å·²å¯¼å‡º", "success");
      }

      function downloadTemplate() {
        // åˆ›å»ºExcelæ¨¡æ¿æ•°æ®
        const templateData = [
          ["å®¢æˆ·åç§°"], // æ ‡é¢˜è¡Œ
          ["å¹¿ä¸œé‡‘ä¸½å£°å±•ç¤ºè®¾å¤‡æœ‰é™å…¬å¸"],
          ["VIPç‰¹æ˜“è¡Œæ·±åœ³å¸‚æµ·æŸ”åˆ›æ–°ç§‘æŠ€æœ‰é™å…¬å¸"], // ç¤ºä¾‹ï¼šVIPç‰¹æ˜“è¡Œå‰ç¼€
          ["æˆéƒ½ç‰¹æ˜“è¡Œæ·±åœ³å¸‚ä¼˜å¿…é€‰ç§‘æŠ€æœ‰é™å…¬å¸"], // ç¤ºä¾‹ï¼šæˆéƒ½ç‰¹æ˜“è¡Œå‰ç¼€
          ["å·®æ—…ç®¡å®¶-VIPæ·±åœ³å¸‚æ˜Šä¸€æºç§‘æŠ€æœ‰é™å…¬å¸"], // ç¤ºä¾‹ï¼šå·®æ—…ç®¡å®¶-VIPå‰ç¼€
          ["å¦é—¨äº¿è”ç½‘ç»œæŠ€æœ¯è‚¡ä»½æœ‰é™å…¬å¸"],
          ["VIP ç‰¹æ˜“è¡Œæ·±åœ³å¸‚é•¿å¸†ä¾›åº”é“¾æœ‰é™å…¬å¸"], // ç¤ºä¾‹ï¼šå¸¦ç©ºæ ¼çš„å‰ç¼€
          ["å·®æ—…ç®¡å®¶ -VIPå¹¿ä¸œä¸œæ–¹ç²¾å·¥ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸"] // ç¤ºä¾‹ï¼šå·®æ—…ç®¡å®¶å¸¦ç©ºæ ¼å‰ç¼€
        ];

        // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(templateData);

        // è®¾ç½®åˆ—å®½
        ws["!cols"] = [{ width: 40 }];

        // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
        XLSX.utils.book_append_sheet(wb, ws, "å®¢æˆ·åˆ—è¡¨");

        // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
        XLSX.writeFile(wb, "å®¢æˆ·åˆ—è¡¨æ¨¡æ¿.xlsx");

        addLog("âœ“ Excelæ¨¡æ¿å·²ä¸‹è½½", "success");
      }

      async function queryAllCustomerBills(event = null) {
        // é˜²æ­¢ä»»ä½•é»˜è®¤è¡Œä¸º
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        const token = document.getElementById("token").value.trim();

        if (!token) {
          alert("è¯·è¾“å…¥Token");
          return;
        }

        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨æŸ¥è¯¢
        if (isQuerying) {
          alert("æ­£åœ¨æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨åå†è¯•");
          return;
        }

        // å¦‚æœé…ç½®ä¸ºç©ºï¼Œå…ˆå°è¯•åŠ è½½æœ¬åœ°é…ç½®
        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          addLog("æ­£åœ¨åŠ è½½æœ¬åœ°é…ç½®...", "info");
          await loadLocalConfig();

          // åŠ è½½åå†æ¬¡æ£€æŸ¥
          if (!customerConfig || Object.keys(customerConfig).length === 0) {
            alert("æ— æ³•åŠ è½½å®¢æˆ·é…ç½®ï¼Œè¯·æ£€æŸ¥ download_config.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨");
            return;
          }
        }

        // è®¾ç½®æŸ¥è¯¢çŠ¶æ€
        isQuerying = true;
        shouldStopQuery = false;

        const queryBtn = document.getElementById("queryBtn");
        const stopBtn = document.getElementById("stopBtn");

        queryBtn.disabled = true;
        queryBtn.textContent = "æŸ¥è¯¢ä¸­...";
        stopBtn.style.display = "inline-block";

        const resultsDiv = document.getElementById("customerResults");
        const tableDiv = document.getElementById("customerBillsTable");
        const resultsTitle = document.getElementById("resultsTitle");

        try {
          resultsDiv.style.display = "block";
          resultsTitle.textContent = "æŸ¥è¯¢è¿›è¡Œä¸­...";

          // åˆå§‹åŒ–è¡¨æ ¼ï¼Œæ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·çš„æŸ¥è¯¢çŠ¶æ€
          initializeQueryTable();

          let allResults = [];
          let completedCount = 0;
          let noDataCount = 0; // æœªæŸ¥åˆ°è´¦å•çš„å®¢æˆ·æ•°é‡
          let failedCount = 0; // æŸ¥è¯¢å¤±è´¥çš„å®¢æˆ·æ•°é‡
          const totalCount = Object.keys(customerConfig).length;

          for (const customerName of Object.keys(customerConfig)) {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åœæ­¢æŸ¥è¯¢
            if (shouldStopQuery) {
              addLog("æŸ¥è¯¢å·²è¢«ç”¨æˆ·åœæ­¢", "info");
              break;
            }

            try {
              addLog(`æ­£åœ¨æŸ¥è¯¢å®¢æˆ·: ${customerName}`, "info");

              // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æŸ¥è¯¢ä¸­"
              updateCustomerStatus(customerName, "æŸ¥è¯¢ä¸­", "info");

              const response = await fetch(
                "https://staff-api-gateway.teyixing.com/admin/v1/finance/getCreditBills",
                {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                    Accept: "application/json, text/plain, */*"
                  },
                  body: JSON.stringify({
                    corpNameLike: customerName,
                    status: null,
                    overdue: null,
                    pageNumber: 1,
                    pageSize: 10
                  })
                }
              );

              // æ£€æŸ¥401é”™è¯¯ï¼ˆTokenè¿‡æœŸï¼‰

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              const data = await response.json();
              if (data.code === 401) {
                addLog("Tokenå·²è¿‡æœŸï¼Œåœæ­¢æŸ¥è¯¢", "error");
                alert(
                  "Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼\n\næŸ¥è¯¢å·²åœæ­¢ï¼Œè¯·ç‚¹å‡»'ä¸€é”®ç™»å½•'é‡æ–°è·å–Tokenã€‚"
                );
                clearTokenAndLogin();
                shouldStopQuery = true;
                break;
              }
              if (
                data.data &&
                data.data.content &&
                data.data.content.length > 0
              ) {
                // åªå–ç¬¬ä¸€æ¡è®°å½•
                const firstRecord = data.data.content[0];
                const result = {
                  customerName: customerName,
                  ...firstRecord
                };
                allResults.push(result);

                // æ›´æ–°è¯¥å®¢æˆ·çš„è´¦å•ä¿¡æ¯
                updateCustomerBillInfo(customerName, result);
                addLog(`âœ“ æŸ¥è¯¢æˆåŠŸ: ${customerName}`, "success");
              } else {
                // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æœªæŸ¥åˆ°è´¦å•"
                updateCustomerStatus(customerName, "æœªæŸ¥åˆ°è´¦å•", "warning");
                // ä¸ºæœªæŸ¥åˆ°è´¦å•çš„å®¢æˆ·æ·»åŠ æ“ä½œæŒ‰é’®
                addActionButtonsForCustomer(customerName);
                addLog(`âš  æœªæ‰¾åˆ°æ•°æ®: ${customerName}`, "info");
                noDataCount++; // ç»Ÿè®¡æœªæŸ¥åˆ°è´¦å•çš„å®¢æˆ·
              }

              // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
              await new Promise(resolve => setTimeout(resolve, 500));
            } catch (error) {
              // æ›´æ–°è¯¥å®¢æˆ·çš„çŠ¶æ€ä¸º"æŸ¥è¯¢å¤±è´¥"
              updateCustomerStatus(customerName, "æŸ¥è¯¢å¤±è´¥", "error");
              // ä¸ºæŸ¥è¯¢å¤±è´¥çš„å®¢æˆ·æ·»åŠ æ“ä½œæŒ‰é’®
              addActionButtonsForCustomer(customerName);
              addLog(`âœ— æŸ¥è¯¢å¤±è´¥: ${customerName} - ${error.message}`, "error");
              failedCount++; // ç»Ÿè®¡æŸ¥è¯¢å¤±è´¥çš„å®¢æˆ·
            }

            completedCount++;
            // æ›´æ–°æ€»ä½“è¿›åº¦
            resultsTitle.textContent = `æŸ¥è¯¢è¿›åº¦: ${completedCount}/${totalCount} (å·²å®Œæˆ${Math.round(
              (completedCount / totalCount) * 100
            )}%)`;
          }

          // æŸ¥è¯¢å®Œæˆï¼Œé‡ç½®çŠ¶æ€
          isQuerying = false;
          shouldStopQuery = false;

          queryBtn.disabled = false;
          queryBtn.textContent = "æŸ¥è¯¢å…¨éƒ¨è´¦å•";
          stopBtn.style.display = "none";

          // æ›´æ–°æ ‡é¢˜å’Œä¿å­˜ç»“æœ
          queryResults = allResults;

          // ç»Ÿè®¡èƒ½ä¸‹è½½çš„å®¢æˆ·æ•°é‡ï¼ˆdebtAmount > 0ï¼‰
          const downloadableCount = allResults.filter(record => {
            const debtAmount = parseFloat(record.debtAmount) || 0;
            return debtAmount > 0;
          }).length;

          if (shouldStopQuery) {
            resultsTitle.innerHTML = `æŸ¥è¯¢å·²åœæ­¢ (å·²æŸ¥åˆ°${allResults.length}æ¡è´¦å•ï¼ŒæœªæŸ¥åˆ°${noDataCount}æ¡ï¼Œå¤±è´¥${failedCount}æ¡ï¼Œå¯ä¸‹è½½${downloadableCount}æ¡ )`;
          } else {
            resultsTitle.innerHTML = `æŸ¥è¯¢å®Œæˆ (å…±æŸ¥åˆ°${allResults.length}æ¡è´¦å•ï¼ŒæœªæŸ¥åˆ°${noDataCount}æ¡ï¼Œå¤±è´¥${failedCount}æ¡ï¼Œå¯ä¸‹è½½${downloadableCount}æ¡ )`;
          }

          // æ˜¾ç¤ºæ‰¹é‡ä¸‹è½½æŒ‰é’®
          const batchDownloadBtn = document.getElementById("batchDownloadBtn");
          if (allResults.length > 0) {
            batchDownloadBtn.style.display = "inline-block";
          }

          addLog(
            `æŸ¥è¯¢${shouldStopQuery ? "åœæ­¢" : "å®Œæˆ"}ï¼Œå…±æŸ¥åˆ° ${
              allResults.length
            } æ¡è´¦å•ï¼ŒæœªæŸ¥åˆ° ${noDataCount} æ¡ï¼Œå¤±è´¥ ${failedCount} æ¡ï¼Œå¯ä¸‹è½½ ${downloadableCount} æ¡`,
            shouldStopQuery ? "info" : "success"
          );
        } catch (error) {
          // å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯ï¼Œé‡ç½®çŠ¶æ€
          isQuerying = false;
          shouldStopQuery = false;

          queryBtn.disabled = false;
          queryBtn.textContent = "æŸ¥è¯¢å…¨éƒ¨è´¦å•";
          stopBtn.style.display = "none";

          addLog(`æŸ¥è¯¢è¿‡ç¨‹å‘ç”Ÿé”™è¯¯: ${error.message}`, "error");
        }
      }

      function displayResults(results) {
        const tableDiv = document.getElementById("customerBillsTable");
        const resultsTitle = document.getElementById("resultsTitle");

        // ä¿å­˜æŸ¥è¯¢ç»“æœç”¨äºæ‰¹é‡ä¸‹è½½
        queryResults = results;

        // æ›´æ–°æ ‡é¢˜
        resultsTitle.textContent = `æŸ¥è¯¢ç»“æœ (å…±${results.length}æ¡):`;

        if (results.length === 0) {
          tableDiv.innerHTML = "<p>æœªæŸ¥è¯¢åˆ°ä»»ä½•æ•°æ®</p>";
          return;
        }

        let tableHTML = `
                      <table class="customer-table">
                        <thead>
                          <tr>
                            <th>å®¢æˆ·åç§°</th>
                            <th>è´¦å•ç¼–å·</th>
                            <th>å‡ºè´¦æ—¥</th>
                            <th>è´¦å•èµ·å§‹æ—¥</th>
                            <th>è´¦å•æˆªæ­¢æ—¥</th>
                            <th>æœ€è¿Ÿè¿˜æ¬¾æ—¥</th>
                            <th>è´¦å•é‡‘é¢</th>
                            <th>å·²è¿˜é‡‘é¢</th>
                            <th>å¾…è¿˜é‡‘é¢</th>
                            <th>è¿˜æ¬¾æ—¥æœŸ</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                          </tr>
                        </thead>
                        <tbody>
                    `;

        results.forEach(record => {
          tableHTML += `
                        <tr>
                          <td>${record.customerName}</td>
                          <td>${record.billNo || ""}</td>
                          <td>${record.billDate || ""}</td>
                          <td>${record.billStartDate || ""}</td>
                          <td>${record.billEndDate || ""}</td>
                          <td>${record.latestRepayDate || ""}</td>
                          <td>Â¥${record.billAmount || 0}</td>
                          <td>Â¥${record.paidAmount || 0}</td>
                          <td>Â¥${record.debtAmount || 0}</td>
                          <td>${record.repayDate || ""}</td>
                          <td>${record.status || ""}</td>
                          <td><button onclick="downloadBill('${
                            record.billId
                          }')" style="font-size: 12px; padding: 2px 8px;">ä¸‹è½½</button></td>
                        </tr>
                      `;
        });

        tableHTML += "</tbody></table>";
        tableDiv.innerHTML = tableHTML;

        // æ˜¾ç¤ºæ‰¹é‡ä¸‹è½½æŒ‰é’®
        const batchDownloadBtn = document.getElementById("batchDownloadBtn");
        if (results.length > 0) {
          batchDownloadBtn.style.display = "inline-block";
        }

        addLog(`æŸ¥è¯¢å®Œæˆï¼Œå…±æ‰¾åˆ° ${results.length} æ¡è®°å½•`, "success");
      }

      async function downloadBill(
        billId,
        customerName,
        billNo,
        debtAmount,
        billStartDate,
        billEndDate
      ) {
        const token = document.getElementById("token").value.trim();

        try {
          // æ£€æŸ¥å¾…è¿˜é‡‘é¢
          const debt = parseFloat(debtAmount) || 0;
          if (debt <= 0) {
            alert(`å®¢æˆ· ${customerName} çš„å¾…è¿˜é‡‘é¢ä¸º Â¥${debt}ï¼Œæ— éœ€ä¸‹è½½è´¦å•`);
            addLog(`è·³è¿‡ä¸‹è½½: ${customerName} - å¾…è¿˜é‡‘é¢ä¸º Â¥${debt}`, "info");
            return;
          }

          addLog(`å¼€å§‹ä¸‹è½½è´¦å•: ${customerName} (å¾…è¿˜é‡‘é¢: Â¥${debt})`, "info");

          const removeZeroRecords =
            document.getElementById("removeZeroRecords").checked;

          const response = await fetch(
            `https://staff-api-gateway.teyixing.com/admin/v1/finance/downloadCorpBill?billId=${billId}&removeZeroRecords=${removeZeroRecords}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
                Accept: "application/json, text/plain, */*"
              },
              body: "{}"
            }
          );

          // æ£€æŸ¥401é”™è¯¯ï¼ˆTokenè¿‡æœŸï¼‰
          if (response.status === 401) {
            addLog("Tokenå·²è¿‡æœŸï¼Œä¸‹è½½å¤±è´¥", "error");
            alert(
              "Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼\n\nè¯·ç‚¹å‡»'ä¸€é”®ç™»å½•'é‡æ–°è·å–Tokenåå†è¯•ã€‚"
            );
            clearTokenAndLogin();
            return;
          }

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;

          // ç”Ÿæˆæ–‡ä»¶åï¼šä½¿ç”¨è¡¨æ ¼ä¸­æ˜¾ç¤ºçš„æ–‡ä»¶åæ ¼å¼
          const fileName =
            generateFileName(customerName, billStartDate, billEndDate) +
            ".xlsx";

          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog(`âœ“ æˆåŠŸä¸‹è½½è´¦å•: ${customerName}`, "success");
        } catch (error) {
          addLog(`âœ— ä¸‹è½½å¤±è´¥: ${customerName} - ${error.message}`, "error");
        }
      }

      async function batchDownloadFromTable(event = null) {
        // é˜²æ­¢ä»»ä½•é»˜è®¤è¡Œä¸º
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        if (isDownloading) {
          showToast(`æ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ`, "error");
          return;
        }

        if (!queryResults || queryResults.length === 0) {
          showToast(`æ²¡æœ‰å¯ä¸‹è½½çš„è´¦å•æ•°æ®`, "error");
          return;
        }

        // è¿‡æ»¤å‡ºdebtAmountå¤§äº0çš„å®¢æˆ·
        const filteredResults = queryResults.filter(record => {
          const debtAmount = parseFloat(record.debtAmount) || 0;
          return debtAmount > 0;
        });

        if (filteredResults.length === 0) {
          showToast(`æ²¡æœ‰å¾…è¿˜é‡‘é¢å¤§äº0çš„å®¢æˆ·éœ€è¦ä¸‹è½½`, "error");
          return;
        }

        addLog(
          `å…±${queryResults.length}æ¡æŸ¥è¯¢ç»“æœï¼Œå…¶ä¸­${filteredResults.length}æ¡æœ‰å¾…è¿˜é‡‘é¢éœ€è¦ä¸‹è½½`,
          "info"
        );

        const token = document.getElementById("token").value.trim();
        if (!token) {
          alert("è¯·è¾“å…¥Token");
          return;
        }

        isDownloading = true;
        shouldStopDownload = false; // é‡ç½®åœæ­¢æ ‡å¿—
        document.getElementById("progressDialog").style.display = "flex";

        addLog(`å¼€å§‹æ‰¹é‡ä¸‹è½½ï¼Œå…± ${filteredResults.length} ä¸ªè´¦å•`, "info");
        addLog("æ­£åœ¨æ‰“åŒ…æ–‡ä»¶ï¼Œè¯·ç¨å€™...", "info");
        updateProgress(0, filteredResults.length);

        const zip = new JSZip();
        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < filteredResults.length; i++) {
          // æ£€æŸ¥æ˜¯å¦éœ€è¦åœæ­¢ä¸‹è½½
          if (shouldStopDownload) {
            addLog("ä¸‹è½½å·²è¢«ç”¨æˆ·å–æ¶ˆ", "info");
            break;
          }

          const record = filteredResults[i];
          try {
            addLog(
              `æ­£åœ¨ä¸‹è½½: ${record.customerName} - ${
                record.billNo || record.id
              }`,
              "info"
            );

            // åˆ›å»ºæ–°çš„AbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
            downloadAbortController = new AbortController();

            const removeZeroRecords =
              document.getElementById("removeZeroRecords").checked;

            const response = await fetch(
              `https://staff-api-gateway.teyixing.com/admin/v1/finance/downloadCorpBill?billId=${record.billId}&removeZeroRecords=${removeZeroRecords}`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                  Accept: "application/json, text/plain, */*"
                },
                body: "{}",
                signal: downloadAbortController.signal // æ·»åŠ å–æ¶ˆä¿¡å·
              }
            );

            // æ£€æŸ¥401é”™è¯¯ï¼ˆTokenè¿‡æœŸï¼‰
            if (response.status === 401) {
              addLog("Tokenå·²è¿‡æœŸï¼Œæ‰¹é‡ä¸‹è½½åœæ­¢", "error");
              alert(
                "Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼\n\næ‰¹é‡ä¸‹è½½å·²åœæ­¢ï¼Œè¯·ç‚¹å‡»'ä¸€é”®ç™»å½•'é‡æ–°è·å–Tokenåå†è¯•ã€‚"
              );
              clearTokenAndLogin();
              isDownloading = false;
              shouldStopDownload = false;
              downloadAbortController = null;
              document.getElementById("progressDialog").style.display = "none";
              return;
            }

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const blob = await response.blob();
            // ç”Ÿæˆæ–‡ä»¶åï¼šä½¿ç”¨è¡¨æ ¼ä¸­æ˜¾ç¤ºçš„æ–‡ä»¶åæ ¼å¼
            const fileName =
              generateFileName(
                record.customerName,
                record.billStartDate,
                record.billEndDate
              ) + ".xlsx";

            // æ·»åŠ æ–‡ä»¶åˆ°ZIPåŒ…
            zip.file(fileName, blob);

            addLog(`âœ“ æˆåŠŸè·å–: ${record.customerName}`, "success");
            successCount++;
          } catch (error) {
            if (error.name === "AbortError") {
              addLog(`ä¸‹è½½è¢«å–æ¶ˆ: ${record.customerName}`, "info");
              break; // è·³å‡ºå¾ªç¯ï¼Œåœæ­¢åç»­ä¸‹è½½
            } else {
              addLog(
                `âœ— ä¸‹è½½å¤±è´¥: ${record.customerName} - ${error.message}`,
                "error"
              );
              failCount++;
            }
          }

          updateProgress(i + 1, filteredResults.length);

          // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
          if (i < filteredResults.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }

        if (successCount > 0) {
          addLog("æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...", "info");

          // ç”ŸæˆZIPæ–‡ä»¶
          const zipBlob = await zip.generateAsync({ type: "blob" });

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const url = window.URL.createObjectURL(zipBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `å®¢æˆ·è´¦å•_${new Date().toISOString().slice(0, 10)}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog("âœ“ ZIPæ–‡ä»¶å·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½", "success");
        }

        addLog(
          `æ‰¹é‡ä¸‹è½½å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±è´¥: ${failCount}`,
          successCount > 0 ? "success" : "info"
        );

        // é‡ç½®ä¸‹è½½æ§åˆ¶çŠ¶æ€
        shouldStopDownload = false;
        downloadAbortController = null;
        isDownloading = false;
      }

      async function batchDownloadChalvguanjiaFromTable(event = null) {
        // é˜²æ­¢ä»»ä½•é»˜è®¤è¡Œä¸º
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        if (isDownloading) {
          showToast(`æ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ`, "error");
          return;
        }

        if (!queryResults || queryResults.length === 0) {
          showToast(`æ²¡æœ‰å¯ä¸‹è½½çš„è´¦å•æ•°æ®`, "error");
          return;
        }

        // è¿‡æ»¤å‡ºå·®æ—…ç®¡å®¶ä¸”debtAmountå¤§äº0çš„å®¢æˆ·
        const filteredResults = queryResults.filter(record => {
          const debtAmount = parseFloat(record.debtAmount) || 0;
          // ä»customerConfigä¸­è·å–ç³»ç»Ÿåç§°
          const customerData = customerConfig[record.customerName];
          const systemName =
            customerData && customerData.system
              ? customerData.system
              : "ç‰¹æ˜“è¡Œ";
          return debtAmount > 0 && systemName.includes("å·®æ—…ç®¡å®¶");
        });

        if (filteredResults.length === 0) {
          showToast(`æ²¡æœ‰å·®æ—…ç®¡å®¶å®¢æˆ·çš„å¾…è¿˜é‡‘é¢å¤§äº0çš„è´¦å•éœ€è¦ä¸‹è½½`, "error");
          return;
        }

        addLog(
          `å…±${queryResults.length}æ¡æŸ¥è¯¢ç»“æœï¼Œå…¶ä¸­${filteredResults.length}æ¡å·®æ—…ç®¡å®¶å®¢æˆ·æœ‰å¾…è¿˜é‡‘é¢éœ€è¦ä¸‹è½½`,
          "info"
        );

        const token = document.getElementById("token").value.trim();
        if (!token) {
          alert("è¯·è¾“å…¥Token");
          return;
        }

        isDownloading = true;
        shouldStopDownload = false; // é‡ç½®åœæ­¢æ ‡å¿—
        document.getElementById("progressDialog").style.display = "flex";

        addLog(
          `å¼€å§‹æ‰¹é‡ä¸‹è½½å·®æ—…ç®¡å®¶è´¦å•ï¼Œå…± ${filteredResults.length} ä¸ªè´¦å•`,
          "info"
        );
        addLog("æ­£åœ¨æ‰“åŒ…æ–‡ä»¶ï¼Œè¯·ç¨å€™...", "info");
        updateProgress(0, filteredResults.length);

        const zip = new JSZip();
        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < filteredResults.length; i++) {
          // æ£€æŸ¥æ˜¯å¦éœ€è¦åœæ­¢ä¸‹è½½
          if (shouldStopDownload) {
            addLog("ä¸‹è½½å·²è¢«ç”¨æˆ·å–æ¶ˆ", "info");
            break;
          }

          const record = filteredResults[i];
          try {
            addLog(
              `æ­£åœ¨ä¸‹è½½å·®æ—…ç®¡å®¶è´¦å•: ${record.customerName} - ${
                record.billNo || record.id
              }`,
              "info"
            );

            // åˆ›å»ºæ–°çš„AbortControllerç”¨äºå–æ¶ˆè¯·æ±‚
            downloadAbortController = new AbortController();

            const response = await fetch(
              `https://staff-api-gateway.teyixing.com/admin/v1/finance/downloadCorpBill?billId=${record.billId}`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                  Accept: "application/json, text/plain, */*"
                },
                body: "{}",
                signal: downloadAbortController.signal // æ·»åŠ å–æ¶ˆä¿¡å·
              }
            );

            // æ£€æŸ¥401é”™è¯¯ï¼ˆTokenè¿‡æœŸï¼‰
            if (response.status === 401) {
              addLog("Tokenå·²è¿‡æœŸï¼Œæ‰¹é‡ä¸‹è½½åœæ­¢", "error");
              alert(
                "Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼\n\næ‰¹é‡ä¸‹è½½å·²åœæ­¢ï¼Œè¯·ç‚¹å‡»'ä¸€é”®ç™»å½•'é‡æ–°è·å–Tokenåå†è¯•ã€‚"
              );
              clearTokenAndLogin();
              isDownloading = false;
              shouldStopDownload = false;
              downloadAbortController = null;
              document.getElementById("progressDialog").style.display = "none";
              return;
            }

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const blob = await response.blob();
            // ç”Ÿæˆæ–‡ä»¶åï¼šä½¿ç”¨è¡¨æ ¼ä¸­æ˜¾ç¤ºçš„æ–‡ä»¶åæ ¼å¼ï¼Œå¹¶æ·»åŠ å·®æ—…ç®¡å®¶æ ‡è¯†
            const fileName =
              generateFileName(
                record.customerName,
                record.billStartDate,
                record.billEndDate
              ) + ".xlsx";

            // æ·»åŠ æ–‡ä»¶åˆ°ZIPåŒ…
            zip.file(fileName, blob);

            addLog(`âœ“ æˆåŠŸè·å–å·®æ—…ç®¡å®¶è´¦å•: ${record.customerName}`, "success");
            successCount++;
          } catch (error) {
            if (error.name === "AbortError") {
              addLog(`ä¸‹è½½è¢«å–æ¶ˆ: ${record.customerName}`, "info");
              break; // è·³å‡ºå¾ªç¯ï¼Œåœæ­¢åç»­ä¸‹è½½
            } else {
              addLog(
                `âœ— ä¸‹è½½å¤±è´¥: ${record.customerName} - ${error.message}`,
                "error"
              );
              failCount++;
            }
          }

          updateProgress(i + 1, filteredResults.length);

          // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
          if (i < filteredResults.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }

        if (successCount > 0) {
          addLog("æ­£åœ¨ç”Ÿæˆå·®æ—…ç®¡å®¶è´¦å•ZIPæ–‡ä»¶...", "info");

          // ç”ŸæˆZIPæ–‡ä»¶
          const zipBlob = await zip.generateAsync({ type: "blob" });

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const url = window.URL.createObjectURL(zipBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `å·®æ—…ç®¡å®¶è´¦å•_${new Date().toISOString().slice(0, 10)}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog("âœ“ å·®æ—…ç®¡å®¶è´¦å•ZIPæ–‡ä»¶å·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½", "success");
        }

        addLog(
          `å·®æ—…ç®¡å®¶è´¦å•æ‰¹é‡ä¸‹è½½å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±è´¥: ${failCount}`,
          successCount > 0 ? "success" : "info"
        );

        // é‡ç½®ä¸‹è½½æ§åˆ¶çŠ¶æ€
        shouldStopDownload = false;
        downloadAbortController = null;
        isDownloading = false;
      }

      function toggleProxyOption() {
        const useProxy = document.getElementById("useProxy").checked;
        if (useProxy) {
          addLog("å·²å¯ç”¨CORSä»£ç†æ¨¡å¼", "info");
        }
      }

      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContent");
        const logItem = document.createElement("div");
        logItem.className = `log-item log-${type}`;
        logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(logItem);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function updateProgress(current, total) {
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        const progressDetails = document.getElementById("progressDetails");
        const percentage = Math.round((current / total) * 100);

        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;
        progressDetails.textContent = `æ­£åœ¨ä¸‹è½½: ${current}/${total} ä¸ªæ–‡ä»¶`;

        // ä¸‹è½½å®Œæˆæ—¶éšè—dialog
        if (current >= total) {
          setTimeout(() => {
            document.getElementById("progressDialog").style.display = "none";
            isDownloading = false;
          }, 1500); // 1.5ç§’åè‡ªåŠ¨å…³é—­
        }
      }

      function cancelDownload() {
        if (confirm("ç¡®å®šè¦å–æ¶ˆä¸‹è½½å—ï¼Ÿ")) {
          // è®¾ç½®åœæ­¢æ ‡å¿—
          shouldStopDownload = true;

          // å–æ¶ˆå½“å‰çš„ç½‘ç»œè¯·æ±‚
          if (downloadAbortController) {
            downloadAbortController.abort();
            downloadAbortController = null;
          }

          // éšè—è¿›åº¦å¯¹è¯æ¡†
          document.getElementById("progressDialog").style.display = "none";

          // é‡ç½®çŠ¶æ€
          isDownloading = false;

          addLog("ç”¨æˆ·å–æ¶ˆä¸‹è½½ï¼Œæ­£åœ¨åœæ­¢æ‰€æœ‰ä¸‹è½½è¯·æ±‚...", "info");
          showToast("ä¸‹è½½å·²å–æ¶ˆ", "info");
        }
      }

      async function downloadFile(billId, token, index, total) {
        try {
          addLog(`å¼€å§‹ä¸‹è½½ ID: ${billId}`, "info");

          const useProxy = document.getElementById("useProxy").checked;
          const removeZeroRecords =
            document.getElementById("removeZeroRecords").checked;
          let apiUrl = `https://staff-api-gateway.teyixing.com/admin/v1/finance/downloadCorpBill?billId=${billId}&removeZeroRecords=${removeZeroRecords}`;

          // å¦‚æœä½¿ç”¨ä»£ç†ï¼Œæ·»åŠ ä»£ç†å‰ç¼€
          if (useProxy) {
            apiUrl = `https://cors-anywhere.herokuapp.com/${apiUrl}`;
          }

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
              Accept: "application/json, text/plain, */*",
              ...(useProxy && { "X-Requested-With": "XMLHttpRequest" })
            },
            body: "{}",
            mode: "cors"
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `bill_${billId}.xlsx`; // ä¿®æ”¹ä¸ºxlsxæ–‡ä»¶
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog(`âœ“ æˆåŠŸä¸‹è½½ ID: ${billId}`, "success");
          updateProgress(index + 1, total);

          return true;
        } catch (error) {
          addLog(`âœ— ä¸‹è½½å¤±è´¥ ID: ${billId} - ${error.message}`, "error");
          updateProgress(index + 1, total);
          return false;
        }
      }

      // æ·»åŠ æ ·å¼è®¾ç½®è¡¨å•çš„äº‹ä»¶ç›‘å¬å™¨
      function addStyleSettingsEventListeners() {
        const formElements = [
          "fontSize",
          "fontFamily",
          "fontColor",
          "rowHeight",
          "columnWidth",
          "horizontalAlign",
          "verticalAlign",
          "addBorders",
          "borderStyle",
          "borderColor"
        ];

        formElements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("change", updateStylePreview);
            element.addEventListener("input", updateStylePreview);
          }
        });
      }

      // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æœ¬åœ°é…ç½®
      window.addEventListener("DOMContentLoaded", function () {
        addLog("é¡µé¢åŠ è½½å®Œæˆï¼Œæ­£åœ¨è‡ªåŠ¨åŠ è½½æœ¬åœ°é…ç½®...", "info");

        // å…ˆå°è¯•åŠ è½½æœ¬åœ°é…ç½®
        loadLocalConfig().catch(error => {
          addLog(`è‡ªåŠ¨åŠ è½½é…ç½®å¤±è´¥: ${error.message}`, "error");
          // å¦‚æœè‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨åŠ è½½æç¤º
          const resultsDiv = document.getElementById("customerResults");
          const tableDiv = document.getElementById("customerBillsTable");
          resultsDiv.style.display = "block";
          tableDiv.innerHTML = `
                  <div style="text-align: center; padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; margin: 10px 0;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">âš ï¸ æ— æ³•è‡ªåŠ¨åŠ è½½å®¢æˆ·é…ç½®</h4>
                    <p style="color: #856404; margin: 0 0 15px 0;">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰‹åŠ¨åŠ è½½å®¢æˆ·åˆ—è¡¨</p>
                    <button onclick="loadLocalConfig(true)" style="background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                      æ‰‹åŠ¨åŠ è½½å®¢æˆ·åˆ—è¡¨
                    </button>
                  </div>
                `;
        });

        // åŠ è½½Excelæ ·å¼è®¾ç½®
        loadStyleSettingsFromStorage();

        // æ·»åŠ æ ·å¼è®¾ç½®è¡¨å•çš„äº‹ä»¶ç›‘å¬å™¨
        addStyleSettingsEventListeners();

        // æ¢å¤è¡¨æ ¼æŠ˜å çŠ¶æ€
        restoreTableCollapseState();

        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„token
        const savedToken = localStorage.getItem("userToken");
        const savedUser = localStorage.getItem("userInfo");

        if (savedToken && savedUser) {
          try {
            currentUser = JSON.parse(savedUser);
            document.getElementById("token").value = savedToken;

            const loginBtn = document.getElementById("loginBtn");
            const loginStatus = document.getElementById("loginStatus");

            loginBtn.textContent = "é‡æ–°ç™»å½•";
            loginBtn.style.backgroundColor = "#28a745";
            loginBtn.disabled = false;
            loginStatus.textContent = `æ¬¢è¿å›æ¥ï¼Œ${currentUser.staff.name}`;
            loginStatus.style.color = "#28a745";

            addLog(`âœ“ è‡ªåŠ¨æ¢å¤ç™»å½•çŠ¶æ€: ${currentUser.staff.name}`, "success");

            // æ˜¾ç¤ºè‡ªåŠ¨æ¢å¤ç™»å½•çš„toastæç¤º
            showToast(`æ¬¢è¿å›æ¥ï¼Œ${currentUser.staff.name}`, "info", 2000);
          } catch (error) {
            // æ¸…é™¤æ— æ•ˆçš„ä¿å­˜æ•°æ®
            localStorage.removeItem("userToken");
            localStorage.removeItem("userInfo");
          }
        }
      });

      // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
      document.addEventListener("keydown", function (event) {
        // Ctrl+F èšç„¦åˆ°ç­›é€‰æ¡†
        if (event.ctrlKey && event.key === "f") {
          event.preventDefault();
          const filterInput = document.getElementById("customerFilter");
          const filterSection = document.getElementById(
            "customerFilterSection"
          );

          if (filterSection && filterSection.style.display !== "none") {
            filterInput.focus();
            filterInput.select();
          }
        }

        // ESC æ¸…é™¤ç­›é€‰
        if (event.key === "Escape") {
          const filterInput = document.getElementById("customerFilter");
          if (filterInput && document.activeElement === filterInput) {
            clearFilter();
            filterInput.blur();
          }
        }
      });
    </script>
  </body>
</html>
