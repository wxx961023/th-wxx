<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>批量下载文件</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        min-height: 100vh;
      }
      .container {
        background-color: white;
        padding: 20px;
        margin: 0;
        min-height: 100vh;
        box-sizing: border-box;
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-row {
        display: flex;
        gap: 20px;
        align-items: flex-end;
        flex-wrap: wrap;
      }
      .form-row .form-group {
        flex: 1;
        min-width: 200px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      input[type="text"],
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      textarea {
        height: 120px;
        resize: vertical;
      }
      .button-group {
        text-align: center;
        margin-top: 30px;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 0 5px;
        min-width: 120px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      /* 进度条Dialog样式 */
      .progress-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      /* 样式设置Dialog样式 */
      .style-settings-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10001;
      }

      .progress-dialog-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        width: 450px;
        max-width: 90vw;
        animation: dialogSlideIn 0.3s ease;
      }

      .style-settings-dialog-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        width: 900px;
        max-width: 95vw;
        max-height: 80vh;
        overflow-y: auto;
        animation: dialogSlideIn 0.3s ease;
      }

      @keyframes dialogSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .progress-dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e0e0e0;
      }

      .progress-dialog-header h3 {
        margin: 0;
        color: #333;
        font-size: 18px;
        font-weight: 600;
      }

      .progress-dialog-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .progress-dialog-close:hover {
        background-color: #f5f5f5;
        color: #333;
      }

      .progress-dialog-body {
        padding: 24px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        margin-bottom: 16px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #45a049);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 4px;
      }

      #progressText {
        text-align: center;
        font-weight: 600;
        color: #333;
        font-size: 16px;
        margin-bottom: 8px;
      }

      .progress-details {
        text-align: center;
        color: #666;
        font-size: 14px;
      }

      /* 异常出账日样式 */
      .abnormal-bill-date {
        background-color: #ffebee !important;
        color: #c62828 !important;
        font-weight: bold;
      }

      /* 异常出账日期格子样式 */
      .abnormal-bill-date-cell {
        background-color: #ffebee !important;
        color: #c62828 !important;
        font-weight: bold;
      }

      /* 未查到账单的整行样式 */
      .no-bill-found-row {
        background-color: #fff3cd !important;
      }

      .no-bill-found-row td {
        background-color: #fff3cd !important;
        color: #856404 !important;
        font-weight: 500;
      }

      /* 表格内按钮样式优化 */
      .table-btn {
        min-width: 50px;
        height: 28px;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 500;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-right: 4px;
        color: white;
        text-align: center;
        line-height: 1.2;
      }

      .table-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .table-btn:active {
        transform: translateY(0);
      }

      .table-btn.download {
        background-color: #28a745;
        min-width: 45px;
      }

      .table-btn.download:hover {
        background-color: #218838;
      }

      .table-btn.query {
        background-color: #17a2b8;
        min-width: 45px;
      }

      .table-btn.query:hover {
        background-color: #138496;
      }

      .table-btn.edit {
        background-color: #ffc107;
        color: #212529;
        min-width: 45px;
      }

      .table-btn.edit:hover {
        background-color: #e0a800;
      }

      .table-btn.delete {
        background-color: #dc3545;
        min-width: 45px;
      }

      .table-btn.delete:hover {
        background-color: #c82333;
      }

      .table-btn.detail {
        background-color: #6f42c1;
        min-width: 45px;
      }

      .table-btn.detail:hover {
        background-color: #5a32a3;
      }

      .table-btn.disabled {
        background-color: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.6;
      }

      .table-btn.disabled:hover {
        background-color: #6c757d !important;
        transform: none !important;
        box-shadow: none !important;
      }

      /* 系统列样式 */
      .system-name {
        font-size: 12px;
        color: #666;
        background-color: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        text-align: center;
        font-weight: 500;
      }

      .system-name.system-teyixing {
        background-color: #e3f2fd;
        color: #1976d2;
      }

      .system-name.system-other {
        background-color: #f3e5f5;
        color: #7b1fa2;
      }

      /* 文件名列样式 */
      .file-name {
        font-family: "Courier New", monospace;
        font-size: 12px;
        color: #495057;
        background-color: #f8f9fa;
        padding: 4px 6px;
        border-radius: 3px;
        white-space: nowrap;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .log {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        display: block;
      }
      .log-item {
        margin-bottom: 5px;
        padding: 4px 8px;
        border-radius: 3px;
        background-color: rgba(255, 255, 255, 0.5);
        border-left: 3px solid #ddd;
      }
      .log-success {
        color: #28a745;
        border-left-color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
      }
      .log-error {
        color: #dc3545;
        border-left-color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
      }
      .log-info {
        color: #17a2b8;
        border-left-color: #17a2b8;
        background-color: rgba(23, 162, 184, 0.1);
      }
      .log-warning {
        color: #ffc107;
        border-left-color: #ffc107;
        background-color: rgba(255, 193, 7, 0.1);
      }
      .customer-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 14px;
      }
      .customer-table th,
      .customer-table td {
        border: 1px solid #ddd;
        padding: 12px 8px;
        text-align: left;
        font-size: 13px;
        white-space: nowrap;
      }
      .customer-table th {
        background-color: #f8f9fa;
        font-weight: bold;
      }
      .customer-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .customer-table tr:hover {
        background-color: #f5f5f5;
      }

      /* Excel导入区域样式 */
      .import-section {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 15px;
        margin: 20px 0;
      }

      input[type="file"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
      }

      /* 状态样式 */
      .status {
        font-weight: bold;
      }

      .customer-table .status {
        text-align: center;
      }

      /* 客户名称编辑样式 */
      .customer-name-cell {
        position: relative;
      }

      .customer-name-edit {
        width: 100%;
        padding: 4px;
        border: 1px solid #007bff;
        border-radius: 3px;
        font-size: 13px;
      }

      .edit-btn,
      .delete-btn {
        font-size: 12px;
        padding: 2px 8px;
        margin-right: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }

      .edit-btn {
        background-color: #007bff;
        color: white;
      }

      .delete-btn {
        background-color: #dc3545;
        color: white;
      }

      .edit-btn:hover {
        background-color: #0056b3;
      }

      .delete-btn:hover {
        background-color: #c82333;
      }

      /* 登录区域样式 */
      .login-section {
        margin-bottom: 20px;
      }

      #loginBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      #loginStatus {
        font-weight: 500;
      }

      /* 筛选功能样式 */
      #customerFilter {
        transition: border-color 0.3s ease;
      }

      #customerFilter:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      #filterStatus {
        white-space: nowrap;
      }

      /* 操作按钮样式 */
      .action button {
        border: none;
        border-radius: 3px;
        cursor: pointer;
        color: white;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .action button:hover {
        opacity: 0.8;
        transform: translateY(-1px);
      }

      .action button:active {
        transform: translateY(0);
      }

      /* Toast提示样式 */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10002;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }

      .toast.success {
        background-color: #28a745;
      }

      .toast.error {
        background-color: #dc3545;
      }

      .toast.info {
        background-color: #17a2b8;
      }

      .toast.warning {
        background-color: #ffc107;
        color: #212529;
      }

      /* 样式设置表单样式 */
      .style-form-group {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .style-form-group label {
        min-width: 120px;
        margin-bottom: 0;
        font-weight: 500;
        color: #333;
      }

      .style-form-group input,
      .style-form-group select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .style-form-group input:focus,
      .style-form-group select:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .style-checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .style-checkbox-group input[type="checkbox"] {
        margin: 0;
        transform: scale(1.2);
      }

      .style-preview {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin: 15px 0;
      }

      .style-preview h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 14px;
      }

      .style-preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .style-preview-table td {
        border: 1px solid #000;
        padding: 8px;
        text-align: center;
      }

      /* 表格折叠功能样式 */
      .table-content-area {
        transition: all 0.3s ease;
        overflow: hidden;
      }

      .table-content-area.collapsed {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
      }

      .table-content-area.expanded {
        max-height: none;
        opacity: 1;
      }

      .collapse-btn {
        transition: all 0.2s ease;
      }

      .collapse-btn:hover {
        background-color: #5a6268 !important;
        transform: translateY(-1px);
      }

      .collapse-btn.collapsed {
        background-color: #28a745 !important;
      }

      .collapse-btn.collapsed:hover {
        background-color: #218838 !important;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
        }
        .form-row .form-group {
          min-width: auto;
        }
        .customer-table {
          font-size: 11px;
        }
        .customer-table th,
        .customer-table td {
          padding: 6px 4px;
        }
        .style-settings-dialog-content {
          width: 98vw;
          margin: 5px;
        }
        .style-form-group {
          flex-direction: column;
          align-items: flex-start;
        }
        .style-form-group label {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>客户账单查询与批量下载</h1>
      <p
        style="
          text-align: center;
          color: #666;
          margin-top: -10px;
          font-size: 14px;
        "
      >
        支持Excel批量导入客户，配置实时生效
      </p>

      <!-- 登录区域 -->
      <div class="login-section" id="loginSection">
        <div
          class="form-row"
          style="
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
          "
        >
          <div class="form-group" style="margin-bottom: 0">
            <button
              onclick="performLogin()"
              id="loginBtn"
              style="background-color: #28a745; min-width: 150px"
            >
              一键登录
            </button>
          </div>
          <div class="form-group" style="margin-bottom: 0">
            <span
              id="loginStatus"
              style="
                color: #666;
                font-size: 14px;
                line-height: 38px;
                margin-left: 15px;
              "
            >
              未登录
            </span>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="token">Token:</label>
          <input
            style="width: 350px"
            type="text"
            value="cb9c5482-1aa9-464d-8e68-8f086599c7b9"
            id="token"
            placeholder="请输入访问token"
            required
          />
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button
            onclick="loadLocalConfig(true)"
            style="background-color: #28a745"
          >
            手动加载客户列表
          </button>
        </div>
      </div>

      <div
        class="form-row"
        style="border-top: 1px solid #ddd; padding-top: 20px; margin-top: 20px"
      >
        <div class="form-group">
          <label for="excelFile">导入Excel客户列表:</label>
          <input
            type="file"
            id="excelFile"
            accept=".xlsx,.xls"
            onchange="handleExcelFile()"
          />
          <small style="color: #666; display: block; margin-top: 5px">
            选择包含客户名称的Excel文件（支持.xlsx/.xls格式）<br />
            系统会自动去除"VIP特易行"、"成都特易行"、"差旅管家-VIP"等前缀，导入后立即生效
            <a
              href="#"
              onclick="downloadTemplate()"
              style="color: #007bff; text-decoration: underline"
              >下载模板</a
            >
          </small>
        </div>

        <div class="form-group">
          <label>&nbsp;</label>
          <button onclick="exportCurrentConfig()">导出当前配置</button>
        </div>

        <div class="form-group">
          <label for="styleExcelFile">Excel样式修改:</label>
          <input
            type="file"
            id="styleExcelFile"
            accept=".xlsx,.xls"
            onchange="handleStyleExcelFile()"
          />
          <small style="color: #666; display: block; margin-top: 5px">
            上传Excel文件，自动修改样式。支持自定义字号、行高、字体等设置
            <br />
            <button
              onclick="showStyleSettings()"
              style="
                background-color: #17a2b8;
                color: white;
                border: none;
                padding: 2px 8px;
                border-radius: 3px;
                font-size: 12px;
                margin-top: 3px;
              "
            >
              样式设置
            </button>
          </small>
        </div>

        <div class="form-group">
          <label for="zipFile">批量Excel处理 (ZIP文件):</label>
          <input
            type="file"
            id="zipFile"
            accept=".zip"
            onchange="handleZipFile()"
          />
          <small style="color: #666; display: block; margin-top: 5px">
            上传包含多个Excel文件的ZIP压缩包，批量应用样式修改
            <br />
            <span style="color: #28a745">✓ 自动处理ZIP包内所有.xlsx文件</span
            ><br />
            <span style="color: #28a745">✓ 保持原始文件名和目录结构</span><br />
            <span style="color: #28a745">✓ 忽略非Excel文件</span>
          </small>

          <!-- ZIP批量处理进度条 -->
          <div
            id="zipProgressContainer"
            style="display: none; margin-top: 15px"
          >
            <div style="margin-bottom: 8px">
              <span id="zipProgressText" style="font-size: 14px; color: #333"
                >准备处理...</span
              >
              <span
                id="zipProgressPercent"
                style="float: right; font-size: 14px; color: #666"
                >0%</span
              >
            </div>
            <div
              style="
                width: 100%;
                background-color: #f0f0f0;
                border-radius: 4px;
                overflow: hidden;
              "
            >
              <div
                id="zipProgressBar"
                style="
                  width: 0%;
                  height: 20px;
                  background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
                  transition: width 0.3s ease;
                  border-radius: 4px;
                "
              ></div>
            </div>
            <div
              id="zipProgressDetails"
              style="margin-top: 8px; font-size: 12px; color: #666"
            >
              <span id="zipCurrentFile"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group" id="customerResults" style="display: none">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <div style="display: flex; align-items: center; gap: 10px">
            <h3 style="margin: 0" id="resultsTitle">客户列表:</h3>
            <button
              onclick="toggleTableCollapse()"
              id="collapseBtn"
              class="collapse-btn"
              style="
                background-color: #6c757d;
                color: white;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                min-width: 60px;
              "
              title="折叠/展开表格区域"
            >
              折叠
            </button>
          </div>
          <button
            onclick="batchDownloadFromTable()"
            id="batchDownloadBtn"
            style="display: none; width: 0px; height: 0px"
          >
            打包下载所有账单(ZIP)
          </button>
        </div>

        <!-- 表格内容区域 -->
        <div id="tableContentArea" class="table-content-area expanded">
          <!-- 客户筛选区域 -->
          <div
            id="customerFilterSection"
            style="
              margin-bottom: 15px;
              padding: 10px;
              background-color: #f8f9fa;
              border-radius: 5px;
              display: none;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <div style="display: flex; align-items: center; gap: 10px">
                <label style="font-weight: bold; margin-bottom: 0"
                  >筛选条件:</label
                >
                <select
                  id="filterType"
                  onchange="applyFilter()"
                  style="
                    padding: 6px 8px;
                    border-radius: 4px;
                    border: 1px solid #ddd;
                  "
                >
                  <option value="all">全部客户</option>
                  <option value="downloadable">可下载客户</option>
                  <option value="no-debt">无待还金额</option>
                  <option value="no-data">未查到账单</option>
                  <option value="failed">查询失败</option>
                  <option value="teyixing">特易行</option>
                  <option value="chalvguanjia">差旅管家</option>
                </select>
              </div>

              <div
                style="display: flex; align-items: center; gap: 10px; flex: 1"
              >
                <label
                  for="customerFilter"
                  style="font-weight: bold; margin-bottom: 0"
                  >筛选客户:</label
                >
                <input
                  type="text"
                  id="customerFilter"
                  placeholder="输入客户名称进行筛选..."
                  style="
                    flex: 1;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                  oninput="filterCustomers()"
                />
                <button
                  onclick="clearFilter()"
                  style="background-color: #6c757d; padding: 8px 12px"
                >
                  清除
                </button>
              </div>

              <span
                id="filterStatus"
                style="color: #666; font-size: 14px"
              ></span>
            </div>
          </div>

          <!-- 操作按钮区域 -->
          <div
            id="actionButtonsSection"
            style="
              margin-bottom: 15px;
              padding: 10px;
              background-color: #f8f9fa;
              border-radius: 5px;
              display: none;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button
                onclick="loadLocalConfig(true)"
                style="background-color: #007bff"
              >
                刷新客户列表
              </button>
              <button onclick="queryAllCustomerBills()" id="queryBtn">
                查询全部账单
              </button>
              <button
                onclick="stopQuery()"
                id="stopBtn"
                style="background-color: #dc3545; display: none"
              >
                停止查询
              </button>
              <button
                onclick="batchDownloadFromTable()"
                style="background-color: #007bff"
              >
                打包下载所有账单(ZIP)
              </button>
              <button
                onclick="batchDownloadChalvguanjiaFromTable()"
                style="background-color: #28a745"
              >
                打包下载差旅管家账单(ZIP)
              </button>
              <label
                style="
                  margin-left: 20px;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                "
              >
                <input
                  type="checkbox"
                  id="removeZeroRecords"
                  onchange="toggleRemoveZeroRecords()"
                />
                <span>移除零记录</span>
              </label>
            </div>
          </div>

          <div id="customerBillsTable"></div>
        </div>
      </div>

      <!-- 进度条Dialog -->
      <div class="progress-dialog" id="progressDialog">
        <div class="progress-dialog-content">
          <div class="progress-dialog-header">
            <h3>批量下载进度</h3>
            <button class="progress-dialog-close" onclick="cancelDownload()">
              &times;
            </button>
          </div>
          <div class="progress-dialog-body">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">准备中...</div>
            <div class="progress-details">
              <span id="progressDetails">正在准备下载...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 样式设置Dialog -->
      <div class="style-settings-dialog" id="styleSettingsDialog">
        <div class="style-settings-dialog-content">
          <div class="progress-dialog-header">
            <h3>Excel样式设置</h3>
            <button class="progress-dialog-close" onclick="hideStyleSettings()">
              &times;
            </button>
          </div>
          <div class="progress-dialog-body">
            <form id="styleSettingsForm">
              <!-- 基本设置 -->
              <h4
                style="
                  margin: 0 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                基本设置
              </h4>

              <div class="style-form-group">
                <label for="startFromSheet">起始工作表:</label>
                <select id="startFromSheet">
                  <option value="1">第1个工作表</option>
                  <option value="2" selected>第2个工作表</option>
                  <option value="3">第3个工作表</option>
                </select>
              </div>

              <div class="style-checkbox-group">
                <input type="checkbox" id="processAllSheets" checked />
                <label for="processAllSheets">处理所有后续工作表</label>
              </div>

              <!-- 字体设置 -->
              <h4
                style="
                  margin: 20px 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                字体设置
              </h4>

              <div class="style-form-group">
                <label for="fontFamily">字体:</label>
                <select id="fontFamily">
                  <option value="宋体" selected>宋体</option>
                  <option value="微软雅黑">微软雅黑</option>
                  <option value="Arial">Arial</option>
                  <option value="Calibri">Calibri</option>
                  <option value="Times New Roman">Times New Roman</option>
                </select>
              </div>

              <div class="style-form-group">
                <label for="fontSize">字号:</label>
                <input
                  type="number"
                  id="fontSize"
                  value="10"
                  min="6"
                  max="72"
                  step="1"
                />
              </div>

              <div class="style-form-group">
                <label for="fontColor">字体颜色:</label>
                <input type="color" id="fontColor" value="#000000" />
              </div>

              <!-- 行列设置 -->
              <h4
                style="
                  margin: 20px 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                行列设置
              </h4>

              <div class="style-form-group">
                <label for="rowHeight">行高(磅):</label>
                <input
                  type="number"
                  id="rowHeight"
                  value="22"
                  min="10"
                  max="100"
                  step="1"
                />
              </div>

              <div class="style-form-group">
                <label for="columnWidth">列宽(字符):</label>
                <input
                  type="number"
                  id="columnWidth"
                  value=""
                  min="1"
                  max="50"
                  step="0.5"
                  placeholder="不设置则保持原有宽度"
                />
              </div>

              <!-- 对齐设置 -->
              <h4
                style="
                  margin: 20px 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                对齐设置
              </h4>

              <div class="style-form-group">
                <label for="horizontalAlign">水平对齐:</label>
                <select id="horizontalAlign">
                  <option value="left" selected>左对齐</option>
                  <option value="center">居中</option>
                  <option value="right">右对齐</option>
                </select>
              </div>

              <div class="style-form-group">
                <label for="verticalAlign">垂直对齐:</label>
                <select id="verticalAlign">
                  <option value="top">顶部对齐</option>
                  <option value="middle" selected>居中对齐</option>
                  <option value="bottom">底部对齐</option>
                </select>
              </div>

              <!-- 边框设置 -->
              <h4
                style="
                  margin: 20px 0 15px 0;
                  color: #333;
                  border-bottom: 1px solid #eee;
                  padding-bottom: 8px;
                "
              >
                边框设置
              </h4>

              <div class="style-checkbox-group">
                <input type="checkbox" id="addBorders" checked />
                <label for="addBorders">添加边框</label>
              </div>

              <div class="style-form-group">
                <label for="borderStyle">边框样式:</label>
                <select id="borderStyle">
                  <option value="thin" selected>细线</option>
                  <option value="medium">中等</option>
                  <option value="thick">粗线</option>
                  <option value="dotted">点线</option>
                  <option value="dashed">虚线</option>
                </select>
              </div>

              <div class="style-form-group">
                <label for="borderColor">边框颜色:</label>
                <input type="color" id="borderColor" value="#000000" />
              </div>

              <!-- 预览 -->
              <div class="style-preview">
                <h4>样式预览</h4>
                <table class="style-preview-table" id="stylePreviewTable">
                  <tr>
                    <td>示例文本</td>
                    <td>Sample Text</td>
                  </tr>
                  <tr>
                    <td>数字123</td>
                    <td>Number 456</td>
                  </tr>
                </table>
              </div>

              <!-- 按钮 -->
              <div
                style="
                  text-align: center;
                  margin-top: 20px;
                  padding-top: 15px;
                  border-top: 1px solid #eee;
                "
              >
                <button
                  type="button"
                  onclick="resetStyleSettings()"
                  style="background-color: #6c757d; margin-right: 10px"
                >
                  重置默认
                </button>
                <button
                  type="button"
                  onclick="hideStyleSettings()"
                  style="background-color: #dc3545; margin-right: 10px"
                >
                  取消
                </button>
                <button
                  type="button"
                  onclick="saveStyleSettings()"
                  style="background-color: #28a745"
                >
                  保存设置
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 账单明细Dialog -->
      <div
        class="style-settings-dialog"
        id="billDetailDialog"
        style="display: none"
      >
        <div class="style-settings-dialog-content">
          <div class="progress-dialog-header">
            <h3>账单明细</h3>
            <button class="progress-dialog-close" onclick="hideBillDetail()">
              &times;
            </button>
          </div>
          <div class="progress-dialog-body">
            <div
              id="billDetailLoading"
              style="text-align: center; padding: 20px; display: none"
            >
              <div
                style="
                  display: inline-block;
                  width: 20px;
                  height: 20px;
                  border: 3px solid #f3f3f3;
                  border-top: 3px solid #007bff;
                  border-radius: 50%;
                  animation: spin 1s linear infinite;
                "
              ></div>
              <p style="margin-top: 10px; color: #666">正在加载账单明细...</p>
            </div>
            <div
              id="billDetailContent"
              style="max-height: 60vh; overflow-y: auto"
            >
              <!-- 账单明细内容将在这里动态加载 -->
            </div>
            <div
              id="billDetailError"
              style="
                display: none;
                text-align: center;
                padding: 20px;
                color: #dc3545;
              "
            >
              <!-- 错误信息将在这里显示 -->
            </div>
          </div>
        </div>
      </div>

      <div class="log" id="logContainer">
        <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px">
          📋 操作日志
        </h4>
        <div id="logContent"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
      let isDownloading = false;
      let shouldStopDownload = false; // 停止下载标志
      let downloadAbortController = null; // 下载请求控制器
      let customerConfig = {};
      let queryResults = []; // 存储查询结果用于批量下载
      let currentUser = null; // 存储当前登录用户信息
      let projectDirectoryHandle = null; // 存储项目目录句柄
      let isQuerying = false; // 查询状态标志
      let shouldStopQuery = false; // 停止查询标志
      let originalCustomerList = []; // 存储原始客户列表用于筛选
      let currentFilter = ""; // 当前筛选条件

      // Excel样式设置
      let excelStyleSettings = {
        startFromSheet: 2,
        processAllSheets: true,
        fontFamily: "宋体",
        fontSize: 10,
        fontColor: "#000000",
        rowHeight: 22,
        columnWidth: null,
        horizontalAlign: "left",
        verticalAlign: "middle",
        addBorders: true,
        borderStyle: "thin",
        borderColor: "#000000"
      };

      // 表格折叠状态
      let isTableCollapsed = false;

      function formatDateTime(dateTimeStr) {
        if (!dateTimeStr || dateTimeStr === "-") {
          return "-";
        }

        try {
          // 处理各种可能的时间格式
          let date;

          // 如果包含 'T' 说明是ISO格式
          if (dateTimeStr.includes("T")) {
            date = new Date(dateTimeStr);
          }
          // 如果包含 'Z' 说明是UTC格式
          else if (dateTimeStr.includes("Z")) {
            date = new Date(dateTimeStr);
          }
          // 其他格式尝试直接解析
          else {
            date = new Date(dateTimeStr);
          }

          // 检查日期是否有效
          if (isNaN(date.getTime())) {
            return dateTimeStr; // 如果无法解析，返回原始字符串
          }

          // 格式化为 YYYY-MM-DD
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");

          return `${year}-${month}-${day}`;
        } catch (error) {
          // 如果格式化失败，返回原始字符串
          return dateTimeStr;
        }
      }

      function generateFileName(customerName, billStartDate, billEndDate) {
        if (
          !billStartDate ||
          !billEndDate ||
          billStartDate === "-" ||
          billEndDate === "-"
        ) {
          return "-";
        }

        try {
          // 解析日期
          const startDate = new Date(billStartDate);
          const endDate = new Date(billEndDate);

          if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            return "-";
          }

          // 格式化为 M.D 格式
          const startMonth = startDate.getMonth() + 1;
          const startDay = startDate.getDate();
          const endMonth = endDate.getMonth() + 1;
          const endDay = endDate.getDate();

          // 获取客户配置中的fileName，如果没有则使用完整客户名
          const customerData = customerConfig[customerName];
          const displayName =
            customerData && customerData.fileName
              ? customerData.fileName
              : customerName;

          // 生成文件名：fileName+起始日期-截止日期
          return `${displayName}${startMonth}.${startDay}-${endMonth}.${endDay}`;
        } catch (error) {
          return "-";
        }
      }

      function isAbnormalBillDate(billDateStr) {
        if (!billDateStr || billDateStr === "-") {
          return false;
        }

        try {
          const billDate = new Date(billDateStr);
          if (isNaN(billDate.getTime())) {
            return false;
          }

          // 检查是否为当月1号
          return billDate.getDate() !== 1;
        } catch (error) {
          return false;
        }
      }

      function showToast(message, type = "success", duration = 3000) {
        // 移除已存在的toast
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        // 创建新的toast元素
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        // 添加到页面
        document.body.appendChild(toast);

        // 显示动画
        setTimeout(() => {
          toast.classList.add("show");
        }, 100);

        // 自动隐藏
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.remove();
            }
          }, 300);
        }, duration);
      }

      // 表格折叠/展开功能
      function toggleTableCollapse() {
        const tableContentArea = document.getElementById("tableContentArea");
        const collapseBtn = document.getElementById("collapseBtn");

        if (!tableContentArea || !collapseBtn) {
          return;
        }

        isTableCollapsed = !isTableCollapsed;

        if (isTableCollapsed) {
          // 折叠表格
          tableContentArea.classList.add("collapsed");
          tableContentArea.classList.remove("expanded");
          collapseBtn.textContent = "展开";
          collapseBtn.classList.add("collapsed");
          collapseBtn.title = "展开表格区域";
        } else {
          // 展开表格
          tableContentArea.classList.remove("collapsed");
          tableContentArea.classList.add("expanded");
          collapseBtn.textContent = "折叠";
          collapseBtn.classList.remove("collapsed");
          collapseBtn.title = "折叠表格区域";
        }

        // 保存折叠状态到localStorage
        localStorage.setItem("tableCollapsed", isTableCollapsed.toString());
      }

      // 从localStorage恢复折叠状态
      function restoreTableCollapseState() {
        const saved = localStorage.getItem("tableCollapsed");
        if (saved === "true") {
          // 延迟执行，确保DOM已加载
          setTimeout(() => {
            toggleTableCollapse();
          }, 100);
        }
      }

      async function performLogin() {
        const loginBtn = document.getElementById("loginBtn");
        const loginStatus = document.getElementById("loginStatus");

        // 更新按钮状态
        loginBtn.disabled = true;
        loginBtn.textContent = "登录中...";
        loginStatus.textContent = "正在登录...";
        loginStatus.style.color = "#17a2b8";

        try {
          addLog("开始登录...", "info");

          const response = await fetch(
            "https://staff-api-gateway.teyixing.com/v1/staff/login",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json"
              },
              body: JSON.stringify({
                identity: "17688731379",
                password: "xin90879"
              })
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.code === 0 && data.data && data.data.token) {
            // 登录成功
            currentUser = data.data;

            // 保存登录信息到localStorage
            localStorage.setItem("userToken", data.data.token);
            localStorage.setItem("userInfo", JSON.stringify(data.data));

            // 自动填充token
            document.getElementById("token").value = data.data.token;

            // 更新UI状态
            loginBtn.textContent = "重新登录";
            loginBtn.style.backgroundColor = "#28a745";
            loginBtn.disabled = false;
            loginStatus.textContent = `欢迎，${data.data.staff.name} (${data.data.staff.workNo})`;
            loginStatus.style.color = "#28a745";

            addLog(`✓ 登录成功！欢迎 ${data.data.staff.name}`, "success");
            addLog(
              `Token已自动填充: ${data.data.token.substring(0, 20)}...`,
              "info"
            );
            addLog("登录状态已保存，下次访问将自动恢复", "info");

            // 显示登录成功的toast提示
            showToast(`登录成功！欢迎 ${data.data.staff.name}`, "success");
          } else {
            throw new Error(data.message || "登录失败");
          }
        } catch (error) {
          // 登录失败
          loginBtn.disabled = false;
          loginBtn.textContent = "重新登录";
          loginBtn.style.backgroundColor = "#dc3545";
          loginStatus.textContent = "登录失败";
          loginStatus.style.color = "#dc3545";

          addLog(`✗ 登录失败: ${error.message}`, "error");

          // 显示登录失败的toast提示
          showToast(`登录失败: ${error.message}`, "error");
        }
      }

      function clearTokenAndLogin() {
        // 清除token和用户信息
        document.getElementById("token").value = "";
        currentUser = null;
        localStorage.removeItem("userToken");
        localStorage.removeItem("userInfo");

        // 重置登录按钮状态
        const loginBtn = document.getElementById("loginBtn");
        const loginStatus = document.getElementById("loginStatus");

        loginBtn.textContent = "重新登录";
        loginBtn.style.backgroundColor = "#28a745";
        loginBtn.disabled = false;
        loginStatus.textContent = "Token已过期，请重新登录";
        loginStatus.style.color = "#dc3545";

        addLog("Token已过期，已清除登录信息，请重新登录", "error");
      }

      function stopQuery() {
        shouldStopQuery = true;
        isQuerying = false;

        const queryBtn = document.getElementById("queryBtn");
        const stopBtn = document.getElementById("stopBtn");
        const resultsTitle = document.getElementById("resultsTitle");

        queryBtn.disabled = false;
        queryBtn.textContent = "查询全部账单";
        stopBtn.style.display = "none";

        if (resultsTitle) {
          resultsTitle.textContent = "查询已停止";
        }

        addLog("用户手动停止查询", "info");
      }

      function filterCustomers() {
        // 如果在查询结果页面（有customer-row-开头的行），使用applyFilter
        const queryResultRows = document.querySelectorAll(
          '[id^="customer-row-"]'
        );
        if (queryResultRows.length > 0) {
          applyFilter();
          return;
        }

        // 如果在客户列表页面，使用原来的逻辑
        const filterInput = document.getElementById("customerFilter");
        const filterValue = filterInput.value.trim().toLowerCase();
        currentFilter = filterValue;

        // 获取所有客户行
        const customerRows = document.querySelectorAll(
          '[id^="customer-list-row-"]'
        );
        let visibleCount = 0;
        let totalCount = customerRows.length;

        customerRows.forEach(row => {
          const customerNameCell = row.querySelector(
            ".customer-name-display, td:nth-child(2)"
          );
          if (customerNameCell) {
            const customerName = customerNameCell.textContent.toLowerCase();

            if (filterValue === "" || customerName.includes(filterValue)) {
              row.style.display = "";
              visibleCount++;
            } else {
              row.style.display = "none";
            }
          }
        });

        // 更新筛选状态
        const filterStatus = document.getElementById("filterStatus");
        if (filterValue === "") {
          filterStatus.textContent = `显示全部 ${totalCount} 个客户`;
        } else {
          filterStatus.textContent = `找到 ${visibleCount} / ${totalCount} 个客户`;
        }
      }

      function clearFilter() {
        const filterInput = document.getElementById("customerFilter");
        const filterType = document.getElementById("filterType");
        filterInput.value = "";
        filterType.value = "all";
        currentFilter = "";
        filterCustomers();
      }

      function applyFilter() {
        const filterType = document.getElementById("filterType").value;
        const customerFilter = document
          .getElementById("customerFilter")
          .value.trim();

        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          return;
        }

        const customerNames = Object.keys(customerConfig);
        const tableBody = document.querySelector("#customerBillsTable tbody");

        if (!tableBody) {
          return;
        }

        let visibleCount = 0;
        let totalCount = customerNames.length;

        customerNames.forEach((customerName, index) => {
          const row = document.getElementById(`customer-row-${index}`);
          if (!row) return;

          let shouldShow = true;

          // 首先应用筛选条件
          if (filterType !== "all") {
            const statusCell = row.querySelector(".status");
            const unpaidAmountCell = row.querySelector(".unpaid-amount");
            const status = statusCell ? statusCell.textContent.trim() : "";
            const unpaidAmountText = unpaidAmountCell
              ? unpaidAmountCell.textContent.trim()
              : "";

            // 提取金额数值
            const debtAmount = unpaidAmountText.includes("¥")
              ? parseFloat(
                  unpaidAmountText.replace("¥", "").replace(",", "")
                ) || 0
              : 0;

            switch (filterType) {
              case "downloadable":
                shouldShow = status === "已查到" && debtAmount > 0;
                break;
              case "no-debt":
                shouldShow = status === "已查到" && debtAmount === 0;
                break;
              case "no-data":
                shouldShow = status === "未查到账单";
                break;
              case "failed":
                shouldShow = status === "查询失败";
                break;
              case "teyixing":
                // 筛选特易行客户
                const systemCellTey = row.querySelector(".system-name");
                const systemNameTey = systemCellTey
                  ? systemCellTey.textContent.trim()
                  : "";
                shouldShow = systemNameTey.includes("特易行");
                break;
              case "chalvguanjia":
                // 筛选差旅管家客户
                const systemCellClg = row.querySelector(".system-name");
                const systemNameClg = systemCellClg
                  ? systemCellClg.textContent.trim()
                  : "";
                shouldShow = systemNameClg.includes("差旅管家");
                break;
            }
          }

          // 然后应用客户名称筛选
          if (shouldShow && customerFilter) {
            shouldShow = customerName
              .toLowerCase()
              .includes(customerFilter.toLowerCase());
          }

          if (shouldShow) {
            row.style.display = "";
            visibleCount++;
          } else {
            row.style.display = "none";
          }
        });

        // 更新筛选状态
        const filterStatus = document.getElementById("filterStatus");
        const filterTypeText = document.querySelector(
          `#filterType option[value="${filterType}"]`
        ).textContent;

        if (filterType === "all" && !customerFilter) {
          filterStatus.textContent = `显示 ${visibleCount}/${totalCount} 个客户`;
        } else {
          filterStatus.textContent = `${filterTypeText} - 找到 ${visibleCount}/${totalCount} 个客户`;
        }
      }

      async function querySingleCustomer(customerName) {
        const token = document.getElementById("token").value.trim();

        if (!token) {
          alert("请输入Token");
          return;
        }

        if (isQuerying) {
          alert("正在查询中，请稍后再试");
          return;
        }

        try {
          addLog(`正在查询客户: ${customerName}`, "info");

          // 更新该客户的状态为"查询中"
          updateCustomerStatus(customerName, "查询中", "info");

          const response = await fetch(
            "https://staff-api-gateway.teyixing.com/admin/v1/finance/getCreditBills",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
                Accept: "application/json, text/plain, */*"
              },
              body: JSON.stringify({
                corpNameLike: customerName,
                status: null,
                overdue: null,
                pageNumber: 1,
                pageSize: 10
              })
            }
          );

          // 检查401错误（Token过期）
          if (response.status === 401) {
            addLog("Token已过期", "error");
            alert(
              "Token已过期，请重新登录！\n\n请点击'一键登录'重新获取Token。"
            );
            clearTokenAndLogin();
            return;
          }

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.data && data.data.content && data.data.content.length > 0) {
            // 只取第一条记录
            const firstRecord = data.data.content[0];
            const result = {
              customerName: customerName,
              ...firstRecord
            };

            // 更新该客户的账单信息
            updateCustomerBillInfo(customerName, result);

            // 更新queryResults数组，确保批量下载包含此结果
            updateQueryResults(result);

            addLog(`✓ 查询成功: ${customerName}`, "success");
            showToast(`查询成功: ${customerName}`, "success");
          } else {
            // 更新该客户的状态为"未查到账单"
            updateCustomerStatus(customerName, "未查到账单", "warning");
            // 为未查到账单的客户添加操作按钮
            addActionButtonsForCustomer(customerName);
            addLog(`⚠ 未找到数据: ${customerName}`, "info");
            showToast(`未查到账单: ${customerName}`, "warning");
          }
        } catch (error) {
          // 更新该客户的状态为"查询失败"
          updateCustomerStatus(customerName, "查询失败", "error");
          // 为查询失败的客户添加操作按钮
          addActionButtonsForCustomer(customerName);
          addLog(`✗ 查询失败: ${customerName} - ${error.message}`, "error");
          showToast(`查询失败: ${customerName}`, "error");
        }
      }

      function editCustomerFromQuery(customerName) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index !== -1) {
          editCustomerName(index);
        }
      }

      function deleteCustomerFromQuery(customerName) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index !== -1) {
          deleteCustomer(index);
        }
      }

      async function querySingleCustomerFromList(customerName) {
        const token = document.getElementById("token").value.trim();

        if (!token) {
          showToast(`请输入Token`, "error");
          return;
        }

        if (isQuerying) {
          showToast(`正在查询中，请稍后再试`, "error");
          return;
        }

        try {
          // 先切换到查询结果视图
          const resultsDiv = document.getElementById("customerResults");
          const filterSection = document.getElementById(
            "customerFilterSection"
          );
          resultsDiv.style.display = "block";
          filterSection.style.display = "block";

          // 初始化查询表格
          initializeQueryTable();

          addLog(`正在查询客户: ${customerName}`, "info");

          // 更新该客户的状态为"查询中"
          updateCustomerStatus(customerName, "查询中", "info");

          const response = await fetch(
            "https://staff-api-gateway.teyixing.com/admin/v1/finance/getCreditBills",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
                Accept: "application/json, text/plain, */*"
              },
              body: JSON.stringify({
                corpNameLike: customerName,
                status: null,
                overdue: null,
                pageNumber: 1,
                pageSize: 10
              })
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          // 检查401错误（Token过期）
          if (data.code === 401) {
            addLog("Token已过期", "error");
            showToast(`Token已过期，请重新登录！`, "error");
            clearTokenAndLogin();
            return;
          }
          if (data.data && data.data.content && data.data.content.length > 0) {
            // 只取第一条记录
            const firstRecord = data.data.content[0];
            const result = {
              customerName: customerName,
              ...firstRecord
            };

            // 更新该客户的账单信息
            updateCustomerBillInfo(customerName, result);

            // 更新queryResults数组，确保批量下载包含此结果
            updateQueryResults(result);

            addLog(`✓ 查询成功: ${customerName}`, "success");
            showToast(`查询成功: ${customerName}`, "success");
          } else {
            // 更新该客户的状态为"未查到账单"
            updateCustomerStatus(customerName, "未查到账单", "warning");
            // 为未查到账单的客户添加操作按钮
            addActionButtonsForCustomer(customerName);
            addLog(`⚠ 未找到数据: ${customerName}`, "info");
            showToast(`未查到账单: ${customerName}`, "warning");
          }
        } catch (error) {
          // 更新该客户的状态为"查询失败"
          updateCustomerStatus(customerName, "查询失败", "error");
          // 为查询失败的客户添加操作按钮
          addActionButtonsForCustomer(customerName);
          addLog(`✗ 查询失败: ${customerName} - ${error.message}`, "error");
          showToast(`查询失败: ${customerName}`, "error");
        }
      }

      function updateResultsTitle() {
        if (!queryResults || queryResults.length === 0) {
          return;
        }

        const resultsTitle = document.getElementById("resultsTitle");
        const totalResults = queryResults.length;

        // 统计能下载的客户数量（debtAmount > 0）
        const downloadableCount = queryResults.filter(record => {
          const debtAmount = parseFloat(record.debtAmount) || 0;
          return debtAmount > 0;
        }).length;

        // 统计各种状态的客户数量
        const customerNames = Object.keys(customerConfig);
        let foundCount = 0;
        let noDataCount = 0;
        let failedCount = 0;

        customerNames.forEach(customerName => {
          const customerNames = Object.keys(customerConfig);
          const index = customerNames.indexOf(customerName);
          if (index !== -1) {
            const row = document.getElementById(`customer-row-${index}`);
            if (row) {
              const statusCell = row.querySelector(".status");
              const status = statusCell ? statusCell.textContent : "";

              if (status === "已查到") {
                foundCount++;
              } else if (status === "未查到账单") {
                noDataCount++;
              } else if (status === "查询失败") {
                failedCount++;
              }
            }
          }
        });

        resultsTitle.innerHTML = `查询结果 (共查到${foundCount}条账单，未查到${noDataCount}条，失败${failedCount}条，可下载${downloadableCount}条 )`;
      }

      function updateQueryResults(newResult) {
        // 如果queryResults还没有初始化，先初始化为空数组
        if (!queryResults) {
          queryResults = [];
        }

        // 查找是否已存在该客户的结果
        const existingIndex = queryResults.findIndex(
          result => result.customerName === newResult.customerName
        );

        if (existingIndex !== -1) {
          // 如果已存在，更新现有结果
          queryResults[existingIndex] = newResult;
          addLog(`更新了 ${newResult.customerName} 的查询结果`, "info");
        } else {
          // 如果不存在，添加新结果
          queryResults.push(newResult);
          addLog(`添加了 ${newResult.customerName} 的查询结果`, "info");
        }

        // 更新批量下载按钮的显示状态
        const batchDownloadBtn = document.getElementById("batchDownloadBtn");
        if (queryResults.length > 0) {
          batchDownloadBtn.style.display = "inline-block";
        }

        // 更新标题统计信息
        updateResultsTitle();
      }

      async function loadLocalConfig(
        showToastNotification = false,
        event = null
      ) {
        // 防止任何默认行为
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        try {
          const response = await fetch("./download_config.json");
          if (!response.ok) {
            throw new Error(`无法加载配置文件: ${response.status}`);
          }

          customerConfig = await response.json();
          addLog(
            `成功加载本地配置，包含 ${
              Object.keys(customerConfig).length
            } 个客户`,
            "success"
          );

          // 显示加载的客户列表
          const customerNames = Object.keys(customerConfig).join(", ");
          addLog(`客户列表: ${customerNames}`, "info");

          // 显示默认的客户列表表格
          displayCustomerList();

          // 只有手动点击按钮时才显示toast提示
          if (showToastNotification) {
            showToast(
              `刷新成功！加载了 ${Object.keys(customerConfig).length} 个客户`,
              "success"
            );
          }
        } catch (error) {
          addLog(`加载本地配置失败: ${error.message}`, "error");

          // 只有手动点击按钮时才显示toast提示
          if (showToastNotification) {
            showToast(`刷新失败: ${error.message}`, "error");
          }
        }
      }

      function displayCustomerList() {
        const resultsDiv = document.getElementById("customerResults");
        const tableDiv = document.getElementById("customerBillsTable");
        const batchDownloadBtn = document.getElementById("batchDownloadBtn");
        const resultsTitle = document.getElementById("resultsTitle");
        const filterSection = document.getElementById("customerFilterSection");
        const actionButtonsSection = document.getElementById(
          "actionButtonsSection"
        );

        resultsDiv.style.display = "block";
        batchDownloadBtn.style.display = "none"; // 隐藏批量下载按钮

        // 更新标题
        const customerCount = customerConfig
          ? Object.keys(customerConfig).length
          : 0;
        resultsTitle.textContent = `客户列表 (共${customerCount}个):`;

        // 显示筛选区域和操作按钮区域（如果有客户数据）
        if (customerCount > 0) {
          filterSection.style.display = "block";
          actionButtonsSection.style.display = "block";
        } else {
          filterSection.style.display = "none";
          actionButtonsSection.style.display = "none";
        }

        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          tableDiv.innerHTML = "<p>未加载客户配置</p>";
          return;
        }

        let tableHTML = `
                      <table class="customer-table">
                        <thead>
                          <tr>
                            <th>序号</th>
                            <th>客户名称</th>
                            <th>系统</th>
                            <th>操作</th>
                          </tr>
                        </thead>
                        <tbody>
                    `;

        const customerNames = Object.keys(customerConfig);
        customerNames.forEach((customerName, index) => {
          const customerData = customerConfig[customerName];
          const systemName =
            customerData && customerData.system
              ? customerData.system
              : "特易行";
          const systemClass =
            systemName === "特易行" ? "system-teyixing" : "system-other";

          tableHTML += `
                        <tr id="customer-list-row-${index}">
                          <td class="row-index">${index + 1}</td>
                          <td class="customer-name-cell">
                            ${customerName}
                          </td>
                          <td class="system-name ${systemClass}">${systemName}</td>
                          <td>
                            <button onclick="querySingleCustomerFromList('${customerName}')" class="table-btn query">查询</button>
                          </td>
                        </tr>
                      `;
        });

        tableHTML += "</tbody></table>";
        tableDiv.innerHTML = tableHTML;

        // 初始化筛选状态
        setTimeout(() => {
          filterCustomers();
        }, 100);
      }

      function editCustomerName(index) {
        const customerNames = Object.keys(customerConfig);
        const originalName = customerNames[index];
        const row = document.getElementById(`customer-list-row-${index}`);

        if (!row) return;

        const displaySpan = row.querySelector(".customer-name-display");
        const editInput = row.querySelector(".customer-name-edit");
        const editBtn = row.querySelector(".edit-btn");

        if (editBtn.textContent === "编辑") {
          // 进入编辑模式
          displaySpan.style.display = "none";
          editInput.style.display = "inline-block";
          editInput.focus();
          editInput.select();
          editBtn.textContent = "保存";
          editBtn.style.backgroundColor = "#28a745";
        } else {
          // 保存编辑
          const newName = editInput.value.trim();

          if (!newName) {
            alert("客户名称不能为空");
            return;
          }

          if (newName !== originalName) {
            // 检查新名称是否已存在
            if (customerConfig.hasOwnProperty(newName)) {
              alert("该客户名称已存在");
              return;
            }

            // 更新配置 - 将修改的客户移到第一位
            delete customerConfig[originalName];

            // 创建新的配置对象，将修改的客户放在第一位
            const newConfig = { [newName]: "" };
            Object.keys(customerConfig).forEach(key => {
              newConfig[key] = customerConfig[key];
            });
            customerConfig = newConfig;

            addLog(
              `客户名称已更新: "${originalName}" → "${newName}"`,
              "success"
            );

            // 保存到本地JSON文件
            saveConfigToLocal();
          }

          // 退出编辑模式
          displaySpan.textContent = newName;
          displaySpan.style.display = "inline-block";
          editInput.style.display = "none";
          editBtn.textContent = "编辑";
          editBtn.style.backgroundColor = "#007bff";

          // 刷新显示
          displayCustomerList();
        }
      }

      function deleteCustomer(index) {
        const customerNames = Object.keys(customerConfig);
        const customerName = customerNames[index];

        if (confirm(`确定要删除客户 "${customerName}" 吗？`)) {
          delete customerConfig[customerName];
          addLog(`已删除客户: ${customerName}`, "info");

          // 保存到本地JSON文件
          saveConfigToLocal();

          // 刷新显示
          displayCustomerList();
        }
      }

      function addNewCustomer(event = null) {
        // 防止任何默认行为
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        const newName = prompt("请输入新客户名称:");

        if (!newName || !newName.trim()) {
          return;
        }

        const cleanedName = cleanCustomerName(newName.trim());

        if (customerConfig.hasOwnProperty(cleanedName)) {
          alert("该客户名称已存在");
          return;
        }

        // 将新客户添加到第一位
        const newConfig = { [cleanedName]: "" };
        Object.keys(customerConfig).forEach(key => {
          newConfig[key] = customerConfig[key];
        });
        customerConfig = newConfig;

        if (newName.trim() !== cleanedName) {
          addLog(
            `客户名称已处理: "${newName.trim()}" → "${cleanedName}"`,
            "info"
          );
        }

        addLog(`已添加新客户: ${cleanedName}`, "success");

        // 保存到本地JSON文件
        saveConfigToLocal();

        // 刷新显示
        displayCustomerList();
      }

      async function saveConfigToLocal() {
        try {
          const configJson = JSON.stringify(customerConfig, null, 2);

          // 尝试通过Node.js服务器保存到本地文件
          try {
            const response = await fetch("http://localhost:3000/save_config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: configJson
            });

            if (response.ok) {
              addLog("✓ 配置已直接保存到本地文件", "success");
              showToast("配置保存成功！", "success");
              return;
            } else {
              throw new Error(`服务器返回错误: ${response.status}`);
            }
          } catch (err) {
            addLog(`无法连接到Node.js服务器: ${err.message}`, "info");
          }

          addLog("无法连接到Node.js服务器，使用浏览器保存方式", "info");

          // 降级方案：使用浏览器的文件系统访问API
          if ("showSaveFilePicker" in window) {
            try {
              const fileHandle = await window.showSaveFilePicker({
                suggestedName: "download_config.json",
                types: [
                  {
                    description: "JSON配置文件",
                    accept: { "application/json": [".json"] }
                  }
                ]
              });

              const writable = await fileHandle.createWritable();
              await writable.write(configJson);
              await writable.close();

              addLog("✓ 配置已保存，请将文件放到项目目录", "success");
              showToast("配置文件保存成功！", "success");
              return;
            } catch (err) {
              if (err.name === "AbortError") {
                addLog("用户取消保存操作", "info");
                return;
              }
            }
          }

          // 最后的降级方案：下载文件
          const blob = new Blob([configJson], { type: "application/json" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "download_config.json";
          a.style.display = "none";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog("✓ 配置文件已下载", "success");
          addLog("请将下载的文件替换项目目录中的 download_config.json", "info");
          showToast("配置文件已下载到本地！", "success");
        } catch (error) {
          addLog(`保存配置失败: ${error.message}`, "error");
          showToast(`保存失败: ${error.message}`, "error");
        }
      }

      function initializeQueryTable() {
        const tableDiv = document.getElementById("customerBillsTable");
        const batchDownloadBtn = document.getElementById("batchDownloadBtn");
        const filterSection = document.getElementById("customerFilterSection");
        const actionButtonsSection = document.getElementById(
          "actionButtonsSection"
        );

        batchDownloadBtn.style.display = "none"; // 隐藏批量下载按钮

        // 显示筛选区域和操作按钮区域
        if (customerConfig && Object.keys(customerConfig).length > 0) {
          filterSection.style.display = "block";
          actionButtonsSection.style.display = "block";
        }

        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          tableDiv.innerHTML = "<p>未加载客户配置</p>";
          return;
        }

        let tableHTML = `
                <table class="customer-table">
                  <thead>
                    <tr>
                      <th>序号</th>
                      <th>客户名称</th>
                      <th>系统</th>
                      <th>文件名</th>
                      <th>账单编号</th>
                      <th>出账日</th>
                      <th>账单起始日</th>
                      <th>账单截止日</th>
                      <th>最迟还款日</th>
                      <th>账单金额</th>
                      <th>已还金额</th>
                      <th>待还金额</th>
                      <th>还款日期</th>
                      <th>状态</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

        const customerNames = Object.keys(customerConfig);
        customerNames.forEach((customerName, index) => {
          const customerData = customerConfig[customerName];
          const systemName =
            customerData && customerData.system
              ? customerData.system
              : "特易行";
          const systemClass =
            systemName === "特易行" ? "system-teyixing" : "system-other";

          tableHTML += `
                  <tr id="customer-row-${index}">
                    <td class="row-index">${index + 1}</td>
                    <td class="customer-name">${customerName}</td>
                    <td class="system-name ${systemClass}">${systemName}</td>
                    <td class="file-name">-</td>
                    <td class="bill-no">-</td>
                    <td class="bill-date">-</td>
                    <td class="bill-start-date">-</td>
                    <td class="bill-end-date">-</td>
                    <td class="latest-repay-date">-</td>
                    <td class="bill-amount">-</td>
                    <td class="paid-amount">-</td>
                    <td class="unpaid-amount">-</td>
                    <td class="repay-date">-</td>
                    <td class="status">待查询</td>
                    <td class="action">
                      <button onclick="querySingleCustomer('${customerName}')" class="table-btn query">查询</button>
                    </td>
                  </tr>
                `;
        });

        tableHTML += "</tbody></table>";
        tableDiv.innerHTML = tableHTML;

        // 初始化筛选状态
        setTimeout(() => {
          filterCustomers();
        }, 100);
      }

      function updateCustomerStatus(customerName, status, type) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index === -1) return;

        const row = document.getElementById(`customer-row-${index}`);
        if (!row) return;

        const statusCell = row.querySelector(".status");
        statusCell.textContent = status;

        // 根据状态类型设置样式
        statusCell.className = "status";
        if (type === "error") {
          statusCell.style.color = "#dc3545";
        } else if (type === "warning") {
          statusCell.style.color = "#ffc107";
        } else if (type === "info") {
          statusCell.style.color = "#17a2b8";
        } else {
          statusCell.style.color = "#28a745";
        }

        // 根据状态处理样式
        const customerNameCell = row.querySelector(".customer-name");
        const billDateCell = row.querySelector(".bill-date");

        if (status !== "已查到") {
          // 清除异常出账日样式
          if (customerNameCell) {
            customerNameCell.classList.remove("abnormal-bill-date");
          }
          if (billDateCell) {
            billDateCell.classList.remove("abnormal-bill-date-cell");
          }
        }

        // 为未查到账单的客户标橙色整行
        if (status === "未查到账单") {
          row.classList.add("no-bill-found-row");
        } else {
          // 清除橙色整行样式
          row.classList.remove("no-bill-found-row");
        }

        // 更新标题统计信息
        setTimeout(() => {
          updateResultsTitle();
        }, 100);
      }

      function updateCustomerBillInfo(customerName, billData) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index === -1) return;

        const row = document.getElementById(`customer-row-${index}`);
        if (!row) return;

        // 更新账单信息
        row.querySelector(".bill-no").textContent = billData.billNo || "-";
        row.querySelector(".bill-date").textContent = formatDateTime(
          billData.billDate
        );
        row.querySelector(".bill-start-date").textContent = formatDateTime(
          billData.billStartDate
        );
        row.querySelector(".bill-end-date").textContent = formatDateTime(
          billData.billEndDate
        );
        row.querySelector(".latest-repay-date").textContent = formatDateTime(
          billData.latestRepayDate
        );
        row.querySelector(".bill-amount").textContent = billData.billAmount
          ? `¥${billData.billAmount}`
          : "-";
        row.querySelector(".paid-amount").textContent = billData.paidAmount
          ? `¥${billData.paidAmount}`
          : "-";
        row.querySelector(".unpaid-amount").textContent = billData.debtAmount
          ? `¥${billData.debtAmount}`
          : "-";
        row.querySelector(".repay-date").textContent = formatDateTime(
          billData.repayDate
        );

        // 更新文件名
        const fileName = generateFileName(
          customerName,
          billData.billStartDate,
          billData.billEndDate
        );
        row.querySelector(".file-name").textContent = fileName;
        row.querySelector(".status").textContent = "已查到";
        row.querySelector(".status").style.color = "#28a745";

        // 检查出账日是否异常，如果是则标红客户名称和出账日格子
        const customerNameCell = row.querySelector(".customer-name");
        const billDateCell = row.querySelector(".bill-date");
        if (isAbnormalBillDate(billData.billDate)) {
          customerNameCell.classList.add("abnormal-bill-date");
          billDateCell.classList.add("abnormal-bill-date-cell");
          addLog(
            `⚠ 客户 ${customerName} 的出账日不是1号: ${formatDateTime(
              billData.billDate
            )}`,
            "warning"
          );
        } else {
          customerNameCell.classList.remove("abnormal-bill-date");
          billDateCell.classList.remove("abnormal-bill-date-cell");
        }

        // 添加操作按钮
        const debtAmount = parseFloat(billData.debtAmount) || 0;
        const downloadBtnClass =
          debtAmount > 0 ? "table-btn download" : "table-btn download disabled";
        const downloadBtnClick =
          debtAmount > 0
            ? `onclick="downloadBill('${
                billData.billId
              }', '${customerName}', '${billData.billNo || ""}', '${
                billData.debtAmount || 0
              }', '${billData.billStartDate || ""}', '${
                billData.billEndDate || ""
              }')"`
            : `onclick="alert('该客户待还金额为¥${debtAmount}，无需下载账单')" style="cursor: not-allowed;"`;

        row.querySelector(".action").innerHTML = `
                <button ${downloadBtnClick} class="${downloadBtnClass}">下载</button>
                <button onclick="querySingleCustomer('${customerName}')" class="table-btn query">查询</button>
                <button onclick="showBillDetail('${
                  billData.billId
                }', '${customerName}', '${
                  billData.billNo || ""
                }')" class="table-btn detail">明细</button>
              `;
      }

      function addActionButtonsForCustomer(customerName) {
        const customerNames = Object.keys(customerConfig);
        const index = customerNames.indexOf(customerName);
        if (index === -1) return;

        const row = document.getElementById(`customer-row-${index}`);
        if (!row) return;

        // 添加操作按钮（没有下载按钮，因为没有账单）
        row.querySelector(".action").innerHTML = `
                <button onclick="querySingleCustomer('${customerName}')" class="table-btn query">查询</button>
              `;
      }

      function handleExcelFile(event) {
        // 防止任何默认行为
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        const fileInput = document.getElementById("excelFile");
        const file = fileInput.files[0];

        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });

            // 读取第一个工作表
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            // 转换为JSON数据
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // 处理客户数据
            processExcelData(jsonData);
          } catch (error) {
            addLog(`Excel文件读取失败: ${error.message}`, "error");
          }
        };

        reader.readAsArrayBuffer(file);

        // 清空文件输入框，避免重复处理
        fileInput.value = "";
      }

      // 显示样式设置对话框
      function showStyleSettings() {
        const dialog = document.getElementById("styleSettingsDialog");
        dialog.style.display = "flex";

        // 加载当前设置到表单
        loadStyleSettingsToForm();

        // 更新预览
        updateStylePreview();
      }

      // 隐藏样式设置对话框
      function hideStyleSettings() {
        const dialog = document.getElementById("styleSettingsDialog");
        dialog.style.display = "none";
      }

      // ==================== 账单明细功能 ====================

      // 显示账单明细
      async function showBillDetail(billId, customerName, billNo) {
        const dialog = document.getElementById("billDetailDialog");
        const loading = document.getElementById("billDetailLoading");
        const content = document.getElementById("billDetailContent");
        const error = document.getElementById("billDetailError");

        // 显示对话框
        dialog.style.display = "flex";

        // 重置状态
        loading.style.display = "block";
        content.style.display = "none";
        error.style.display = "none";
        content.innerHTML = "";
        error.innerHTML = "";

        // 更新标题
        const title = dialog.querySelector("h3");
        title.textContent = `账单明细 - ${customerName} (${billNo || billId})`;

        try {
          addLog(
            `正在获取账单明细: ${customerName} - ${billNo || billId}`,
            "info"
          );

          const token = document.getElementById("token").value.trim();
          if (!token) {
            throw new Error("请先输入访问令牌");
          }

          // 调用API获取账单明细
          const response = await fetch(
            `https://staff-api-gateway.teyixing.com/admin/v1/finance/getCreditBillDetail?billId=${billId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`
              }
            }
          );

          if (!response.ok) {
            if (response.status === 401) {
              throw new Error("访问令牌无效或已过期，请重新登录");
            }
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();

          if (result.code !== 0) {
            throw new Error(result.message || "获取账单明细失败");
          }

          // 隐藏加载状态，显示内容
          loading.style.display = "none";
          content.style.display = "block";

          // 渲染账单明细
          renderBillDetail(result.data, customerName, billNo || billId);

          addLog(`✅ 账单明细获取成功: ${customerName}`, "success");
        } catch (error) {
          // 隐藏加载状态，显示错误
          loading.style.display = "none";
          error.style.display = "block";
          error.innerHTML = `
            <h4>获取账单明细失败</h4>
            <p>${error.message}</p>
            <button onclick="showBillDetail('${billId}', '${customerName}', '${billNo}')"
                    style="background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
              重试
            </button>
          `;

          addLog(
            `❌ 获取账单明细失败: ${customerName} - ${error.message}`,
            "error"
          );
          console.error("获取账单明细失败:", error);
        }
      }

      // 隐藏账单明细对话框
      function hideBillDetail() {
        const dialog = document.getElementById("billDetailDialog");
        dialog.style.display = "none";
      }

      // 渲染账单明细数据
      function renderBillDetail(data, customerName, billIdentifier) {
        const content = document.getElementById("billDetailContent");

        if (!data) {
          content.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
              <h4>暂无账单明细数据</h4>
            </div>
          `;
          return;
        }

        // 计算是否逾期
        const isOverdue = checkIfOverdue(data.repaymentDate, data.repaidTime);
        const overdueText = isOverdue ? "是" : "否";
        const overdueColor = isOverdue ? "#dc3545" : "#28a745";

        // 格式化账单区间
        const billPeriod = formatBillPeriod(
          data.billStartDate,
          data.billEndDate
        );

        // 格式化还款日期
        const repaymentDateFormatted = formatDate(data.repaymentDate);

        // 基本信息
        const basicInfo = `
          <div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 8px;">账单基本信息</h4>

            <!-- 公司名称占一行 -->
            <div style="margin-bottom: 8px;">
              <strong>公司名称:</strong> ${data.corpName || "-"}
            </div>

            <!-- 账单区间占一行 -->
            <div style="margin-bottom: 8px;">
              <strong>账单区间:</strong> ${billPeriod}
            </div>

            <!-- 最迟还款日和是否逾期占一行 -->
            <div style="margin-bottom: 8px;">
              <strong>最迟还款日:</strong> ${repaymentDateFormatted}
              <span style="margin-left: 30px;"><strong>是否逾期:</strong> ${overdueText}</span>
            </div>

            <!-- 账单金额和欠款金额占一行 -->
            <div style="margin-bottom: 15px;">
              <strong>账单金额:</strong> ¥${data.billAmount || "0"}
              <span style="margin-left: 30px;"><strong>欠款金额:</strong> ¥${
                data.debtAmount || "0"
              }</span>
            </div>


          </div>
        `;

        // 信贷账单明细信息
        let creditBillInfo = "";
        if (data.creditBillFeeInfo) {
          const feeInfo = data.creditBillFeeInfo;

          // 计算费用明细字符串，包含调整金额
          const feeBreakdown = `国内机票 ${feeInfo.flightTotal || 0} + 火车票 ${
            feeInfo.trainTotal || 0
          } + 国内酒店 ${feeInfo.hotelTotal || 0} + 国际机票 ${
            feeInfo.intFlightTotal || 0
          } + 国际酒店 ${feeInfo.intHotelTotal || 0} + 其他产品 ${
            feeInfo.commonOrderTotal || 0
          } + 调整金额 ${feeInfo.adjustTotal || 0}`;

          creditBillInfo = `
            <div style="background-color: #e8f5e8; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 8px;"> 费用明细</h4>

              <!-- 账单金额总览 -->
              <div style="margin-bottom: 10px;">
                <strong>账单金额(元):</strong> ¥${
                  data.billAmount || "0"
                }${createCopyIcon(data.billAmount || "0", "账单金额")}
              </div>

              <!-- 费用分解（包含调整金额） -->
              <div style="margin-bottom: 10px; white-space: nowrap; overflow-x: auto;">
                ${feeBreakdown}
              </div>
            </div>
          `;
        }

        // 组合所有内容
        content.innerHTML = basicInfo + creditBillInfo;
      }

      // ==================== 账单明细辅助函数 ====================

      // 检查是否逾期
      function checkIfOverdue(repaymentDate, repaidTime) {
        if (!repaymentDate) return false;

        // 如果已经还款，则不算逾期
        if (repaidTime) return false;

        const repaymentDateTime = new Date(repaymentDate);
        const currentTime = new Date();

        // 如果当前时间超过还款日期，则为逾期
        return currentTime > repaymentDateTime;
      }

      // 格式化账单区间
      function formatBillPeriod(startDate, endDate) {
        if (!startDate || !endDate) return "-";

        const start = formatDate(startDate);
        const end = formatDate(endDate);

        return `${start} 至 ${end}`;
      }

      // 格式化日期（只显示日期部分）
      function formatDate(dateString) {
        if (!dateString) return "-";

        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return "-";

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");

          return `${year}-${month}-${day}`;
        } catch (error) {
          return "-";
        }
      }

      // 格式化日期时间（显示完整的日期和时间）
      function formatDateTime(dateTimeString) {
        if (!dateTimeString) return "-";

        try {
          const date = new Date(dateTimeString);
          if (isNaN(date.getTime())) return "-";

          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          const seconds = String(date.getSeconds()).padStart(2, "0");

          return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        } catch (error) {
          return "-";
        }
      }

      // 加载设置到表单
      function loadStyleSettingsToForm() {
        document.getElementById("startFromSheet").value =
          excelStyleSettings.startFromSheet;
        document.getElementById("processAllSheets").checked =
          excelStyleSettings.processAllSheets;
        document.getElementById("fontFamily").value =
          excelStyleSettings.fontFamily;
        document.getElementById("fontSize").value = excelStyleSettings.fontSize;
        document.getElementById("fontColor").value =
          excelStyleSettings.fontColor;
        document.getElementById("rowHeight").value =
          excelStyleSettings.rowHeight;
        document.getElementById("columnWidth").value =
          excelStyleSettings.columnWidth || "";
        document.getElementById("horizontalAlign").value =
          excelStyleSettings.horizontalAlign;
        document.getElementById("verticalAlign").value =
          excelStyleSettings.verticalAlign;
        document.getElementById("addBorders").checked =
          excelStyleSettings.addBorders;
        document.getElementById("borderStyle").value =
          excelStyleSettings.borderStyle;
        document.getElementById("borderColor").value =
          excelStyleSettings.borderColor;
      }

      // 保存样式设置
      function saveStyleSettings() {
        // 从表单获取设置
        excelStyleSettings.startFromSheet = parseInt(
          document.getElementById("startFromSheet").value
        );
        excelStyleSettings.processAllSheets =
          document.getElementById("processAllSheets").checked;
        excelStyleSettings.fontFamily =
          document.getElementById("fontFamily").value;
        excelStyleSettings.fontSize = parseInt(
          document.getElementById("fontSize").value
        );
        excelStyleSettings.fontColor =
          document.getElementById("fontColor").value;
        excelStyleSettings.rowHeight = parseInt(
          document.getElementById("rowHeight").value
        );
        excelStyleSettings.columnWidth = document.getElementById("columnWidth")
          .value
          ? parseFloat(document.getElementById("columnWidth").value)
          : null;
        excelStyleSettings.horizontalAlign =
          document.getElementById("horizontalAlign").value;
        excelStyleSettings.verticalAlign =
          document.getElementById("verticalAlign").value;
        excelStyleSettings.addBorders =
          document.getElementById("addBorders").checked;
        excelStyleSettings.borderStyle =
          document.getElementById("borderStyle").value;
        excelStyleSettings.borderColor =
          document.getElementById("borderColor").value;

        // 保存到localStorage
        localStorage.setItem(
          "excelStyleSettings",
          JSON.stringify(excelStyleSettings)
        );

        addLog("Excel样式设置已保存", "success");
        showToast("样式设置已保存！", "success");

        hideStyleSettings();
      }

      // 重置样式设置
      function resetStyleSettings() {
        excelStyleSettings = {
          startFromSheet: 2,
          processAllSheets: true,
          fontFamily: "宋体",
          fontSize: 10,
          fontColor: "#000000",
          rowHeight: 22,
          columnWidth: null,
          horizontalAlign: "left",
          verticalAlign: "middle",
          addBorders: true,
          borderStyle: "thin",
          borderColor: "#000000"
        };

        loadStyleSettingsToForm();
        updateStylePreview();

        addLog("Excel样式设置已重置为默认值", "info");
        showToast("已重置为默认设置", "info");
      }

      // 更新样式预览
      function updateStylePreview() {
        const previewTable = document.getElementById("stylePreviewTable");
        const fontSize = document.getElementById("fontSize").value;
        const fontFamily = document.getElementById("fontFamily").value;
        const fontColor = document.getElementById("fontColor").value;
        const rowHeight = document.getElementById("rowHeight").value;
        const horizontalAlign =
          document.getElementById("horizontalAlign").value;
        const verticalAlign = document.getElementById("verticalAlign").value;
        const addBorders = document.getElementById("addBorders").checked;
        const borderStyle = document.getElementById("borderStyle").value;
        const borderColor = document.getElementById("borderColor").value;

        // 应用样式到预览表格
        const cells = previewTable.querySelectorAll("td");
        cells.forEach(cell => {
          cell.style.fontSize = fontSize + "px";
          cell.style.fontFamily = fontFamily;
          cell.style.color = fontColor;
          cell.style.height = rowHeight * 1.33 + "px"; // 磅转像素近似值
          cell.style.textAlign = horizontalAlign;
          cell.style.verticalAlign = verticalAlign;

          if (addBorders) {
            cell.style.border = `1px ${borderStyle} ${borderColor}`;
          } else {
            cell.style.border = "none";
          }
        });
      }

      // 页面加载时从localStorage恢复设置
      function loadStyleSettingsFromStorage() {
        const saved = localStorage.getItem("excelStyleSettings");
        if (saved) {
          try {
            const savedSettings = JSON.parse(saved);
            excelStyleSettings = { ...excelStyleSettings, ...savedSettings };
            addLog("已加载保存的Excel样式设置", "info");
          } catch (error) {
            addLog("加载Excel样式设置失败，使用默认设置", "warning");
          }
        }
      }

      // Excel文件处理主入口函数
      async function handleStyleExcelFile() {
        const fileInput = document.getElementById("styleExcelFile");
        const file = fileInput.files[0];

        if (!file) {
          addLog("❌ 请选择Excel文件", "error");
          return;
        }

        try {
          addLog(`📁 开始处理Excel文件: ${file.name}`, "info");
          addLog(
            `📋 当前样式设置: 字体${excelStyleSettings.fontFamily} ${excelStyleSettings.fontSize}号, 行高${excelStyleSettings.rowHeight}磅`,
            "info"
          );
          showToast("正在处理Excel文件，请稍候...", "info");

          // 读取Excel文件
          const arrayBuffer = await file.arrayBuffer();
          const workbook = new ExcelJS.Workbook();
          await workbook.xlsx.load(arrayBuffer);

          addLog(
            `✅ 成功读取Excel文件，包含 ${workbook.worksheets.length} 个工作表`,
            "success"
          );

          // 检查第一个工作表是否为"账单概览"
          const worksheets = workbook.worksheets;
          if (worksheets.length === 0) {
            addLog("❌ Excel文件中没有工作表", "error");
            showToast("Excel文件中没有工作表", "error");
            return;
          }

          const firstWorksheet = worksheets[0];
          const firstSheetName = firstWorksheet.name;

          addLog(
            `📋 发现 ${worksheets.length} 个工作表，第一个工作表名称: "${firstSheetName}"`,
            "info"
          );

          // 处理第一个工作表（如果是"账单概览"）
          let hasProcessedAccountSummary = false;
          if (firstSheetName === "账单概览") {
            addLog(
              `🔍 检测到"账单概览"工作表，开始处理"合计"行删除逻辑`,
              "info"
            );

            try {
              const deletedRows = await processAccountSummarySheet(
                firstWorksheet,
                workbook
              );
              hasProcessedAccountSummary = true;

              addLog(
                `✅ "账单概览"工作表处理完成，删除了${deletedRows}行`,
                "success"
              );
            } catch (error) {
              addLog(`❌ 处理"账单概览"工作表失败: ${error.message}`, "error");
              showToast(`处理失败: ${error.message}`, "error");
              return; // 如果账单概览处理失败，停止后续处理
            }
          } else {
            addLog(
              `⚠️ 第一个工作表名称为"${firstSheetName}"，不是"账单概览"，跳过特殊处理`,
              "warning"
            );
          }

          // 为所有工作表（从第二个开始）添加求和功能
          try {
            addLog(`🧮 开始为工作表添加求和功能...`, "info");
            addSumFormulasToWorksheets(workbook);
          } catch (error) {
            addLog(`❌ 添加求和功能失败: ${error.message}`, "error");
            // 求和功能失败不影响文件生成，继续处理
          }

          // 生成处理后的Excel文件
          try {
            const fileNameParts = file.name.split(".");
            const extension = fileNameParts.pop();
            const baseName = fileNameParts.join(".");
            const newFileName = `${baseName}_已处理.${extension}`;

            // 生成Excel文件
            const buffer = await workbook.xlsx.writeBuffer();

            // 创建Blob并下载
            const blob = new Blob([buffer], {
              type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = newFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            let successMessage = "Excel处理完成！";
            if (hasProcessedAccountSummary) {
              successMessage += "已处理账单概览工作表，";
            }
            successMessage += "已添加求和功能，文件已下载";

            addLog(`✅ Excel处理完成，文件已下载: ${newFileName}`, "success");
            showToast(successMessage, "success");
          } catch (error) {
            addLog(`❌ 生成Excel文件失败: ${error.message}`, "error");
            showToast(`生成文件失败: ${error.message}`, "error");
          }
        } catch (error) {
          addLog(`❌ Excel文件处理失败: ${error.message}`, "error");
          showToast(`Excel文件处理失败: ${error.message}`, "error");
          console.error("Excel处理错误:", error);
        } finally {
          // 清空文件输入框
          fileInput.value = "";
        }
      }

      // ==================== 金额复制功能 ====================

      // 复制金额数值到剪贴板
      async function copyAmount(amount, label = "金额") {
        try {
          // 提取纯数字，去除¥符号和逗号
          const numericAmount = amount.toString().replace(/[¥,]/g, "").trim();

          // 使用现代剪贴板API
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(numericAmount);
          } else {
            // 降级方案：使用传统方法
            const textArea = document.createElement("textarea");
            textArea.value = numericAmount;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
          }

          // 显示成功提示
          showToast(`${label} ${numericAmount} 已复制到剪贴板`, "success");
          addLog(`复制${label}: ${numericAmount}`, "info");
        } catch (error) {
          console.error("复制失败:", error);
          showToast("复制失败，请手动选择复制", "error");
          addLog(`复制${label}失败: ${error.message}`, "error");
        }
      }

      // 创建复制图标按钮
      function createCopyIcon(amount, label = "金额") {
        return `<span
          onclick="copyAmount('${amount}', '${label}')"
          style="
            margin-left: 8px;
            cursor: pointer;
            color: #007bff;
            font-size: 12px;
            display: inline-block;
            padding: 2px 6px;
            border: 1px solid #007bff;
            border-radius: 3px;
            transition: all 0.2s ease;
            background-color: transparent;
            font-weight: bold;
          "
          onmouseover="this.style.backgroundColor='#007bff'; this.style.color='white';"
          onmouseout="this.style.backgroundColor='transparent'; this.style.color='#007bff';"
          title="点击复制${label}数值"
        >复制</span>`;
      }

      // ==================== ZIP批量处理功能 ====================

      // ZIP处理进度条控制函数
      function showZipProgress() {
        const container = document.getElementById("zipProgressContainer");
        if (container) {
          container.style.display = "block";
        }
      }

      function hideZipProgress() {
        const container = document.getElementById("zipProgressContainer");
        if (container) {
          container.style.display = "none";
        }
      }

      function updateZipProgress(
        current,
        total,
        currentFileName = "",
        status = ""
      ) {
        const progressBar = document.getElementById("zipProgressBar");
        const progressText = document.getElementById("zipProgressText");
        const progressPercent = document.getElementById("zipProgressPercent");
        const currentFile = document.getElementById("zipCurrentFile");

        if (progressBar && progressText && progressPercent && currentFile) {
          const percentage =
            total > 0 ? Math.round((current / total) * 100) : 0;

          progressBar.style.width = percentage + "%";
          progressPercent.textContent = percentage + "%";

          if (status) {
            progressText.textContent = status;
          } else if (current === total) {
            progressText.textContent = "处理完成";
          } else {
            progressText.textContent = `正在处理 ${current}/${total} 个文件`;
          }

          if (currentFileName) {
            currentFile.textContent = `当前文件: ${currentFileName}`;
          } else {
            currentFile.textContent = "";
          }
        }
      }

      function setZipProgressError(message) {
        const progressBar = document.getElementById("zipProgressBar");
        const progressText = document.getElementById("zipProgressText");

        if (progressBar && progressText) {
          progressBar.style.background =
            "linear-gradient(90deg, #dc3545 0%, #c82333 100%)";
          progressText.textContent = message;
          progressText.style.color = "#dc3545";
        }
      }

      function setZipProgressSuccess() {
        const progressBar = document.getElementById("zipProgressBar");
        const progressText = document.getElementById("zipProgressText");

        if (progressBar && progressText) {
          progressBar.style.background =
            "linear-gradient(90deg, #28a745 0%, #20c997 100%)";
          progressText.textContent = "处理完成";
          progressText.style.color = "#28a745";
        }
      }

      // ZIP文件处理主入口函数
      async function handleZipFile() {
        const fileInput = document.getElementById("zipFile");
        const file = fileInput.files[0];

        if (!file) {
          addLog("❌ 请选择ZIP文件", "error");
          return;
        }

        if (!file.name.toLowerCase().endsWith(".zip")) {
          addLog("❌ 请选择有效的ZIP文件", "error");
          return;
        }

        try {
          addLog(`📦 开始处理ZIP文件: ${file.name}`, "info");
          showToast("正在解压ZIP文件，请稍候...", "info");

          // 显示进度条并初始化
          showZipProgress();
          updateZipProgress(0, 1, "", "正在解压ZIP文件...");

          // 读取ZIP文件
          const arrayBuffer = await file.arrayBuffer();
          const zip = new JSZip();
          const zipContent = await zip.loadAsync(arrayBuffer);

          updateZipProgress(0, 1, "", "正在分析ZIP文件内容...");

          // 统计信息
          const stats = {
            totalFiles: 0,
            excelFiles: 0,
            processedFiles: 0,
            failedFiles: 0,
            skippedFiles: 0,
            errors: []
          };

          // 查找所有Excel文件
          const excelFiles = [];
          zipContent.forEach((relativePath, file) => {
            stats.totalFiles++;
            if (
              !file.dir &&
              (relativePath.toLowerCase().endsWith(".xlsx") ||
                relativePath.toLowerCase().endsWith(".xls"))
            ) {
              excelFiles.push({ path: relativePath, file: file });
              stats.excelFiles++;
            }
          });

          addLog(
            `📊 ZIP文件分析完成: 总文件${stats.totalFiles}个，Excel文件${stats.excelFiles}个`,
            "info"
          );

          if (stats.excelFiles === 0) {
            addLog("⚠️ ZIP文件中没有找到Excel文件", "warning");
            showToast("ZIP文件中没有找到Excel文件", "warning");
            setZipProgressError("ZIP文件中没有找到Excel文件");
            return;
          }

          // 创建新的ZIP文件用于输出
          const outputZip = new JSZip();

          // 初始化进度条为Excel文件处理
          updateZipProgress(0, stats.excelFiles, "", "准备处理Excel文件...");

          // 批量处理Excel文件
          for (let i = 0; i < excelFiles.length; i++) {
            const { path, file } = excelFiles[i];

            try {
              // 更新进度条
              updateZipProgress(i, excelFiles.length, path, "");

              addLog(
                `🔄 处理文件 ${i + 1}/${excelFiles.length}: ${path}`,
                "info"
              );

              // 读取Excel文件内容
              const excelBuffer = await file.async("arraybuffer");

              // 处理Excel文件
              const processedBuffer = await processExcelBuffer(
                excelBuffer,
                path
              );

              if (processedBuffer) {
                // 添加处理后的文件到输出ZIP
                outputZip.file(path, processedBuffer);
                stats.processedFiles++;
                addLog(`✅ 文件处理成功: ${path}`, "success");
              } else {
                stats.skippedFiles++;
                // 如果处理失败，保留原文件
                outputZip.file(path, excelBuffer);
                addLog(`⚠️ 文件处理失败，保留原文件: ${path}`, "warning");
              }
            } catch (error) {
              stats.failedFiles++;
              stats.errors.push({ file: path, error: error.message });
              addLog(`❌ 文件处理失败: ${path} - ${error.message}`, "error");

              // 处理失败时，尝试保留原文件
              try {
                const originalBuffer = await file.async("arraybuffer");
                outputZip.file(path, originalBuffer);
                addLog(`📄 已保留原文件: ${path}`, "info");
              } catch (preserveError) {
                addLog(
                  `❌ 无法保留原文件: ${path} - ${preserveError.message}`,
                  "error"
                );
              }
            }
          }

          // 复制非Excel文件到输出ZIP
          const nonExcelFiles = [];
          zipContent.forEach((relativePath, file) => {
            if (
              !file.dir &&
              !relativePath.toLowerCase().endsWith(".xlsx") &&
              !relativePath.toLowerCase().endsWith(".xls")
            ) {
              nonExcelFiles.push({ path: relativePath, file: file });
            }
          });

          // 更新进度条 - Excel文件处理完成
          updateZipProgress(
            excelFiles.length,
            excelFiles.length,
            "",
            "正在复制其他文件..."
          );

          if (nonExcelFiles.length > 0) {
            addLog(`📄 复制 ${nonExcelFiles.length} 个非Excel文件...`, "info");
            for (const { path, file } of nonExcelFiles) {
              try {
                const buffer = await file.async("arraybuffer");
                outputZip.file(path, buffer);
                addLog(`✅ 复制文件成功: ${path}`, "info");
              } catch (error) {
                addLog(
                  `⚠️ 复制非Excel文件失败: ${path} - ${error.message}`,
                  "warning"
                );
              }
            }
          }

          // 生成处理后的ZIP文件
          updateZipProgress(
            excelFiles.length,
            excelFiles.length,
            "",
            "正在生成ZIP文件..."
          );
          addLog("📦 正在生成处理后的ZIP文件...", "info");
          const outputBuffer = await outputZip.generateAsync({
            type: "arraybuffer"
          });

          // 创建下载链接
          const fileNameParts = file.name.split(".");
          fileNameParts.pop(); // 移除扩展名
          const baseName = fileNameParts.join(".");
          const newFileName = `${baseName}_已处理.zip`;

          const blob = new Blob([outputBuffer], { type: "application/zip" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = newFileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          // 显示处理结果统计
          const successMessage = `批量处理完成！成功处理${stats.processedFiles}个文件，失败${stats.failedFiles}个，跳过${stats.skippedFiles}个`;
          addLog(`✅ ${successMessage}`, "success");
          showToast(successMessage, "success");

          // 设置进度条为成功状态
          setZipProgressSuccess();
          updateZipProgress(
            excelFiles.length,
            excelFiles.length,
            "",
            "处理完成"
          );

          // 显示详细统计
          if (stats.errors.length > 0) {
            addLog("❌ 处理失败的文件详情:", "error");
            stats.errors.forEach(error => {
              addLog(`   - ${error.file}: ${error.error}`, "error");
            });
          }

          // 3秒后自动隐藏进度条
          setTimeout(() => {
            hideZipProgress();
          }, 3000);
        } catch (error) {
          addLog(`❌ ZIP文件处理失败: ${error.message}`, "error");
          showToast(`ZIP文件处理失败: ${error.message}`, "error");
          console.error("ZIP处理错误:", error);

          // 设置进度条为错误状态
          setZipProgressError(`处理失败: ${error.message}`);

          // 5秒后自动隐藏进度条
          setTimeout(() => {
            hideZipProgress();
          }, 5000);
        } finally {
          // 清空文件输入框
          fileInput.value = "";
        }
      }

      // 处理单个Excel文件的Buffer
      async function processExcelBuffer(arrayBuffer, fileName) {
        try {
          // 使用ExcelJS加载工作簿
          const workbook = new ExcelJS.Workbook();
          await workbook.xlsx.load(arrayBuffer);

          addLog(
            `   📋 成功读取Excel文件: ${fileName}，包含 ${workbook.worksheets.length} 个工作表`,
            "info"
          );

          // 应用现有的Excel处理逻辑
          await applyExcelProcessing(workbook, fileName);

          // 生成处理后的Excel文件Buffer
          const processedBuffer = await workbook.xlsx.writeBuffer();
          return processedBuffer;
        } catch (error) {
          addLog(
            `   ❌ Excel文件处理失败: ${fileName} - ${error.message}`,
            "error"
          );
          throw error;
        }
      }

      // 应用Excel处理逻辑（复用现有的处理逻辑）
      async function applyExcelProcessing(workbook, fileName) {
        try {
          const worksheets = workbook.worksheets;
          if (worksheets.length === 0) {
            addLog(`   ⚠️ Excel文件中没有工作表: ${fileName}`, "warning");
            return;
          }

          let hasProcessedAccountSummary = false;

          // 检查第一个工作表是否为"账单概览"
          const firstWorksheet = worksheets[0];
          if (firstWorksheet.name === "账单概览") {
            addLog(`   🔍 检测到账单概览工作表，开始特殊处理...`, "info");

            try {
              // 应用账单概览的特殊处理逻辑（使用与单文件处理相同的函数）
              const deletedRows = await processAccountSummarySheet(
                firstWorksheet,
                workbook
              );
              hasProcessedAccountSummary = true;
              addLog(
                `   ✅ 账单概览工作表处理完成，删除了${deletedRows}行`,
                "success"
              );
            } catch (error) {
              addLog(`   ❌ 账单概览工作表处理失败: ${error.message}`, "error");
              throw error;
            }
          }

          // 为所有工作表添加求和功能（跳过第一个工作表）
          addLog(`   🧮 开始为工作表添加求和功能...`, "info");

          let processedCount = 0;
          let successCount = 0;
          let failedCount = 0;

          // 遍历所有工作表，跳过第一个（索引0）
          worksheets.forEach((worksheet, index) => {
            if (index === 0) {
              addLog(`   ⏭️ 跳过第一个工作表: ${worksheet.name}`, "info");
              return;
            }

            addLog(`   🔄 处理工作表: ${worksheet.name}`, "info");
            processedCount++;

            try {
              const result = addSumFormulaToWorksheet(worksheet, index);
              if (result.success) {
                successCount++;
                addLog(
                  `   ✅ 工作表 ${worksheet.name} 求和功能添加完成: ${result.message}`,
                  "success"
                );
              } else {
                addLog(
                  `   ⚠️ 工作表 ${worksheet.name} 跳过求和: ${result.message}`,
                  "info"
                );
              }
            } catch (error) {
              failedCount++;
              addLog(
                `   ❌ 工作表 ${worksheet.name} 求和功能添加失败: ${error.message}`,
                "error"
              );
            }
          });

          addLog(
            `   📊 求和功能处理完成: 处理${processedCount}个工作表，成功${successCount}个，失败${failedCount}个`,
            "info"
          );

          // 应用工作表样式统一设置（跳过第一个工作表）
          addLog(`   🎨 开始应用样式设置...`, "info");
          applyWorksheetFormatting(workbook);
          addLog(`   ✅ 样式设置应用完成`, "success");
        } catch (error) {
          addLog(`   ❌ Excel处理逻辑应用失败: ${error.message}`, "error");
          throw error;
        }
      }

      // ==================== 合并单元格处理功能 ====================

      // 通过遍历单元格检测合并状态的替代方法
      function detectMergedCellsByIteration(worksheet) {
        const merges = [];
        const processedCells = new Set();

        // 遍历所有有数据的单元格
        worksheet.eachRow((row, rowNumber) => {
          row.eachCell((cell, colNumber) => {
            const cellAddress = `${rowNumber}-${colNumber}`;

            // 跳过已处理的单元格
            if (processedCells.has(cellAddress)) {
              return;
            }

            // 检查单元格是否有合并信息
            if (cell.master && cell.master !== cell) {
              // 这是一个合并单元格的从属单元格
              const masterCell = cell.master;
              const masterRow = masterCell.row;
              const masterCol = masterCell.col;

              // 查找合并范围
              let minRow = masterRow,
                maxRow = masterRow;
              let minCol = masterCol,
                maxCol = masterCol;

              // 向右扩展查找合并范围
              for (let c = masterCol; c <= worksheet.columnCount; c++) {
                const checkCell = worksheet.getCell(masterRow, c);
                if (
                  checkCell.master === masterCell ||
                  checkCell === masterCell
                ) {
                  maxCol = c;
                } else {
                  break;
                }
              }

              // 向下扩展查找合并范围
              for (let r = masterRow; r <= worksheet.rowCount; r++) {
                const checkCell = worksheet.getCell(r, masterCol);
                if (
                  checkCell.master === masterCell ||
                  checkCell === masterCell
                ) {
                  maxRow = r;
                } else {
                  break;
                }
              }

              // 检查是否已经记录过这个合并区域
              const existingMerge = merges.find(
                m =>
                  m.top === minRow &&
                  m.left === minCol &&
                  m.bottom === maxRow &&
                  m.right === maxCol
              );

              if (!existingMerge) {
                merges.push({
                  top: minRow,
                  left: minCol,
                  bottom: maxRow,
                  right: maxCol
                });

                // 标记这个合并区域的所有单元格为已处理
                for (let r = minRow; r <= maxRow; r++) {
                  for (let c = minCol; c <= maxCol; c++) {
                    processedCells.add(`${r}-${c}`);
                  }
                }
              }
            }
          });
        });

        return merges;
      }

      // 保存合并单元格信息的函数
      function saveMergedCellsInfo(worksheet) {
        addLog(`💾 开始保存合并单元格信息...`, "info");

        // 调试信息：打印工作表基本信息
        console.log("=== 调试信息：工作表基本信息 ===");
        console.log("工作表名称:", worksheet.name);
        console.log("工作表行数:", worksheet.actualRowCount);
        console.log("工作表列数:", worksheet.actualColumnCount);
        console.log("worksheet.model:", worksheet.model);
        console.log("worksheet.model.merges:", worksheet.model?.merges);

        const mergedCellsInfo = [];

        // 从worksheet.model.merges获取合并单元格信息
        if (
          worksheet.model &&
          worksheet.model.merges &&
          worksheet.model.merges.length > 0
        ) {
          console.log(`发现 ${worksheet.model.merges.length} 个合并单元格模型`);

          worksheet.model.merges.forEach((merge, index) => {
            console.log(`合并单元格 ${index + 1}:`, merge);

            if (merge.top && merge.left && merge.bottom && merge.right) {
              const mergeInfo = {
                top: merge.top,
                left: merge.left,
                bottom: merge.bottom,
                right: merge.right,
                range: `${worksheet.getCell(merge.top, merge.left).address}:${
                  worksheet.getCell(merge.bottom, merge.right).address
                }`
              };

              // 保存主单元格的样式和值
              const mainCell = worksheet.getCell(merge.top, merge.left);
              mergeInfo.value = mainCell.value;
              mergeInfo.font = mainCell.font ? { ...mainCell.font } : null;
              mergeInfo.alignment = mainCell.alignment
                ? { ...mainCell.alignment }
                : null;
              mergeInfo.border = mainCell.border
                ? { ...mainCell.border }
                : null;
              mergeInfo.fill = mainCell.fill ? { ...mainCell.fill } : null;
              mergeInfo.numFmt = mainCell.numFmt || null;

              mergedCellsInfo.push(mergeInfo);

              console.log(`保存合并单元格信息:`, mergeInfo);

              addLog(
                `📋 保存合并单元格 ${index + 1}: ${mergeInfo.range} (值: "${
                  mergeInfo.value || ""
                }")`,
                "info"
              );
            } else {
              console.log(`合并单元格 ${index + 1} 信息不完整:`, merge);
            }
          });
        } else {
          console.log("未发现合并单元格模型");
          console.log("worksheet.model存在:", !!worksheet.model);
          console.log("worksheet.model.merges存在:", !!worksheet.model?.merges);
          console.log(
            "worksheet.model.merges长度:",
            worksheet.model?.merges?.length || 0
          );

          // 尝试替代方法：通过遍历单元格检测合并状态
          console.log("尝试替代方法检测合并单元格...");
          const detectedMerges = detectMergedCellsByIteration(worksheet);
          console.log("通过遍历检测到的合并单元格:", detectedMerges);

          // 额外调试：检查单元格的详细信息
          console.log("=== 详细单元格调试信息 ===");
          let cellCount = 0;
          let masterCellCount = 0;
          worksheet.eachRow((row, rowNumber) => {
            row.eachCell((cell, colNumber) => {
              cellCount++;
              if (cell.master) {
                masterCellCount++;
                console.log(
                  `单元格 ${cell.address}: master=${
                    cell.master.address
                  }, isMaster=${cell.master === cell}`
                );
              }
              // 检查前几个单元格的详细信息
              if (rowNumber <= 3 && colNumber <= 5) {
                console.log(
                  `${cell.address}: value="${cell.value}", master=${
                    cell.master?.address || "none"
                  }`
                );
              }
            });
          });
          console.log(
            `总单元格数: ${cellCount}, 有master属性的单元格数: ${masterCellCount}`
          );

          // 检查是否有任何合并相关的属性
          console.log("worksheet对象的所有属性:", Object.keys(worksheet));
          console.log(
            "worksheet.model的所有属性:",
            Object.keys(worksheet.model || {})
          );

          // 尝试直接访问合并信息
          if (worksheet._merges) {
            console.log("worksheet._merges:", worksheet._merges);
          }
          if (worksheet.model._merges) {
            console.log("worksheet.model._merges:", worksheet.model._merges);
          }

          // 如果检测到合并单元格，添加到结果中
          detectedMerges.forEach((merge, index) => {
            const mergeInfo = {
              top: merge.top,
              left: merge.left,
              bottom: merge.bottom,
              right: merge.right,
              range: `${worksheet.getCell(merge.top, merge.left).address}:${
                worksheet.getCell(merge.bottom, merge.right).address
              }`
            };

            // 保存主单元格的样式和值
            const mainCell = worksheet.getCell(merge.top, merge.left);
            mergeInfo.value = mainCell.value;
            mergeInfo.font = mainCell.font ? { ...mainCell.font } : null;
            mergeInfo.alignment = mainCell.alignment
              ? { ...mainCell.alignment }
              : null;
            mergeInfo.border = mainCell.border ? { ...mainCell.border } : null;
            mergeInfo.fill = mainCell.fill ? { ...mainCell.fill } : null;
            mergeInfo.numFmt = mainCell.numFmt || null;

            mergedCellsInfo.push(mergeInfo);

            console.log(`通过遍历保存合并单元格信息:`, mergeInfo);

            addLog(
              `📋 检测到合并单元格 ${index + 1}: ${mergeInfo.range} (值: "${
                mergeInfo.value || ""
              }")`,
              "info"
            );
          });
        }

        // 强制添加A26-D26合并单元格（用户指定的测试需求）
        console.log("=== 强制添加A26-D26合并单元格 ===");
        const forcedMerge1 = {
          top: 26,
          left: 1,
          bottom: 26,
          right: 4,
          range: "A26:D26",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge1);
        console.log("强制添加的合并单元格1:", forcedMerge1);
        addLog("🔧 强制添加A26-D26合并单元格", "info");

        // 强制添加A27-A28合并单元格（用户指定的测试需求）
        console.log("=== 强制添加A27-A28合并单元格 ===");
        const forcedMerge2 = {
          top: 27,
          left: 1,
          bottom: 28,
          right: 1,
          range: "A27:A28",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge2);
        console.log("强制添加的合并单元格2:", forcedMerge2);
        addLog("🔧 强制添加A27-A28合并单元格", "info");

        // 强制添加B27-C27合并单元格（用户指定的测试需求）
        console.log("=== 强制添加B27-C27合并单元格 ===");
        const forcedMerge3 = {
          top: 27,
          left: 2,
          bottom: 27,
          right: 3,
          range: "B27:C27",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge3);
        console.log("强制添加的合并单元格3:", forcedMerge3);
        addLog("🔧 强制添加B27-C27合并单元格", "info");

        // 强制添加D27-E27合并单元格（用户指定的测试需求）
        console.log("=== 强制添加D27-E27合并单元格 ===");
        const forcedMerge4 = {
          top: 27,
          left: 4,
          bottom: 27,
          right: 5,
          range: "D27:E27",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge4);
        console.log("强制添加的合并单元格4:", forcedMerge4);
        addLog("🔧 强制添加D27-E27合并单元格", "info");

        // 强制添加F27-G27合并单元格（用户指定的测试需求）
        console.log("=== 强制添加F27-G27合并单元格 ===");
        const forcedMerge5 = {
          top: 27,
          left: 6,
          bottom: 27,
          right: 7,
          range: "F27:G27",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge5);
        console.log("强制添加的合并单元格5:", forcedMerge5);
        addLog("🔧 强制添加F27-G27合并单元格", "info");

        // 强制添加B28-C28合并单元格（用户指定的测试需求）
        console.log("=== 强制添加B28-C28合并单元格 ===");
        const forcedMerge6 = {
          top: 28,
          left: 2,
          bottom: 28,
          right: 3,
          range: "B28:C28",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge6);
        console.log("强制添加的合并单元格6:", forcedMerge6);
        addLog("🔧 强制添加B28-C28合并单元格", "info");

        // 强制添加D28-E28合并单元格（用户指定的测试需求）
        console.log("=== 强制添加D28-E28合并单元格 ===");
        const forcedMerge7 = {
          top: 28,
          left: 4,
          bottom: 28,
          right: 5,
          range: "D28:E28",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge7);
        console.log("强制添加的合并单元格7:", forcedMerge7);
        addLog("🔧 强制添加D28-E28合并单元格", "info");

        // 强制添加F28-G28合并单元格（用户指定的测试需求）
        console.log("=== 强制添加F28-G28合并单元格 ===");
        const forcedMerge8 = {
          top: 28,
          left: 6,
          bottom: 28,
          right: 7,
          range: "F28:G28",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge8);
        console.log("强制添加的合并单元格8:", forcedMerge8);
        addLog("🔧 强制添加F28-G28合并单元格", "info");

        // 强制添加A29-G29合并单元格（用户指定的测试需求）
        console.log("=== 强制添加A29-G29合并单元格 ===");
        const forcedMerge9 = {
          top: 29,
          left: 1,
          bottom: 29,
          right: 7,
          range: "A29:G29",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge9);
        console.log("强制添加的合并单元格9:", forcedMerge9);
        addLog("🔧 强制添加A29-G29合并单元格", "info");

        // 强制添加A30-C30合并单元格（用户指定的测试需求）
        console.log("=== 强制添加A30-C30合并单元格 ===");
        const forcedMerge10 = {
          top: 30,
          left: 1,
          bottom: 30,
          right: 3,
          range: "A30:C30",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge10);
        console.log("强制添加的合并单元格10:", forcedMerge10);
        addLog("🔧 强制添加A30-C30合并单元格", "info");

        // 强制添加D30-G30合并单元格（用户指定的测试需求）
        console.log("=== 强制添加D30-G30合并单元格 ===");
        const forcedMerge11 = {
          top: 30,
          left: 4,
          bottom: 30,
          right: 7,
          range: "D30:G30",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge11);
        console.log("强制添加的合并单元格11:", forcedMerge11);
        addLog("🔧 强制添加D30-G30合并单元格", "info");

        // 强制添加A31-G31合并单元格（用户指定的测试需求）
        console.log("=== 强制添加A31-G31合并单元格 ===");
        const forcedMerge12 = {
          top: 31,
          left: 1,
          bottom: 31,
          right: 7,
          range: "A31:G31",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge12);
        console.log("强制添加的合并单元格12:", forcedMerge12);
        addLog("🔧 强制添加A31-G31合并单元格", "info");

        // 强制添加A32-G32合并单元格（用户指定的测试需求）
        console.log("=== 强制添加A32-G32合并单元格 ===");
        const forcedMerge13 = {
          top: 32,
          left: 1,
          bottom: 32,
          right: 7,
          range: "A32:G32",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge13);
        console.log("强制添加的合并单元格13:", forcedMerge13);
        addLog("🔧 强制添加A32-G32合并单元格", "info");

        // 强制添加A33-C33合并单元格（用户指定的测试需求）
        console.log("=== 强制添加A33-C33合并单元格 ===");
        const forcedMerge14 = {
          top: 33,
          left: 1,
          bottom: 33,
          right: 3,
          range: "A33:C33",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge14);
        console.log("强制添加的合并单元格14:", forcedMerge14);
        addLog("🔧 强制添加A33-C33合并单元格", "info");

        // 强制添加D33-G33合并单元格（用户指定的测试需求）
        console.log("=== 强制添加D33-G33合并单元格 ===");
        const forcedMerge15 = {
          top: 33,
          left: 4,
          bottom: 33,
          right: 7,
          range: "D33:G33",
          forced: true // 标记为强制合并
        };
        mergedCellsInfo.push(forcedMerge15);
        console.log("强制添加的合并单元格15:", forcedMerge15);
        addLog("🔧 强制添加D33-G33合并单元格", "info");

        // 强制添加A1-G1合并单元格（固定位置，不受删除行影响）
        console.log("=== 强制添加A1-G1合并单元格（固定位置）===");
        const forcedMergeFixed1 = {
          top: 1,
          left: 1,
          bottom: 1,
          right: 7,
          range: "A1:G1",
          forced: true,
          fixedPosition: true // 标记为固定位置
        };
        mergedCellsInfo.push(forcedMergeFixed1);
        console.log("强制添加的固定位置合并单元格1:", forcedMergeFixed1);
        addLog("🔧 强制添加A1-G1合并单元格（固定位置）", "info");

        // 强制添加A2-C2合并单元格（固定位置，不受删除行影响）
        console.log("=== 强制添加A2-C2合并单元格（固定位置）===");
        const forcedMergeFixed2 = {
          top: 2,
          left: 1,
          bottom: 2,
          right: 3,
          range: "A2:C2",
          forced: true,
          fixedPosition: true // 标记为固定位置
        };
        mergedCellsInfo.push(forcedMergeFixed2);
        console.log("强制添加的固定位置合并单元格2:", forcedMergeFixed2);
        addLog("🔧 强制添加A2-C2合并单元格（固定位置）", "info");

        console.log("=== 调试信息结束 ===");

        // 统计固定位置和可变位置的合并单元格数量
        const fixedPositionCount = mergedCellsInfo.filter(
          info => info.fixedPosition
        ).length;
        const variablePositionCount =
          mergedCellsInfo.length - fixedPositionCount;

        addLog(
          `💾 共保存 ${mergedCellsInfo.length} 个合并单元格信息 (固定位置: ${fixedPositionCount}, 可变位置: ${variablePositionCount})`,
          "success"
        );
        return mergedCellsInfo;
      }

      // 计算合并单元格新位置的函数
      function calculateNewMergedCellPosition(mergeInfo, deletedRowRanges) {
        console.log(`\n计算合并单元格新位置:`);
        console.log(
          `原始位置: 第${mergeInfo.top}-${mergeInfo.bottom}行, 第${mergeInfo.left}-${mergeInfo.right}列`
        );
        console.log(`删除的行范围:`, deletedRowRanges);

        let newTop = mergeInfo.top;
        let newBottom = mergeInfo.bottom;

        // 计算总的删除行数（只计算在合并单元格之前的删除行数）
        let deletedRowsBeforeMerge = 0;

        for (const range of deletedRowRanges) {
          console.log(`检查删除范围: 第${range.startRow}-${range.endRow}行`);
          console.log(
            `删除范围结束行 ${range.endRow} < 合并单元格开始行 ${mergeInfo.top}?`,
            range.endRow < mergeInfo.top
          );

          // 只有删除区域完全在合并单元格之前，才需要调整位置
          if (range.endRow < mergeInfo.top) {
            const deletedInThisRange = range.endRow - range.startRow + 1;
            deletedRowsBeforeMerge += deletedInThisRange;
            console.log(
              `此范围删除了 ${deletedInThisRange} 行，累计删除 ${deletedRowsBeforeMerge} 行`
            );
          } else {
            console.log(`此删除范围不影响合并单元格位置`);
          }
        }

        // 调整位置
        if (deletedRowsBeforeMerge > 0) {
          newTop = mergeInfo.top - deletedRowsBeforeMerge;
          newBottom = mergeInfo.bottom - deletedRowsBeforeMerge;

          console.log(
            `位置需要调整: 原始第${mergeInfo.top}-${mergeInfo.bottom}行 → 新位置第${newTop}-${newBottom}行`
          );

          addLog(
            `📐 合并单元格位置调整: ${mergeInfo.range} → 第${newTop}-${newBottom}行,第${mergeInfo.left}-${mergeInfo.right}列 (删除${deletedRowsBeforeMerge}行)`,
            "info"
          );
        } else {
          console.log(`位置无需调整`);
          addLog(
            `📐 合并单元格位置不变: ${mergeInfo.range} (无需调整)`,
            "info"
          );
        }

        const result = {
          ...mergeInfo,
          newTop: newTop,
          newBottom: newBottom,
          positionChanged: deletedRowsBeforeMerge > 0
        };

        console.log(`位置计算结果:`, result);
        return result;
      }

      // 恢复合并单元格的函数
      function restoreMergedCells(
        worksheet,
        mergedCellsInfo,
        deletedRowRanges,
        workbook
      ) {
        addLog(`🔗 开始恢复合并单元格...`, "info");

        console.log("=== 调试信息：恢复合并单元格 ===");
        console.log("要恢复的合并单元格数量:", mergedCellsInfo.length);
        console.log("删除的行范围:", deletedRowRanges);
        console.log("当前工作表行数:", worksheet.actualRowCount);
        console.log("当前工作表列数:", worksheet.actualColumnCount);

        // 清除现有的合并单元格
        if (worksheet.model && worksheet.model.merges) {
          const originalMergeCount = worksheet.model.merges.length;
          // 先取消所有现有的合并单元格
          const existingMerges = [...worksheet.model.merges];
          existingMerges.forEach(merge => {
            try {
              worksheet.unMergeCells(merge);
              console.log(`取消合并: ${merge}`);
            } catch (error) {
              console.log(`取消合并失败: ${merge}, 错误: ${error.message}`);
            }
          });
          console.log(`清除了 ${originalMergeCount} 个现有合并单元格`);
          addLog(`🧹 清除了 ${originalMergeCount} 个现有合并单元格`, "info");
        }

        let restoredCount = 0;
        let skippedCount = 0;
        const processedRanges = new Set(); // 用于检测重复的合并范围

        mergedCellsInfo.forEach((mergeInfo, index) => {
          console.log(`\n处理合并单元格 ${index + 1}:`, mergeInfo);

          let newMergeInfo;

          // 检查是否为固定位置的合并单元格
          if (mergeInfo.fixedPosition) {
            console.log(`固定位置合并单元格，不进行位置计算`);
            newMergeInfo = {
              newTop: mergeInfo.top,
              newBottom: mergeInfo.bottom,
              left: mergeInfo.left,
              right: mergeInfo.right,
              positionChanged: false,
              value: mergeInfo.value,
              font: mergeInfo.font,
              alignment: mergeInfo.alignment,
              border: mergeInfo.border,
              fill: mergeInfo.fill,
              numFmt: mergeInfo.numFmt
            };
          } else {
            // 计算新位置（只对非固定位置的合并单元格）
            newMergeInfo = calculateNewMergedCellPosition(
              mergeInfo,
              deletedRowRanges
            );
          }

          console.log(`最终位置:`, newMergeInfo);

          // 验证新位置是否有效（放宽行数限制，因为删除行后actualRowCount可能不准确）
          const isValidPosition =
            newMergeInfo.newTop > 0 &&
            newMergeInfo.newBottom > 0 &&
            newMergeInfo.left > 0 &&
            newMergeInfo.right > 0 &&
            newMergeInfo.newTop <= newMergeInfo.newBottom &&
            newMergeInfo.left <= newMergeInfo.right &&
            newMergeInfo.left <= worksheet.actualColumnCount &&
            newMergeInfo.right <= worksheet.actualColumnCount;

          console.log(`位置有效性检查:`, {
            newTop: newMergeInfo.newTop,
            newBottom: newMergeInfo.newBottom,
            left: newMergeInfo.left,
            right: newMergeInfo.right,
            worksheetRows: worksheet.actualRowCount,
            worksheetCols: worksheet.actualColumnCount,
            isValid: isValidPosition,
            reason: !isValidPosition ? "位置验证失败" : "位置验证通过"
          });

          if (isValidPosition) {
            try {
              // 检查是否已经处理过相同的合并范围
              const rangeKey = `${newMergeInfo.newTop}-${newMergeInfo.left}-${newMergeInfo.newBottom}-${newMergeInfo.right}`;
              if (processedRanges.has(rangeKey)) {
                console.log(`跳过重复的合并范围: ${rangeKey}`);
                addLog(
                  `⚠️ 跳过重复的合并单元格 ${index + 1}: 范围已存在`,
                  "warning"
                );
                skippedCount++;
                return;
              }
              processedRanges.add(rangeKey);

              // 确保目标行存在（如果不存在则创建）
              for (
                let row = newMergeInfo.newTop;
                row <= newMergeInfo.newBottom;
                row++
              ) {
                for (
                  let col = newMergeInfo.left;
                  col <= newMergeInfo.right;
                  col++
                ) {
                  const cell = worksheet.getCell(row, col);
                  // 访问单元格会自动创建它
                  console.log(`确保单元格存在: ${cell.address}`);
                }
              }

              console.log(
                `尝试合并单元格: (${newMergeInfo.newTop}, ${newMergeInfo.left}, ${newMergeInfo.newBottom}, ${newMergeInfo.right})`
              );

              // 恢复合并单元格
              console.log(`开始执行合并操作...`);
              worksheet.mergeCells(
                newMergeInfo.newTop,
                newMergeInfo.left,
                newMergeInfo.newBottom,
                newMergeInfo.right
              );

              console.log(
                `合并单元格成功: ${newMergeInfo.newTop},${newMergeInfo.left} 到 ${newMergeInfo.newBottom},${newMergeInfo.right}`
              );

              // 恢复主单元格的值和样式
              const mainCell = worksheet.getCell(
                newMergeInfo.newTop,
                newMergeInfo.left
              );

              console.log(`恢复主单元格值和样式:`, {
                value: newMergeInfo.value,
                hasFont: !!newMergeInfo.font,
                hasAlignment: !!newMergeInfo.alignment,
                hasBorder: !!newMergeInfo.border,
                hasFill: !!newMergeInfo.fill
              });

              // 只恢复非空的值和样式，避免影响其他单元格
              if (
                newMergeInfo.value !== undefined &&
                newMergeInfo.value !== null
              ) {
                mainCell.value = newMergeInfo.value;
              }

              // 只有当样式不为null且不为undefined时才应用
              if (
                newMergeInfo.font &&
                Object.keys(newMergeInfo.font).length > 0
              ) {
                mainCell.font = newMergeInfo.font;
              }
              if (
                newMergeInfo.alignment &&
                Object.keys(newMergeInfo.alignment).length > 0
              ) {
                mainCell.alignment = newMergeInfo.alignment;
              }
              if (
                newMergeInfo.border &&
                Object.keys(newMergeInfo.border).length > 0
              ) {
                mainCell.border = newMergeInfo.border;
              }
              if (
                newMergeInfo.fill &&
                Object.keys(newMergeInfo.fill).length > 0
              ) {
                mainCell.fill = newMergeInfo.fill;
              }
              if (newMergeInfo.numFmt) {
                mainCell.numFmt = newMergeInfo.numFmt;
              }

              const newRange = `${mainCell.address}:${
                worksheet.getCell(newMergeInfo.newBottom, newMergeInfo.right)
                  .address
              }`;

              console.log(`合并单元格恢复成功: ${newRange}`);

              const positionStatus = mergeInfo.fixedPosition
                ? "(固定位置)"
                : newMergeInfo.positionChanged
                  ? "(位置已调整)"
                  : "(位置不变)";

              addLog(
                `✅ 恢复合并单元格 ${index + 1}: ${newRange} ${positionStatus}`,
                "success"
              );
              restoredCount++;
            } catch (error) {
              console.log(`合并单元格失败:`, error);
              addLog(
                `❌ 恢复合并单元格 ${index + 1} 失败: ${error.message}`,
                "error"
              );
              skippedCount++;
            }
          } else {
            console.log(`跳过无效位置的合并单元格`);
            addLog(
              `⚠️ 跳过无效位置的合并单元格 ${index + 1}: 新位置超出工作表范围`,
              "warning"
            );
            skippedCount++;
          }
        });

        console.log("=== 恢复合并单元格调试信息结束 ===");

        addLog(
          `🔗 合并单元格恢复完成: 成功 ${restoredCount} 个，跳过 ${skippedCount} 个`,
          "success"
        );

        // 调整特定合并单元格的边框（A30-C30的右边框）
        adjustSpecificMergedCellBorder(worksheet, deletedRowRanges);

        // 应用工作表样式统一设置（跳过第一个工作表）
        applyWorksheetFormatting(workbook);
      }

      // 调整特定合并单元格边框的函数（移除A30-C30的右边框）
      function adjustSpecificMergedCellBorder(worksheet, deletedRowRanges) {
        try {
          addLog(`🔧 开始调整A30-C30合并单元格的右边框...`, "info");
          console.log("=== 调整特定合并单元格边框 ===");

          // 定义原始A30-C30合并单元格的位置
          const originalMergeInfo = {
            top: 30,
            left: 1,
            bottom: 30,
            right: 3,
            range: "A30:C30"
          };

          console.log(`原始合并单元格位置: ${originalMergeInfo.range}`);

          // 计算删除行后的新位置
          const newMergeInfo = calculateNewMergedCellPosition(
            originalMergeInfo,
            deletedRowRanges
          );

          console.log(
            `计算后的新位置: 行${newMergeInfo.newTop}-${newMergeInfo.newBottom}, 列${originalMergeInfo.left}-${originalMergeInfo.right}`
          );

          // 验证新位置是否有效
          if (newMergeInfo.newTop <= 0 || newMergeInfo.newBottom <= 0) {
            console.log("计算后的位置无效，跳过边框调整");
            addLog(`⚠️ A30-C30合并单元格位置无效，跳过边框调整`, "warning");
            return;
          }

          // 获取合并单元格范围内最右侧列（C列）的所有单元格
          const rightColumnIndex = originalMergeInfo.right; // C列 = 3

          console.log(
            `移除第${rightColumnIndex}列（C列）在行${newMergeInfo.newTop}-${newMergeInfo.newBottom}范围内的右边框`
          );

          // 移除该范围内所有单元格的右边框
          for (
            let row = newMergeInfo.newTop;
            row <= newMergeInfo.newBottom;
            row++
          ) {
            const cell = worksheet.getCell(row, rightColumnIndex);

            // 保留现有边框，只移除右边框
            if (cell.border) {
              const existingBorder = { ...cell.border };
              delete existingBorder.right; // 移除右边框
              cell.border = existingBorder;
              console.log(`移除单元格 ${cell.address} 的右边框`);
            } else {
              console.log(`单元格 ${cell.address} 没有边框，跳过`);
            }
          }

          const newRange = `${
            worksheet.getCell(newMergeInfo.newTop, originalMergeInfo.left)
              .address
          }:${
            worksheet.getCell(newMergeInfo.newBottom, originalMergeInfo.right)
              .address
          }`;

          console.log(`A30-C30合并单元格右边框调整完成: ${newRange}`);
          addLog(`🔧 A30-C30合并单元格右边框调整完成: ${newRange}`, "success");

          // 继续处理H29左边框添加
          addH29LeftBorder(worksheet, deletedRowRanges);
        } catch (error) {
          console.log(`调整特定合并单元格边框失败:`, error);
          addLog(`❌ 调整A30-C30合并单元格边框失败: ${error.message}`, "error");
        }
      }

      // 为H29单元格添加左边框的函数
      function addH29LeftBorder(worksheet, deletedRowRanges) {
        try {
          addLog(`🎨 开始为H29单元格添加左边框...`, "info");
          console.log("=== 为H29单元格添加左边框 ===");

          // 定义原始H29单元格的位置（第29行，第8列）
          const originalCellInfo = {
            top: 29,
            left: 8,
            bottom: 29,
            right: 8,
            range: "H29"
          };

          console.log(`原始单元格位置: ${originalCellInfo.range}`);

          // 计算删除行后的新位置
          const newCellInfo = calculateNewMergedCellPosition(
            originalCellInfo,
            deletedRowRanges
          );

          console.log(
            `计算后的新位置: 行${newCellInfo.newTop}, 列${originalCellInfo.left}`
          );

          // 验证新位置是否有效
          if (newCellInfo.newTop <= 0) {
            console.log("计算后的位置无效，跳过边框添加");
            addLog(`⚠️ H29单元格位置无效，跳过边框添加`, "warning");
            return;
          }

          // 定义左边框样式
          const leftBorderStyle = {
            style: "thin",
            color: { argb: "FF000000" } // 黑色
          };

          // 获取H列在新行位置的单元格
          const cell = worksheet.getCell(
            newCellInfo.newTop,
            originalCellInfo.left
          );

          console.log(`为单元格 ${cell.address} 添加左边框`);

          // 保留现有边框，添加左边框
          if (!cell.border) cell.border = {};
          const existingBorder = { ...cell.border };
          cell.border = {
            ...existingBorder,
            left: leftBorderStyle
          };

          console.log(`H29单元格左边框添加完成: ${cell.address}`);
          addLog(`🎨 H29单元格左边框添加完成: ${cell.address}`, "success");

          // 继续处理H30-H33单元格的左边框添加
          addH30ToH33LeftBorder(worksheet, deletedRowRanges);
        } catch (error) {
          console.log(`为H29单元格添加左边框失败:`, error);
          addLog(`❌ 为H29单元格添加左边框失败: ${error.message}`, "error");
        }
      }

      // 为H30-H33单元格添加左边框的函数
      function addH30ToH33LeftBorder(worksheet, deletedRowRanges) {
        try {
          addLog(`🎨 开始为H30-H33单元格添加左边框...`, "info");
          console.log("=== 为H30-H33单元格添加左边框 ===");

          // 定义H30-H33单元格的原始位置
          const targetCells = [
            { row: 30, name: "H30" },
            { row: 31, name: "H31" },
            { row: 32, name: "H32" },
            { row: 33, name: "H33" }
          ];

          // 定义左边框样式
          const leftBorderStyle = {
            style: "thin",
            color: { argb: "FF000000" } // 黑色
          };

          let successCount = 0;
          let failedCount = 0;

          // 遍历处理每个目标单元格
          targetCells.forEach((targetCell, index) => {
            try {
              console.log(`\n处理单元格 ${index + 1}: ${targetCell.name}`);

              // 定义单元格信息
              const cellInfo = {
                top: targetCell.row,
                left: 8, // H列 = 8
                bottom: targetCell.row,
                right: 8,
                range: targetCell.name
              };

              console.log(`原始单元格位置: ${cellInfo.range}`);

              // 计算删除行后的新位置
              const newCellInfo = calculateNewMergedCellPosition(
                cellInfo,
                deletedRowRanges
              );

              console.log(
                `计算后的新位置: 行${newCellInfo.newTop}, 列${cellInfo.left}`
              );

              // 验证新位置是否有效
              if (newCellInfo.newTop <= 0) {
                console.log(`${targetCell.name} 位置无效，跳过边框添加`);
                addLog(
                  `⚠️ ${targetCell.name}单元格位置无效，跳过边框添加`,
                  "warning"
                );
                failedCount++;
                return;
              }

              // 获取H列在新行位置的单元格
              const cell = worksheet.getCell(newCellInfo.newTop, cellInfo.left);

              console.log(`为单元格 ${cell.address} 添加左边框`);

              // 保留现有边框，添加左边框
              if (!cell.border) cell.border = {};
              const existingBorder = { ...cell.border };
              cell.border = {
                ...existingBorder,
                left: leftBorderStyle
              };

              console.log(
                `${targetCell.name}单元格左边框添加完成: ${cell.address}`
              );
              successCount++;
            } catch (error) {
              console.log(`为${targetCell.name}单元格添加左边框失败:`, error);
              failedCount++;
            }
          });

          // 输出处理结果
          console.log(
            `H30-H33单元格左边框处理完成: 成功 ${successCount} 个，失败 ${failedCount} 个`
          );
          addLog(
            `🎨 H30-H33单元格左边框处理完成: 成功 ${successCount} 个，失败 ${failedCount} 个`,
            successCount > 0 ? "success" : "warning"
          );
        } catch (error) {
          console.log(`为H30-H33单元格添加左边框失败:`, error);
          addLog(`❌ 为H30-H33单元格添加左边框失败: ${error.message}`, "error");
        }
      }

      // 为工作表添加求和功能（从第二个工作表开始）
      function addSumFormulasToWorksheets(workbook) {
        try {
          addLog(`🧮 开始为工作表添加求和功能...`, "info");
          console.log("=== 添加工作表求和功能 ===");

          const worksheets = workbook.worksheets;
          const totalWorksheets = worksheets.length;
          let processedCount = 0;
          let successCount = 0;
          let failedCount = 0;

          console.log(`工作簿总共有 ${totalWorksheets} 个工作表`);

          // 遍历所有工作表，跳过第一个（索引0）
          worksheets.forEach((worksheet, index) => {
            if (index === 0) {
              console.log(
                `跳过第一个工作表: ${worksheet.name} (索引: ${index})`
              );
              addLog(`⏭️ 跳过第一个工作表: ${worksheet.name}`, "info");
              return;
            }

            console.log(
              `处理工作表 ${index + 1}: ${worksheet.name} (索引: ${index})`
            );
            addLog(`🔄 处理工作表: ${worksheet.name}`, "info");
            processedCount++;

            try {
              const result = addSumFormulaToWorksheet(worksheet, index);
              if (result.success) {
                successCount++;
                addLog(
                  `✅ 工作表 ${worksheet.name} 求和功能添加完成: ${result.message}`,
                  "success"
                );
              } else {
                addLog(
                  `⚠️ 工作表 ${worksheet.name} 跳过求和: ${result.message}`,
                  "info"
                );
              }
            } catch (error) {
              failedCount++;
              console.error(
                `工作表 ${worksheet.name} 求和功能添加失败:`,
                error
              );
              addLog(
                `❌ 工作表 ${worksheet.name} 求和功能添加失败: ${error.message}`,
                "error"
              );
            }
          });

          const summary = `工作表求和功能添加完成:
      - 总工作表数: ${totalWorksheets}
      - 跳过工作表数: 1 (第一个工作表)
      - 处理工作表数: ${processedCount}
      - 成功添加数: ${successCount}
      - 失败添加数: ${failedCount}`;

          console.log(summary);
          addLog(
            `🧮 工作表求和功能添加完成: 处理 ${processedCount} 个工作表，成功 ${successCount} 个，失败 ${failedCount} 个`,
            successCount > 0 ? "success" : "info"
          );
        } catch (error) {
          console.error("添加工作表求和功能失败:", error);
          addLog(`❌ 添加工作表求和功能失败: ${error.message}`, "error");
        }
      }

      // 为单个工作表添加求和功能
      function addSumFormulaToWorksheet(worksheet, sheetIndex) {
        try {
          const actualRowCount = worksheet.actualRowCount || 0;
          const actualColumnCount = worksheet.actualColumnCount || 0;

          console.log(
            `工作表 ${worksheet.name} 数据范围: ${actualRowCount} 行 × ${actualColumnCount} 列`
          );

          // 检查工作表是否有数据
          if (actualRowCount < 2 || actualColumnCount < 1) {
            return {
              success: false,
              message: `数据不足 (${actualRowCount} 行 × ${actualColumnCount} 列)`
            };
          }

          // 查找第一行中的金额列
          const amountColumn = findAmountColumnInFirstRow(worksheet);
          if (!amountColumn) {
            return {
              success: false,
              message: "未找到金额列"
            };
          }

          console.log(
            `找到金额列: ${amountColumn.columnLetter} (第${amountColumn.columnNumber}列), 第一行值: ${amountColumn.firstRowValue}`
          );

          // 计算求和范围：从第2行到最后一行
          const sumStartRow = 2;
          const sumEndRow = actualRowCount;
          const sumTargetRow = actualRowCount + 1;

          // 生成求和公式
          const sumFormula = `=SUM(${amountColumn.columnLetter}${sumStartRow}:${amountColumn.columnLetter}${sumEndRow})`;

          console.log(
            `求和公式: ${sumFormula}, 目标位置: ${amountColumn.columnLetter}${sumTargetRow}`
          );

          // 在目标位置添加求和公式
          const sumCell = worksheet.getCell(
            sumTargetRow,
            amountColumn.columnNumber
          );
          sumCell.value = { formula: sumFormula.substring(1) }; // 去掉开头的=号，ExcelJS会自动添加

          // 在A列添加"合计"标签
          const labelCell = worksheet.getCell(sumTargetRow, 1); // A列是第1列
          labelCell.value = "合计";

          // 设置新增求和行的完整样式
          console.log(
            `开始为求和行设置样式: 第${sumTargetRow}行，从A列到第${actualColumnCount}列`
          );

          // 设置行高为22磅
          const sumRow = worksheet.getRow(sumTargetRow);
          sumRow.height = 22;

          // 定义统一的边框样式
          const borderStyle = {
            top: { style: "thin", color: { argb: "FF000000" } },
            left: { style: "thin", color: { argb: "FF000000" } },
            bottom: { style: "thin", color: { argb: "FF000000" } },
            right: { style: "thin", color: { argb: "FF000000" } }
          };

          // 定义统一的字体样式
          const fontStyle = {
            size: 10,
            name: "宋体"
          };

          // 为整行设置样式（从A列到最后一个有数据的列）
          for (let col = 1; col <= actualColumnCount; col++) {
            const cell = worksheet.getCell(sumTargetRow, col);

            // 设置边框
            cell.border = borderStyle;

            // 设置字体
            cell.font = fontStyle;

            // 如果是金额列，保留数字格式
            if (col === amountColumn.columnNumber && sumEndRow >= 2) {
              const referenceCell = worksheet.getCell(
                sumEndRow,
                amountColumn.columnNumber
              );
              if (referenceCell.numFmt) {
                cell.numFmt = referenceCell.numFmt;
              }
            }

            // 设置对齐方式 - 所有单元格都水平居中
            cell.alignment = { horizontal: "center", vertical: "middle" };
          }

          console.log(
            `求和行样式设置完成: 第${sumTargetRow}行，设置了${actualColumnCount}个单元格的边框、字体和对齐方式`
          );

          console.log(
            `求和功能添加完成: A${sumTargetRow}="合计", ${amountColumn.columnLetter}${sumTargetRow}="${sumFormula}"`
          );

          return {
            success: true,
            message: `在第${sumTargetRow}行添加求和公式 (${amountColumn.columnLetter}列)`
          };
        } catch (error) {
          console.error(`为工作表 ${worksheet.name} 添加求和功能失败:`, error);
          throw error;
        }
      }

      // 查找第一行中的金额列（查找名称为"总金额"的列）
      function findAmountColumnInFirstRow(worksheet) {
        try {
          const actualColumnCount = worksheet.actualColumnCount || 0;
          let amountColumn = null;

          console.log(
            `扫描第一行的 ${actualColumnCount} 列，查找"总金额"列...`
          );

          // 扫描第一行的所有列，查找"总金额"
          for (let col = 1; col <= actualColumnCount; col++) {
            const cell = worksheet.getCell(1, col);
            const cellValue = cell.value;

            // 跳过空值
            if (cellValue === null || cellValue === undefined) {
              continue;
            }

            // 转换为字符串进行比较
            const cellText = cellValue.toString().trim();

            console.log(
              `列 ${col} (${getColumnLetter(col)}): 值="${cellValue}"`
            );

            // 检查是否为"总金额"
            if (cellText === "总金额") {
              amountColumn = {
                columnNumber: col,
                columnLetter: getColumnLetter(col),
                firstRowValue: cellValue
              };
              console.log(
                `✅ 找到"总金额"列: ${getColumnLetter(col)} (第${col}列)`
              );
              break; // 找到后立即退出循环
            }
          }

          if (amountColumn) {
            console.log(
              `最终选择金额列: ${amountColumn.columnLetter} (第${amountColumn.columnNumber}列), 标题: "${amountColumn.firstRowValue}"`
            );
          } else {
            console.log('未找到"总金额"列');
          }

          return amountColumn;
        } catch (error) {
          console.error("查找金额列失败:", error);
          return null;
        }
      }

      // 将列号转换为Excel列字母（如1->A, 2->B, 26->Z, 27->AA）
      function getColumnLetter(columnNumber) {
        let result = "";
        while (columnNumber > 0) {
          columnNumber--; // 调整为0基索引
          result = String.fromCharCode(65 + (columnNumber % 26)) + result;
          columnNumber = Math.floor(columnNumber / 26);
        }
        return result;
      }

      // 应用工作表样式统一设置的函数（跳过第一个工作表）
      function applyWorksheetFormatting(workbook) {
        try {
          addLog(`🎨 开始应用工作表样式统一设置...`, "info");
          console.log("=== 应用工作表样式统一设置 ===");

          const worksheets = workbook.worksheets;
          const totalWorksheets = worksheets.length;
          let processedCount = 0;
          let successCount = 0;
          let failedCount = 0;

          console.log(`工作簿总共有 ${totalWorksheets} 个工作表`);

          // 遍历所有工作表，跳过第一个（索引0）
          worksheets.forEach((worksheet, index) => {
            if (index === 0) {
              console.log(
                `跳过第一个工作表: ${worksheet.name} (索引: ${index})`
              );
              addLog(`⏭️ 跳过第一个工作表: ${worksheet.name}`, "info");
              return;
            }

            try {
              console.log(
                `\n处理工作表 ${index + 1}: ${worksheet.name} (索引: ${index})`
              );
              addLog(`🔄 处理工作表: ${worksheet.name}`, "info");

              // 获取工作表的数据范围
              const actualRowCount = worksheet.actualRowCount || 1;
              const actualColumnCount = worksheet.actualColumnCount || 1;

              console.log(
                `工作表 ${worksheet.name} 数据范围: ${actualRowCount} 行 × ${actualColumnCount} 列`
              );

              // 设置样式参数
              const fontSize = 10; // 字体大小 10pt
              const rowHeight = 22; // 行高 22

              let cellCount = 0;

              // 遍历所有数据区域的单元格
              for (let row = 1; row <= actualRowCount; row++) {
                // 设置行高
                const worksheetRow = worksheet.getRow(row);
                worksheetRow.height = rowHeight;

                for (let col = 1; col <= actualColumnCount; col++) {
                  const cell = worksheet.getCell(row, col);

                  // 保留现有字体属性，只修改大小
                  if (!cell.font) cell.font = {};
                  const existingFont = { ...cell.font };
                  cell.font = {
                    ...existingFont,
                    size: fontSize
                  };

                  cellCount++;
                }
              }

              console.log(
                `工作表 ${worksheet.name} 样式设置完成: ${cellCount} 个单元格，行高: ${rowHeight}，字体大小: ${fontSize}pt`
              );
              addLog(
                `✅ 工作表 ${worksheet.name} 样式设置完成: ${cellCount} 个单元格`,
                "success"
              );

              processedCount++;
              successCount++;
            } catch (error) {
              console.log(`工作表 ${worksheet.name} 样式设置失败:`, error);
              addLog(
                `❌ 工作表 ${worksheet.name} 样式设置失败: ${error.message}`,
                "error"
              );

              processedCount++;
              failedCount++;
            }
          });

          // 输出最终统计信息
          console.log(`\n工作表样式统一设置完成:`);
          console.log(`- 总工作表数: ${totalWorksheets}`);
          console.log(`- 跳过工作表数: 1 (第一个工作表)`);
          console.log(`- 处理工作表数: ${processedCount}`);
          console.log(`- 成功设置数: ${successCount}`);
          console.log(`- 失败设置数: ${failedCount}`);

          addLog(
            `🎨 工作表样式统一设置完成: 处理 ${processedCount} 个工作表，成功 ${successCount} 个，失败 ${failedCount} 个`,
            successCount > 0 ? "success" : "warning"
          );
        } catch (error) {
          console.log(`应用工作表样式统一设置失败:`, error);
          addLog(`❌ 应用工作表样式统一设置失败: ${error.message}`, "error");
        }
      }

      // 处理"账单概览"工作表的特殊逻辑 - 自动删除符合条件的"合计"行
      async function processAccountSummarySheet(worksheet, workbook) {
        try {
          addLog(`📊 开始处理"账单概览"工作表的"合计"行删除逻辑`, "info");
          addLog(
            `📋 工作表范围: ${worksheet.actualRowCount} 行 × ${worksheet.actualColumnCount} 列`,
            "info"
          );

          if (!worksheet.actualRowCount || worksheet.actualRowCount === 0) {
            addLog(`⚠️ "账单概览"工作表为空，跳过处理`, "warning");
            return 0;
          }

          // 第一步：保存合并单元格信息
          const mergedCellsInfo = saveMergedCellsInfo(worksheet);

          // 存储需要删除的行号集合，避免重复
          const rowsToDeleteSet = new Set();
          const deleteInfoList = [];
          let totalFoundCount = 0;

          // 零值检测函数 - 支持多种零值格式
          const isZeroValue = value => {
            // null、undefined、空值
            if (value === null || value === undefined) return true;

            // 数字0
            if (value === 0) return true;

            // 字符串"0"
            if (value === "0") return true;

            // 接近0的浮点数
            if (typeof value === "number" && Math.abs(value) < 0.001)
              return true;

            // 字符串格式的零值
            if (typeof value === "string") {
              const trimmed = value.trim();
              if (trimmed === "") return true; // 空字符串
              if (trimmed === "0.0" || trimmed === "0.00") return true;

              // 尝试解析为数字
              const parsed = parseFloat(trimmed);
              if (!isNaN(parsed) && Math.abs(parsed) < 0.001) return true;
            }

            return false;
          };

          // 遍历所有行和列，查找包含"合计"的单元格
          for (let row = 1; row <= worksheet.actualRowCount; row++) {
            for (let col = 1; col <= worksheet.actualColumnCount; col++) {
              const cell = worksheet.getCell(row, col);
              const cellValue = cell.value;

              // 检查单元格是否包含"合计"文本（支持字符串和数字转字符串）
              const cellText = cellValue ? cellValue.toString() : "";
              if (cellText.includes("合计")) {
                totalFoundCount++;
                addLog(
                  `🔍 发现"合计"单元格 ${
                    cell.address
                  }: "${cellValue}" (类型: ${typeof cellValue})`,
                  "info"
                );

                // 检查下方相邻单元格（同列，下一行）
                if (row + 1 <= worksheet.actualRowCount) {
                  const nextRowCell = worksheet.getCell(row + 1, col);
                  const nextRowValue = nextRowCell.value;

                  addLog(
                    `📋 检查下方单元格 ${
                      nextRowCell.address
                    }: ${nextRowValue} (类型: ${typeof nextRowValue})`,
                    "info"
                  );

                  const isZero = isZeroValue(nextRowValue);
                  addLog(
                    `🔍 零值判定: ${nextRowCell.address} = ${nextRowValue} → ${
                      isZero ? "是零值" : "非零值"
                    }`,
                    isZero ? "warning" : "info"
                  );

                  if (isZero) {
                    addLog(
                      `❌ 标记删除区域: 合计单元格 ${cell.address}="${cellValue}", 零值单元格 ${nextRowCell.address}="${nextRowValue}"`,
                      "warning"
                    );

                    // 计算需要删除的3行：上一行、合计行、下一行
                    const deleteStartRow = Math.max(1, row - 1); // 上一行（确保不小于1）
                    const deleteEndRow = Math.min(
                      row + 1,
                      worksheet.actualRowCount
                    ); // 下一行（确保不超过最大行数）

                    // 检查是否已经标记过这些行
                    let alreadyMarked = false;
                    for (let r = deleteStartRow; r <= deleteEndRow; r++) {
                      if (rowsToDeleteSet.has(r)) {
                        alreadyMarked = true;
                        break;
                      }
                    }

                    if (!alreadyMarked) {
                      // 标记这些行为待删除
                      for (let r = deleteStartRow; r <= deleteEndRow; r++) {
                        rowsToDeleteSet.add(r);
                      }

                      deleteInfoList.push({
                        startRow: deleteStartRow,
                        endRow: deleteEndRow,
                        totalCell: cell.address,
                        zeroCell: nextRowCell.address,
                        totalValue: cellValue,
                        zeroValue: nextRowValue
                      });

                      addLog(
                        `📝 标记删除行范围: 第${deleteStartRow}-${deleteEndRow}行 (共${
                          deleteEndRow - deleteStartRow + 1
                        }行)`,
                        "info"
                      );
                    } else {
                      addLog(
                        `⚠️ 行范围 第${deleteStartRow}-${deleteEndRow}行 已被标记，跳过重复标记`,
                        "warning"
                      );
                    }
                  } else {
                    addLog(
                      `✅ 保留"合计"行: ${cell.address} (下方值非零: ${nextRowValue})`,
                      "info"
                    );
                  }
                } else {
                  addLog(
                    `⚠️ "合计"单元格 ${cell.address} 已在最后一行，无法检查下方单元格`,
                    "warning"
                  );
                }
              }
            }
          }

          // 处理结果统计
          addLog(
            `📊 扫描完成: 共发现 ${totalFoundCount} 个"合计"单元格，其中 ${deleteInfoList.length} 个符合删除条件`,
            "info"
          );

          if (deleteInfoList.length === 0) {
            addLog(`✅ 未发现需要删除的"合计"行`, "success");
            return 0; // 返回删除的行数
          }

          // 按起始行号从大到小排序，确保从下往上删除（避免行号变化影响）
          deleteInfoList.sort((a, b) => b.startRow - a.startRow);

          addLog(
            `🗑️ 开始执行删除操作 (从下往上删除 ${deleteInfoList.length} 个区域)`,
            "warning"
          );

          // 执行删除操作
          let totalDeletedRows = 0;
          const deletedRowRanges = []; // 记录删除的行范围，用于合并单元格位置计算

          for (let i = 0; i < deleteInfoList.length; i++) {
            const deleteInfo = deleteInfoList[i];
            const {
              startRow,
              endRow,
              totalCell,
              zeroCell,
              totalValue,
              zeroValue
            } = deleteInfo;
            const rowCount = endRow - startRow + 1;

            addLog(
              `🗑️ [${i + 1}/${
                deleteInfoList.length
              }] 删除第${startRow}-${endRow}行 (共${rowCount}行)`,
              "warning"
            );
            addLog(
              `   └─ 合计单元格: ${totalCell}="${totalValue}", 零值单元格: ${zeroCell}="${zeroValue}"`,
              "info"
            );

            try {
              // 记录删除的行范围
              deletedRowRanges.push({
                startRow: startRow,
                endRow: endRow
              });

              // 使用ExcelJS的spliceRows方法删除行
              // spliceRows(startRow, deleteCount, ...insertRows)
              worksheet.spliceRows(startRow, rowCount);
              totalDeletedRows += rowCount;

              addLog(`   ✅ 成功删除第${startRow}-${endRow}行`, "success");
            } catch (deleteError) {
              addLog(
                `   ❌ 删除第${startRow}-${endRow}行失败: ${deleteError.message}`,
                "error"
              );
              throw deleteError;
            }
          }

          // 第三步：恢复合并单元格
          if (totalDeletedRows > 0 && mergedCellsInfo.length > 0) {
            addLog(
              `🔗 开始恢复合并单元格 (删除了${totalDeletedRows}行)...`,
              "info"
            );
            restoreMergedCells(
              worksheet,
              mergedCellsInfo,
              deletedRowRanges,
              workbook
            );
          } else if (mergedCellsInfo.length === 0) {
            addLog(`ℹ️ 工作表中没有合并单元格，跳过恢复步骤`, "info");
          }

          addLog(
            `✅ "账单概览"工作表处理完成！共删除 ${totalDeletedRows} 行，剩余 ${worksheet.actualRowCount} 行`,
            "success"
          );

          return totalDeletedRows; // 返回删除的行数
        } catch (error) {
          addLog(
            `❌ 处理"账单概览"工作表时发生错误: ${error.message}`,
            "error"
          );
          console.error("processAccountSummarySheet错误详情:", error);
          throw error;
        }
      }

      function cleanCustomerName(name) {
        if (!name || typeof name !== "string") {
          return "";
        }

        // 去除首尾空白
        let cleanedName = name.trim();

        // 去除各种前缀（按优先级顺序处理）
        const prefixesToRemove = [
          // VIP特易行相关前缀
          "VIP特易行",
          "vip特易行",
          "Vip特易行",
          "VIP 特易行",
          "vip 特易行",
          "Vip 特易行",
          // 成都特易行前缀
          "成都特易行",
          "成都 特易行",
          // 差旅管家-VIP前缀
          "差旅管家-VIP",
          "差旅管家-vip",
          "差旅管家-Vip",
          "差旅管家 -VIP",
          "差旅管家 -vip",
          "差旅管家 - VIP",
          "差旅管家 - vip",
          "差旅管家VIP",
          "差旅管家vip",
          "差旅管家 VIP",
          "差旅管家 vip"
        ];

        for (const prefix of prefixesToRemove) {
          if (cleanedName.startsWith(prefix)) {
            cleanedName = cleanedName.substring(prefix.length).trim();
            break;
          }
        }

        // 去除其他可能的前缀（可以根据需要扩展）
        const otherPrefixes = [
          "特易行",
          "特易行 ",
          "差旅管家-",
          "差旅管家 -",
          "差旅管家 - ",
          "差旅管家",
          "差旅管家 ",
          "VIP",
          "VIP ",
          "vip",
          "vip "
        ];

        for (const prefix of otherPrefixes) {
          if (cleanedName.startsWith(prefix)) {
            cleanedName = cleanedName.substring(prefix.length).trim();
            break;
          }
        }

        // 确保清理后的名称不为空
        return cleanedName || name.trim();
      }

      async function processExcelData(data) {
        if (!data || data.length === 0) {
          addLog("Excel文件为空", "error");
          return;
        }

        let newCustomers = [];
        let duplicateCount = 0;

        // 从第二行开始读取数据（假设第一行是标题）
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (row && row[0]) {
            // 假设客户名称在第一列
            let customerName = String(row[0]).trim();

            // 处理客户名称：去除"VIP特易行"前缀
            const originalName = customerName;
            customerName = cleanCustomerName(customerName);

            if (customerName) {
              // 如果名称被修改了，记录日志
              if (originalName !== customerName) {
                addLog(
                  `名称处理: "${originalName}" → "${customerName}"`,
                  "info"
                );
              }

              // 检查是否已存在
              if (
                customerConfig &&
                customerConfig.hasOwnProperty(customerName)
              ) {
                duplicateCount++;
              } else {
                newCustomers.push(customerName);
              }
            }
          }
        }

        if (newCustomers.length === 0) {
          addLog(`没有发现新客户，重复客户: ${duplicateCount}个`, "info");
          return;
        }

        // 显示预览并询问用户是否确认导入
        const confirmMessage = `
            准备导入 ${
              newCustomers.length
            } 个新客户，重复客户: ${duplicateCount}个

            新增客户列表：
            ${newCustomers.slice(0, 10).join("\n")}${
              newCustomers.length > 10
                ? "\n...(还有" + (newCustomers.length - 10) + "个)"
                : ""
            }

            是否确认导入？`;

        if (confirm(confirmMessage)) {
          // 增量添加到配置中
          if (!customerConfig) {
            customerConfig = {};
          }

          newCustomers.forEach(customerName => {
            customerConfig[customerName] = "";
          });

          addLog(
            `✓ 成功导入 ${newCustomers.length} 个新客户，重复客户: ${duplicateCount}个`,
            "success"
          );
          addLog(
            `新增客户: ${newCustomers.slice(0, 5).join(", ")}${
              newCustomers.length > 5 ? "..." : ""
            }`,
            "info"
          );

          // 配置已在内存中更新，保存到本地并刷新显示
          addLog("✓ 配置已更新完成，立即生效！", "success");

          // 保存到本地JSON文件
          saveConfigToLocal();

          displayCustomerList();
        } else {
          addLog("用户取消导入操作", "info");
        }
      }

      function exportCurrentConfig() {
        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          alert("没有可导出的配置数据");
          return;
        }

        const configJson = JSON.stringify(customerConfig, null, 2);
        const blob = new Blob([configJson], { type: "application/json" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `download_config_${new Date()
          .toISOString()
          .slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        addLog("✓ 当前配置已导出", "success");
      }

      function downloadTemplate() {
        // 创建Excel模板数据
        const templateData = [
          ["客户名称"], // 标题行
          ["广东金丽声展示设备有限公司"],
          ["VIP特易行深圳市海柔创新科技有限公司"], // 示例：VIP特易行前缀
          ["成都特易行深圳市优必选科技有限公司"], // 示例：成都特易行前缀
          ["差旅管家-VIP深圳市昊一源科技有限公司"], // 示例：差旅管家-VIP前缀
          ["厦门亿联网络技术股份有限公司"],
          ["VIP 特易行深圳市长帆供应链有限公司"], // 示例：带空格的前缀
          ["差旅管家 -VIP广东东方精工科技股份有限公司"] // 示例：差旅管家带空格前缀
        ];

        // 创建工作簿和工作表
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(templateData);

        // 设置列宽
        ws["!cols"] = [{ width: 40 }];

        // 添加工作表到工作簿
        XLSX.utils.book_append_sheet(wb, ws, "客户列表");

        // 生成Excel文件并下载
        XLSX.writeFile(wb, "客户列表模板.xlsx");

        addLog("✓ Excel模板已下载", "success");
      }

      async function queryAllCustomerBills(event = null) {
        // 防止任何默认行为
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        const token = document.getElementById("token").value.trim();

        if (!token) {
          alert("请输入Token");
          return;
        }

        // 检查是否正在查询
        if (isQuerying) {
          alert("正在查询中，请稍后再试");
          return;
        }

        // 如果配置为空，先尝试加载本地配置
        if (!customerConfig || Object.keys(customerConfig).length === 0) {
          addLog("正在加载本地配置...", "info");
          await loadLocalConfig();

          // 加载后再次检查
          if (!customerConfig || Object.keys(customerConfig).length === 0) {
            alert("无法加载客户配置，请检查 download_config.json 文件是否存在");
            return;
          }
        }

        // 设置查询状态
        isQuerying = true;
        shouldStopQuery = false;

        const queryBtn = document.getElementById("queryBtn");
        const stopBtn = document.getElementById("stopBtn");

        queryBtn.disabled = true;
        queryBtn.textContent = "查询中...";
        stopBtn.style.display = "inline-block";

        const resultsDiv = document.getElementById("customerResults");
        const tableDiv = document.getElementById("customerBillsTable");
        const resultsTitle = document.getElementById("resultsTitle");

        try {
          resultsDiv.style.display = "block";
          resultsTitle.textContent = "查询进行中...";

          // 初始化表格，显示所有客户的查询状态
          initializeQueryTable();

          let allResults = [];
          let completedCount = 0;
          let noDataCount = 0; // 未查到账单的客户数量
          let failedCount = 0; // 查询失败的客户数量
          const totalCount = Object.keys(customerConfig).length;

          for (const customerName of Object.keys(customerConfig)) {
            // 检查是否需要停止查询
            if (shouldStopQuery) {
              addLog("查询已被用户停止", "info");
              break;
            }

            try {
              addLog(`正在查询客户: ${customerName}`, "info");

              // 更新该客户的状态为"查询中"
              updateCustomerStatus(customerName, "查询中", "info");

              const response = await fetch(
                "https://staff-api-gateway.teyixing.com/admin/v1/finance/getCreditBills",
                {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                    Accept: "application/json, text/plain, */*"
                  },
                  body: JSON.stringify({
                    corpNameLike: customerName,
                    status: null,
                    overdue: null,
                    pageNumber: 1,
                    pageSize: 10
                  })
                }
              );

              // 检查401错误（Token过期）

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              const data = await response.json();
              if (data.code === 401) {
                addLog("Token已过期，停止查询", "error");
                alert(
                  "Token已过期，请重新登录！\n\n查询已停止，请点击'一键登录'重新获取Token。"
                );
                clearTokenAndLogin();
                shouldStopQuery = true;
                break;
              }
              if (
                data.data &&
                data.data.content &&
                data.data.content.length > 0
              ) {
                // 只取第一条记录
                const firstRecord = data.data.content[0];
                const result = {
                  customerName: customerName,
                  ...firstRecord
                };
                allResults.push(result);

                // 更新该客户的账单信息
                updateCustomerBillInfo(customerName, result);
                addLog(`✓ 查询成功: ${customerName}`, "success");
              } else {
                // 更新该客户的状态为"未查到账单"
                updateCustomerStatus(customerName, "未查到账单", "warning");
                // 为未查到账单的客户添加操作按钮
                addActionButtonsForCustomer(customerName);
                addLog(`⚠ 未找到数据: ${customerName}`, "info");
                noDataCount++; // 统计未查到账单的客户
              }

              // 添加延迟避免请求过于频繁
              await new Promise(resolve => setTimeout(resolve, 500));
            } catch (error) {
              // 更新该客户的状态为"查询失败"
              updateCustomerStatus(customerName, "查询失败", "error");
              // 为查询失败的客户添加操作按钮
              addActionButtonsForCustomer(customerName);
              addLog(`✗ 查询失败: ${customerName} - ${error.message}`, "error");
              failedCount++; // 统计查询失败的客户
            }

            completedCount++;
            // 更新总体进度
            resultsTitle.textContent = `查询进度: ${completedCount}/${totalCount} (已完成${Math.round(
              (completedCount / totalCount) * 100
            )}%)`;
          }

          // 查询完成，重置状态
          isQuerying = false;
          shouldStopQuery = false;

          queryBtn.disabled = false;
          queryBtn.textContent = "查询全部账单";
          stopBtn.style.display = "none";

          // 更新标题和保存结果
          queryResults = allResults;

          // 统计能下载的客户数量（debtAmount > 0）
          const downloadableCount = allResults.filter(record => {
            const debtAmount = parseFloat(record.debtAmount) || 0;
            return debtAmount > 0;
          }).length;

          if (shouldStopQuery) {
            resultsTitle.innerHTML = `查询已停止 (已查到${allResults.length}条账单，未查到${noDataCount}条，失败${failedCount}条，可下载${downloadableCount}条 )`;
          } else {
            resultsTitle.innerHTML = `查询完成 (共查到${allResults.length}条账单，未查到${noDataCount}条，失败${failedCount}条，可下载${downloadableCount}条 )`;
          }

          // 显示批量下载按钮
          const batchDownloadBtn = document.getElementById("batchDownloadBtn");
          if (allResults.length > 0) {
            batchDownloadBtn.style.display = "inline-block";
          }

          addLog(
            `查询${shouldStopQuery ? "停止" : "完成"}，共查到 ${
              allResults.length
            } 条账单，未查到 ${noDataCount} 条，失败 ${failedCount} 条，可下载 ${downloadableCount} 条`,
            shouldStopQuery ? "info" : "success"
          );
        } catch (error) {
          // 发生未预期的错误，重置状态
          isQuerying = false;
          shouldStopQuery = false;

          queryBtn.disabled = false;
          queryBtn.textContent = "查询全部账单";
          stopBtn.style.display = "none";

          addLog(`查询过程发生错误: ${error.message}`, "error");
        }
      }

      function displayResults(results) {
        const tableDiv = document.getElementById("customerBillsTable");
        const resultsTitle = document.getElementById("resultsTitle");

        // 保存查询结果用于批量下载
        queryResults = results;

        // 更新标题
        resultsTitle.textContent = `查询结果 (共${results.length}条):`;

        if (results.length === 0) {
          tableDiv.innerHTML = "<p>未查询到任何数据</p>";
          return;
        }

        let tableHTML = `
                      <table class="customer-table">
                        <thead>
                          <tr>
                            <th>客户名称</th>
                            <th>账单编号</th>
                            <th>出账日</th>
                            <th>账单起始日</th>
                            <th>账单截止日</th>
                            <th>最迟还款日</th>
                            <th>账单金额</th>
                            <th>已还金额</th>
                            <th>待还金额</th>
                            <th>还款日期</th>
                            <th>状态</th>
                            <th>操作</th>
                          </tr>
                        </thead>
                        <tbody>
                    `;

        results.forEach(record => {
          tableHTML += `
                        <tr>
                          <td>${record.customerName}</td>
                          <td>${record.billNo || ""}</td>
                          <td>${record.billDate || ""}</td>
                          <td>${record.billStartDate || ""}</td>
                          <td>${record.billEndDate || ""}</td>
                          <td>${record.latestRepayDate || ""}</td>
                          <td>¥${record.billAmount || 0}</td>
                          <td>¥${record.paidAmount || 0}</td>
                          <td>¥${record.debtAmount || 0}</td>
                          <td>${record.repayDate || ""}</td>
                          <td>${record.status || ""}</td>
                          <td><button onclick="downloadBill('${
                            record.billId
                          }')" style="font-size: 12px; padding: 2px 8px;">下载</button></td>
                        </tr>
                      `;
        });

        tableHTML += "</tbody></table>";
        tableDiv.innerHTML = tableHTML;

        // 显示批量下载按钮
        const batchDownloadBtn = document.getElementById("batchDownloadBtn");
        if (results.length > 0) {
          batchDownloadBtn.style.display = "inline-block";
        }

        addLog(`查询完成，共找到 ${results.length} 条记录`, "success");
      }

      async function downloadBill(
        billId,
        customerName,
        billNo,
        debtAmount,
        billStartDate,
        billEndDate
      ) {
        const token = document.getElementById("token").value.trim();

        try {
          // 检查待还金额
          const debt = parseFloat(debtAmount) || 0;
          if (debt <= 0) {
            alert(`客户 ${customerName} 的待还金额为 ¥${debt}，无需下载账单`);
            addLog(`跳过下载: ${customerName} - 待还金额为 ¥${debt}`, "info");
            return;
          }

          addLog(`开始下载账单: ${customerName} (待还金额: ¥${debt})`, "info");

          const removeZeroRecords =
            document.getElementById("removeZeroRecords").checked;

          const response = await fetch(
            `https://staff-api-gateway.teyixing.com/admin/v1/finance/downloadCorpBill?billId=${billId}&removeZeroRecords=${removeZeroRecords}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
                Accept: "application/json, text/plain, */*"
              },
              body: "{}"
            }
          );

          // 检查401错误（Token过期）
          if (response.status === 401) {
            addLog("Token已过期，下载失败", "error");
            alert(
              "Token已过期，请重新登录！\n\n请点击'一键登录'重新获取Token后再试。"
            );
            clearTokenAndLogin();
            return;
          }

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;

          // 生成文件名：使用表格中显示的文件名格式
          const fileName =
            generateFileName(customerName, billStartDate, billEndDate) +
            ".xlsx";

          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog(`✓ 成功下载账单: ${customerName}`, "success");
        } catch (error) {
          addLog(`✗ 下载失败: ${customerName} - ${error.message}`, "error");
        }
      }

      async function batchDownloadFromTable(event = null) {
        // 防止任何默认行为
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        if (isDownloading) {
          showToast(`正在下载中，请等待完成`, "error");
          return;
        }

        if (!queryResults || queryResults.length === 0) {
          showToast(`没有可下载的账单数据`, "error");
          return;
        }

        // 过滤出debtAmount大于0的客户
        const filteredResults = queryResults.filter(record => {
          const debtAmount = parseFloat(record.debtAmount) || 0;
          return debtAmount > 0;
        });

        if (filteredResults.length === 0) {
          showToast(`没有待还金额大于0的客户需要下载`, "error");
          return;
        }

        addLog(
          `共${queryResults.length}条查询结果，其中${filteredResults.length}条有待还金额需要下载`,
          "info"
        );

        const token = document.getElementById("token").value.trim();
        if (!token) {
          alert("请输入Token");
          return;
        }

        isDownloading = true;
        shouldStopDownload = false; // 重置停止标志
        document.getElementById("progressDialog").style.display = "flex";

        addLog(`开始批量下载，共 ${filteredResults.length} 个账单`, "info");
        addLog("正在打包文件，请稍候...", "info");
        updateProgress(0, filteredResults.length);

        const zip = new JSZip();
        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < filteredResults.length; i++) {
          // 检查是否需要停止下载
          if (shouldStopDownload) {
            addLog("下载已被用户取消", "info");
            break;
          }

          const record = filteredResults[i];
          try {
            addLog(
              `正在下载: ${record.customerName} - ${
                record.billNo || record.id
              }`,
              "info"
            );

            // 创建新的AbortController用于取消请求
            downloadAbortController = new AbortController();

            const removeZeroRecords =
              document.getElementById("removeZeroRecords").checked;

            const response = await fetch(
              `https://staff-api-gateway.teyixing.com/admin/v1/finance/downloadCorpBill?billId=${record.billId}&removeZeroRecords=${removeZeroRecords}`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                  Accept: "application/json, text/plain, */*"
                },
                body: "{}",
                signal: downloadAbortController.signal // 添加取消信号
              }
            );

            // 检查401错误（Token过期）
            if (response.status === 401) {
              addLog("Token已过期，批量下载停止", "error");
              alert(
                "Token已过期，请重新登录！\n\n批量下载已停止，请点击'一键登录'重新获取Token后再试。"
              );
              clearTokenAndLogin();
              isDownloading = false;
              shouldStopDownload = false;
              downloadAbortController = null;
              document.getElementById("progressDialog").style.display = "none";
              return;
            }

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const blob = await response.blob();
            // 生成文件名：使用表格中显示的文件名格式
            const fileName =
              generateFileName(
                record.customerName,
                record.billStartDate,
                record.billEndDate
              ) + ".xlsx";

            // 添加文件到ZIP包
            zip.file(fileName, blob);

            addLog(`✓ 成功获取: ${record.customerName}`, "success");
            successCount++;
          } catch (error) {
            if (error.name === "AbortError") {
              addLog(`下载被取消: ${record.customerName}`, "info");
              break; // 跳出循环，停止后续下载
            } else {
              addLog(
                `✗ 下载失败: ${record.customerName} - ${error.message}`,
                "error"
              );
              failCount++;
            }
          }

          updateProgress(i + 1, filteredResults.length);

          // 添加延迟避免请求过于频繁
          if (i < filteredResults.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }

        if (successCount > 0) {
          addLog("正在生成ZIP文件...", "info");

          // 生成ZIP文件
          const zipBlob = await zip.generateAsync({ type: "blob" });

          // 创建下载链接
          const url = window.URL.createObjectURL(zipBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `客户账单_${new Date().toISOString().slice(0, 10)}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog("✓ ZIP文件已生成并开始下载", "success");
        }

        addLog(
          `批量下载完成！成功: ${successCount}, 失败: ${failCount}`,
          successCount > 0 ? "success" : "info"
        );

        // 重置下载控制状态
        shouldStopDownload = false;
        downloadAbortController = null;
        isDownloading = false;
      }

      async function batchDownloadChalvguanjiaFromTable(event = null) {
        // 防止任何默认行为
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        if (isDownloading) {
          showToast(`正在下载中，请等待完成`, "error");
          return;
        }

        if (!queryResults || queryResults.length === 0) {
          showToast(`没有可下载的账单数据`, "error");
          return;
        }

        // 过滤出差旅管家且debtAmount大于0的客户
        const filteredResults = queryResults.filter(record => {
          const debtAmount = parseFloat(record.debtAmount) || 0;
          // 从customerConfig中获取系统名称
          const customerData = customerConfig[record.customerName];
          const systemName =
            customerData && customerData.system
              ? customerData.system
              : "特易行";
          return debtAmount > 0 && systemName.includes("差旅管家");
        });

        if (filteredResults.length === 0) {
          showToast(`没有差旅管家客户的待还金额大于0的账单需要下载`, "error");
          return;
        }

        addLog(
          `共${queryResults.length}条查询结果，其中${filteredResults.length}条差旅管家客户有待还金额需要下载`,
          "info"
        );

        const token = document.getElementById("token").value.trim();
        if (!token) {
          alert("请输入Token");
          return;
        }

        isDownloading = true;
        shouldStopDownload = false; // 重置停止标志
        document.getElementById("progressDialog").style.display = "flex";

        addLog(
          `开始批量下载差旅管家账单，共 ${filteredResults.length} 个账单`,
          "info"
        );
        addLog("正在打包文件，请稍候...", "info");
        updateProgress(0, filteredResults.length);

        const zip = new JSZip();
        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < filteredResults.length; i++) {
          // 检查是否需要停止下载
          if (shouldStopDownload) {
            addLog("下载已被用户取消", "info");
            break;
          }

          const record = filteredResults[i];
          try {
            addLog(
              `正在下载差旅管家账单: ${record.customerName} - ${
                record.billNo || record.id
              }`,
              "info"
            );

            // 创建新的AbortController用于取消请求
            downloadAbortController = new AbortController();

            const response = await fetch(
              `https://staff-api-gateway.teyixing.com/admin/v1/finance/downloadCorpBill?billId=${record.billId}`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                  Accept: "application/json, text/plain, */*"
                },
                body: "{}",
                signal: downloadAbortController.signal // 添加取消信号
              }
            );

            // 检查401错误（Token过期）
            if (response.status === 401) {
              addLog("Token已过期，批量下载停止", "error");
              alert(
                "Token已过期，请重新登录！\n\n批量下载已停止，请点击'一键登录'重新获取Token后再试。"
              );
              clearTokenAndLogin();
              isDownloading = false;
              shouldStopDownload = false;
              downloadAbortController = null;
              document.getElementById("progressDialog").style.display = "none";
              return;
            }

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const blob = await response.blob();
            // 生成文件名：使用表格中显示的文件名格式，并添加差旅管家标识
            const fileName =
              generateFileName(
                record.customerName,
                record.billStartDate,
                record.billEndDate
              ) + ".xlsx";

            // 添加文件到ZIP包
            zip.file(fileName, blob);

            addLog(`✓ 成功获取差旅管家账单: ${record.customerName}`, "success");
            successCount++;
          } catch (error) {
            if (error.name === "AbortError") {
              addLog(`下载被取消: ${record.customerName}`, "info");
              break; // 跳出循环，停止后续下载
            } else {
              addLog(
                `✗ 下载失败: ${record.customerName} - ${error.message}`,
                "error"
              );
              failCount++;
            }
          }

          updateProgress(i + 1, filteredResults.length);

          // 添加延迟避免请求过于频繁
          if (i < filteredResults.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }

        if (successCount > 0) {
          addLog("正在生成差旅管家账单ZIP文件...", "info");

          // 生成ZIP文件
          const zipBlob = await zip.generateAsync({ type: "blob" });

          // 创建下载链接
          const url = window.URL.createObjectURL(zipBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `差旅管家账单_${new Date().toISOString().slice(0, 10)}.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog("✓ 差旅管家账单ZIP文件已生成并开始下载", "success");
        }

        addLog(
          `差旅管家账单批量下载完成！成功: ${successCount}, 失败: ${failCount}`,
          successCount > 0 ? "success" : "info"
        );

        // 重置下载控制状态
        shouldStopDownload = false;
        downloadAbortController = null;
        isDownloading = false;
      }

      function toggleProxyOption() {
        const useProxy = document.getElementById("useProxy").checked;
        if (useProxy) {
          addLog("已启用CORS代理模式", "info");
        }
      }

      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContent");
        const logItem = document.createElement("div");
        logItem.className = `log-item log-${type}`;
        logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(logItem);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function updateProgress(current, total) {
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        const progressDetails = document.getElementById("progressDetails");
        const percentage = Math.round((current / total) * 100);

        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;
        progressDetails.textContent = `正在下载: ${current}/${total} 个文件`;

        // 下载完成时隐藏dialog
        if (current >= total) {
          setTimeout(() => {
            document.getElementById("progressDialog").style.display = "none";
            isDownloading = false;
          }, 1500); // 1.5秒后自动关闭
        }
      }

      function cancelDownload() {
        if (confirm("确定要取消下载吗？")) {
          // 设置停止标志
          shouldStopDownload = true;

          // 取消当前的网络请求
          if (downloadAbortController) {
            downloadAbortController.abort();
            downloadAbortController = null;
          }

          // 隐藏进度对话框
          document.getElementById("progressDialog").style.display = "none";

          // 重置状态
          isDownloading = false;

          addLog("用户取消下载，正在停止所有下载请求...", "info");
          showToast("下载已取消", "info");
        }
      }

      async function downloadFile(billId, token, index, total) {
        try {
          addLog(`开始下载 ID: ${billId}`, "info");

          const useProxy = document.getElementById("useProxy").checked;
          const removeZeroRecords =
            document.getElementById("removeZeroRecords").checked;
          let apiUrl = `https://staff-api-gateway.teyixing.com/admin/v1/finance/downloadCorpBill?billId=${billId}&removeZeroRecords=${removeZeroRecords}`;

          // 如果使用代理，添加代理前缀
          if (useProxy) {
            apiUrl = `https://cors-anywhere.herokuapp.com/${apiUrl}`;
          }

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
              Accept: "application/json, text/plain, */*",
              ...(useProxy && { "X-Requested-With": "XMLHttpRequest" })
            },
            body: "{}",
            mode: "cors"
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `bill_${billId}.xlsx`; // 修改为xlsx文件
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          addLog(`✓ 成功下载 ID: ${billId}`, "success");
          updateProgress(index + 1, total);

          return true;
        } catch (error) {
          addLog(`✗ 下载失败 ID: ${billId} - ${error.message}`, "error");
          updateProgress(index + 1, total);
          return false;
        }
      }

      // 添加样式设置表单的事件监听器
      function addStyleSettingsEventListeners() {
        const formElements = [
          "fontSize",
          "fontFamily",
          "fontColor",
          "rowHeight",
          "columnWidth",
          "horizontalAlign",
          "verticalAlign",
          "addBorders",
          "borderStyle",
          "borderColor"
        ];

        formElements.forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("change", updateStylePreview);
            element.addEventListener("input", updateStylePreview);
          }
        });
      }

      // 页面加载完成后自动加载本地配置
      window.addEventListener("DOMContentLoaded", function () {
        addLog("页面加载完成，正在自动加载本地配置...", "info");

        // 先尝试加载本地配置
        loadLocalConfig().catch(error => {
          addLog(`自动加载配置失败: ${error.message}`, "error");
          // 如果自动加载失败，显示手动加载提示
          const resultsDiv = document.getElementById("customerResults");
          const tableDiv = document.getElementById("customerBillsTable");
          resultsDiv.style.display = "block";
          tableDiv.innerHTML = `
                  <div style="text-align: center; padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; margin: 10px 0;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">⚠️ 无法自动加载客户配置</h4>
                    <p style="color: #856404; margin: 0 0 15px 0;">请点击下方按钮手动加载客户列表</p>
                    <button onclick="loadLocalConfig(true)" style="background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                      手动加载客户列表
                    </button>
                  </div>
                `;
        });

        // 加载Excel样式设置
        loadStyleSettingsFromStorage();

        // 添加样式设置表单的事件监听器
        addStyleSettingsEventListeners();

        // 恢复表格折叠状态
        restoreTableCollapseState();

        // 检查是否有保存的token
        const savedToken = localStorage.getItem("userToken");
        const savedUser = localStorage.getItem("userInfo");

        if (savedToken && savedUser) {
          try {
            currentUser = JSON.parse(savedUser);
            document.getElementById("token").value = savedToken;

            const loginBtn = document.getElementById("loginBtn");
            const loginStatus = document.getElementById("loginStatus");

            loginBtn.textContent = "重新登录";
            loginBtn.style.backgroundColor = "#28a745";
            loginBtn.disabled = false;
            loginStatus.textContent = `欢迎回来，${currentUser.staff.name}`;
            loginStatus.style.color = "#28a745";

            addLog(`✓ 自动恢复登录状态: ${currentUser.staff.name}`, "success");

            // 显示自动恢复登录的toast提示
            showToast(`欢迎回来，${currentUser.staff.name}`, "info", 2000);
          } catch (error) {
            // 清除无效的保存数据
            localStorage.removeItem("userToken");
            localStorage.removeItem("userInfo");
          }
        }
      });

      // 添加键盘快捷键支持
      document.addEventListener("keydown", function (event) {
        // Ctrl+F 聚焦到筛选框
        if (event.ctrlKey && event.key === "f") {
          event.preventDefault();
          const filterInput = document.getElementById("customerFilter");
          const filterSection = document.getElementById(
            "customerFilterSection"
          );

          if (filterSection && filterSection.style.display !== "none") {
            filterInput.focus();
            filterInput.select();
          }
        }

        // ESC 清除筛选
        if (event.key === "Escape") {
          const filterInput = document.getElementById("customerFilter");
          if (filterInput && document.activeElement === filterInput) {
            clearFilter();
            filterInput.blur();
          }
        }
      });
    </script>
  </body>
</html>
